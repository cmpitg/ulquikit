<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="Asciidoctor 0.1.4">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ulquikit - How it works</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }
audio, canvas, video { display: inline-block; }
audio:not([controls]) { display: none; height: 0; }
[hidden] { display: none; }
html { background: #fff; color: #000; font-family: sans-serif; -ms-text-size-adjust: 100%; -webkit-text-size-adjust: 100%; }
body { margin: 0; }
a:focus { outline: thin dotted; }
a:active, a:hover { outline: 0; }
h1 { font-size: 2em; margin: 0.67em 0; }
abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
dfn { font-style: italic; }
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }
mark { background: #ff0; color: #000; }
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }
pre { white-space: pre-wrap; }
q { quotes: "\201C" "\201D" "\2018" "\2019"; }
small { font-size: 80%; }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
img { border: 0; }
svg:not(:root) { overflow: hidden; }
figure { margin: 0; }
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }
legend { border: 0; padding: 0; }
button, input, select, textarea { font-family: inherit; font-size: 100%; margin: 0; }
button, input { line-height: normal; }
button, select { text-transform: none; }
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; cursor: pointer; }
button[disabled], html input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; }
input[type="search"] { -webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box; }
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; }
table { border-collapse: collapse; border-spacing: 0; }
*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
html, body { font-size: 100%; }
body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }
a:hover { cursor: pointer; }
a:focus { outline: none; }
img, object, embed { max-width: 100%; height: auto; }
object, embed { height: 100%; }
img { -ms-interpolation-mode: bicubic; }
#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }
.left { float: left !important; }
.right { float: right !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-center { text-align: center !important; }
.text-justify { text-align: justify !important; }
.hide { display: none; }
.antialiased, body { -webkit-font-smoothing: antialiased; }
img { display: inline-block; vertical-align: middle; }
textarea { height: auto; min-height: 50px; }
select { width: 100%; }
p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }
.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #7a2518; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }
a { color: #005498; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #00467f; }
a img { border: none; }
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Georgia, "URW Bookman L", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }
h1 { font-size: 2.125em; }
h2 { font-size: 1.6875em; }
h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
h4 { font-size: 1.125em; }
h5 { font-size: 1.125em; }
h6 { font-size: 1em; }
hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }
em, i { font-style: italic; line-height: inherit; }
strong, b { font-weight: bold; line-height: inherit; }
small { font-size: 60%; line-height: inherit; }
code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; color: #6d180b; }
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }
ul, ol { margin-left: 1.5em; }
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }
abbr { text-transform: none; }
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: inherit; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }
blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }
.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }
@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
.print-only { display: none !important; }
@media print { * { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }
.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }
*:not(pre) > code { font-size: 0.9375em; padding: 1px 3px 0; white-space: nowrap; background-color: #f2f2f2; border: 1px solid #cccccc; -webkit-border-radius: 4px; border-radius: 4px; text-shadow: none; }
pre, pre > code { line-height: 1.4; color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }
kbd.keyseq { color: #555555; }
kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }
kbd kbd:first-child { margin-left: 0; }
kbd kbd:last-child { margin-right: 0; }
.menuseq, .menu { color: #090909; }
p a > code:hover { color: #561309; }
#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }
#header { margin-bottom: 2.5em; }
#header > h1 { color: black; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }
#toc { border-bottom: 3px double #ebebeb; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }
#toctitle { color: #7a2518; }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #ebebeb; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.25em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #ebebeb; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; border-width: 0; -webkit-border-radius: 4px; border-radius: 4px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }
#content #toctitle { font-weight: bold; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-size: 1em; padding-left: 0.125em; }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }
#footer-text { color: #dddddd; line-height: 1.44; }
.sect1 { padding-bottom: 1.25em; }
.sect1 + .sect1 { border-top: 3px double #ebebeb; }
#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }
.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.25em; }
.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }
.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }
.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }
.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }
.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; line-height: 1.6; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }
.literalblock > .content pre, .listingblock > .content pre { background: none; border-width: 1px 0; border-style: dotted; border-color: #bfbfbf; -webkit-border-radius: 4px; border-radius: 4px; padding: 0.75em 0.75em 0.5em 0.75em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.8em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.9em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 1em; } }
.listingblock > .content { position: relative; }
.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }
.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }
.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }
.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }
table.pyhltable { border: 0; margin-bottom: 0; }
table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }
table.pyhltable td.code { padding-left: .75em; padding-right: 0; }
.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }
.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }
table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }
.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: inherit; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }
table thead th, table tfoot th { font-weight: bold; }
table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 4px; border-radius: 4px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }
table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }
table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }
table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }
th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }
th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }
th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }
th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }
th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }
th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }
p.tableblock.header { color: #222222; font-weight: bold; }
td > div.verse { white-space: pre; }
ol { margin-left: 1.75em; }
ul li ol { margin-left: 1.5em; }
dl dd { margin-left: 1.125em; }
dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }
ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }
ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }
ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }
ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }
ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }
ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }
.unstyled dl dt { font-weight: normal; font-style: normal; }
ol.arabic { list-style-type: decimal; }
ol.decimal { list-style-type: decimal-leading-zero; }
ol.loweralpha { list-style-type: lower-alpha; }
ol.upperalpha { list-style-type: upper-alpha; }
ol.lowerroman { list-style-type: lower-roman; }
ol.upperroman { list-style-type: upper-roman; }
ol.lowergreek { list-style-type: lower-greek; }
.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }
td.hdlist1 { padding-right: .8em; font-weight: bold; }
td.hdlist1, td.hdlist2 { vertical-align: top; }
.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }
.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }
.qanda > ol > li > p > em:only-child { color: #00467f; }
.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }
.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }
.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }
a.image { text-decoration: none; }
span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }
.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }
div.unbreakable { page-break-inside: avoid; }
.big { font-size: larger; }
.small { font-size: smaller; }
.underline { text-decoration: underline; }
.overline { text-decoration: overline; }
.line-through { text-decoration: line-through; }
.aqua { color: #00bfbf; }
.aqua-background { background-color: #00fafa; }
.black { color: black; }
.black-background { background-color: black; }
.blue { color: #0000bf; }
.blue-background { background-color: #0000fa; }
.fuchsia { color: #bf00bf; }
.fuchsia-background { background-color: #fa00fa; }
.gray { color: #606060; }
.gray-background { background-color: #7d7d7d; }
.green { color: #006000; }
.green-background { background-color: #007d00; }
.lime { color: #00bf00; }
.lime-background { background-color: #00fa00; }
.maroon { color: #600000; }
.maroon-background { background-color: #7d0000; }
.navy { color: #000060; }
.navy-background { background-color: #00007d; }
.olive { color: #606000; }
.olive-background { background-color: #7d7d00; }
.purple { color: #600060; }
.purple-background { background-color: #7d007d; }
.red { color: #bf0000; }
.red-background { background-color: #fa0000; }
.silver { color: #909090; }
.silver-background { background-color: #bcbcbc; }
.teal { color: #006060; }
.teal-background { background-color: #007d7d; }
.white { color: #bfbfbf; }
.white-background { background-color: #fafafa; }
.yellow { color: #bfbf00; }
.yellow-background { background-color: #fafa00; }
span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }
.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #005498; color: #003f72; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }
.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }
.literalblock > .content > pre, .listingblock > .content > pre { -webkit-border-radius: 0; border-radius: 0; }

</style>
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css">
<style>
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #ffffff; }
.highlight .tok-c { color: #888888 } /* Comment */
.highlight .tok-err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .tok-k { color: #008800; font-weight: bold } /* Keyword */
.highlight .tok-cm { color: #888888 } /* Comment.Multiline */
.highlight .tok-cp { color: #cc0000; font-weight: bold } /* Comment.Preproc */
.highlight .tok-c1 { color: #888888 } /* Comment.Single */
.highlight .tok-cs { color: #cc0000; font-weight: bold; background-color: #fff0f0 } /* Comment.Special */
.highlight .tok-gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .tok-ge { font-style: italic } /* Generic.Emph */
.highlight .tok-gr { color: #aa0000 } /* Generic.Error */
.highlight .tok-gh { color: #333333 } /* Generic.Heading */
.highlight .tok-gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .tok-go { color: #888888 } /* Generic.Output */
.highlight .tok-gp { color: #555555 } /* Generic.Prompt */
.highlight .tok-gs { font-weight: bold } /* Generic.Strong */
.highlight .tok-gu { color: #666666 } /* Generic.Subheading */
.highlight .tok-gt { color: #aa0000 } /* Generic.Traceback */
.highlight .tok-kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .tok-kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .tok-kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .tok-kp { color: #008800 } /* Keyword.Pseudo */
.highlight .tok-kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .tok-kt { color: #888888; font-weight: bold } /* Keyword.Type */
.highlight .tok-m { color: #0000DD; font-weight: bold } /* Literal.Number */
.highlight .tok-s { color: #dd2200; background-color: #fff0f0 } /* Literal.String */
.highlight .tok-na { color: #336699 } /* Name.Attribute */
.highlight .tok-nb { color: #003388 } /* Name.Builtin */
.highlight .tok-nc { color: #bb0066; font-weight: bold } /* Name.Class */
.highlight .tok-no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .tok-nd { color: #555555 } /* Name.Decorator */
.highlight .tok-ne { color: #bb0066; font-weight: bold } /* Name.Exception */
.highlight .tok-nf { color: #0066bb; font-weight: bold } /* Name.Function */
.highlight .tok-nl { color: #336699; font-style: italic } /* Name.Label */
.highlight .tok-nn { color: #bb0066; font-weight: bold } /* Name.Namespace */
.highlight .tok-py { color: #336699; font-weight: bold } /* Name.Property */
.highlight .tok-nt { color: #bb0066; font-weight: bold } /* Name.Tag */
.highlight .tok-nv { color: #336699 } /* Name.Variable */
.highlight .tok-ow { color: #008800 } /* Operator.Word */
.highlight .tok-w { color: #bbbbbb } /* Text.Whitespace */
.highlight .tok-mf { color: #0000DD; font-weight: bold } /* Literal.Number.Float */
.highlight .tok-mh { color: #0000DD; font-weight: bold } /* Literal.Number.Hex */
.highlight .tok-mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .tok-mo { color: #0000DD; font-weight: bold } /* Literal.Number.Oct */
.highlight .tok-sb { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .tok-sc { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Char */
.highlight .tok-sd { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Doc */
.highlight .tok-s2 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Double */
.highlight .tok-se { color: #0044dd; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .tok-sh { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .tok-si { color: #3333bb; background-color: #fff0f0 } /* Literal.String.Interpol */
.highlight .tok-sx { color: #22bb22; background-color: #f0fff0 } /* Literal.String.Other */
.highlight .tok-sr { color: #008800; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .tok-s1 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Single */
.highlight .tok-ss { color: #aa6600; background-color: #fff0f0 } /* Literal.String.Symbol */
.highlight .tok-bp { color: #003388 } /* Name.Builtin.Pseudo */
.highlight .tok-vc { color: #336699 } /* Name.Variable.Class */
.highlight .tok-vg { color: #dd7700 } /* Name.Variable.Global */
.highlight .tok-vi { color: #3333bb } /* Name.Variable.Instance */
.highlight .tok-il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Ulquikit - How it works</h1>
<span id="author" class="author">Nguyễn Hà Dương (cmpitg)</span><br>
<span id="email" class="email">&lt;<a href="mailto:cmpitg@gmail.com">cmpitg@gmail.com</a>&gt;</span><br>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_terminology">1. Terminology</a></li>
<li><a href="#_extracting_and_including_snippets">2. Extracting and including snippets</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#section/extract-snippets">2.1. Extracting snippets</a></li>
<li><a href="#section/include-snippets">2.2. Including snippets into each other</a></li>
</ul>
</li>
<li><a href="#command/generate-src">3. Generating source code</a></li>
<li><a href="#_anatomy_of_a_ulquikit_command">4. Anatomy of a Ulquikit command</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_parsing_command_line_arguments_code_parse_command_args_code">4.1. Parsing command line arguments <code>parse-command-args</code></a></li>
<li><a href="#_calling_corresponding_command">4.2. Calling corresponding command</a></li>
<li><a href="#_putting_all_command_things_together">4.3. Putting all command things together</a></li>
</ul>
</li>
<li><a href="#_generating_html">5. Generating HTML</a></li>
<li><a href="#_the_code_ulqui_code_script">6. The <code>ulqui</code> script</a></li>
<li><a href="#_packaging">7. Packaging</a></li>
<li><a href="#_misc">8. Misc</a></li>
<li><a href="#_license_header">9. License header</a></li>
<li><a href="#_extras">10. Extras</a></li>
<li><a href="#_utility_functions">11. Utility functions</a></li>
<li>
<ul class="sectlevel2">
<li><a href="#_command_list">11.1. Command list</a></li>
<li><a href="#_story_how_the_racket_version_of_ulquikit_was_actually_developed">11.2. Story: How the Racket version of Ulquikit was actually developed</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Ulquikit is written in literate programming itself with a small bootstrap
code.  This document is Ulquikit&#8217;s literate source code.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="icon-important" title="Important"></i>
</td>
<td class="content">
Ulquikit follows
<a href="http://en.wikipedia.org/wiki/Convention_over_configuration">convention over
configuration</a> design.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To compile <em>and run</em> Ulquikit, the following dependencies are required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://asciidoctor.org">AsciiDoctor</a></p>
</li>
<li>
<p><a href="http://racket-lang.org">Racket</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ulquikit contains 2 parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bootstrap part: small and straightforward, consists of several Racket files
to extract source code and documents from all AcsciiDoc files in <code>src/</code></p>
<div class="ulist">
<ul>
<li>
<p>To generate source code, run <code>src/bootstrap/generate-src.rkt</code></p>
</li>
<li>
<p>To generate documentation, run <code>src/bootstrap/generate-docs.rkt</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Main part: this file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s dive into some terminology first</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_terminology">1. Terminology</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>A <strong>code block</strong> is an AsciiDoc code block.</p>
</li>
<li>
<p>A <strong>snippet</strong> is a code block with Ulquikit-defined title and delimiter
<code>----</code>.  By default, a code block title that starts <code>file::</code> and <code>code::</code>
defines a <em>file snippet</em> and <em>code snippet</em>, respectively:</p>
<div class="ulist">
<ul>
<li>
<p>A <strong>file snippet</strong> is a snippet producing a source file.</p>
</li>
<li>
<p>A <strong>code snippet</strong> is a snippet storing source code that can be included into
other snippets.</p>
</li>
</ul>
</div>
</li>
<li>
<p>An <strong>include directive</strong> is a line of code that:</p>
<div class="ulist">
<ul>
<li>
<p>belongs to a snippet</p>
</li>
<li>
<p>has the format of <code>xx include::some-snippet-name</code> where <code>xx</code> are two
identical characters denoting a comment.  Ulquikit can recogize the
following comment types: <code>//</code>, <code>;;</code>, <code>##</code>, <code>--</code>, or C-stype <code>/*
include::some-snippet-name */</code>, or XML-style <code>&lt;!--
include::some-snippet-name -&#8594;</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extracting_and_including_snippets">2. Extracting and including snippets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ulquikit works by searching for all AsciiDoc documents inside
<code>&lt;project-root&gt;/src</code> directory, building a database of snippets, including
them into each other if necessary, then generating documentation and source
code.  Hence, the following functions are probably the most interesting ones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#func/extract-snippets-from-file"><code>extract-snippets-from-file</code></a>, which
helps extract snippets from a file</p>
</li>
<li>
<p><a href="#func/include-snippet"><code>include-snippet</code></a>, which helps
<a href="#section/include-snippets">include snippets</a> into each other</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s talk about <code>extract-snippets-from-file</code> first:</p>
</div>
<div class="sect2">
<h3 id="section/extract-snippets">2.1. Extracting snippets</h3>
<div class="paragraph">
<p>The first thing to do is probably to decide how snippets are stored.  This is
very important since every change made to this data structure would affect
code later one.</p>
</div>
<div class="paragraph">
<p>Each snippet is a hash with following format:</p>
</div>
<div id="snippet-format" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5</div></td><td class="code"><span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-nv">snippet-type</span>          <i class="conum" data-value="1"></i><b>(1)</b>
 <span class="tok-ss">&#39;name</span> <span class="tok-nv">snippet-name</span>          <i class="conum" data-value="2"></i><b>(2)</b>
 <span class="tok-ss">&#39;linenum</span> <span class="tok-nv">line-number</span>        <i class="conum" data-value="3"></i><b>(3)</b>
 <span class="tok-ss">&#39;lines</span> <span class="tok-nv">snippet-lines</span>        <i class="conum" data-value="4"></i><b>(4)</b>
 <span class="tok-ss">&#39;processed?</span> <span class="tok-nv">processed?</span><span class="tok-p">}</span>     <i class="conum" data-value="5"></i><b>(5)</b>
</td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>is either <code>'file</code> or <code>'code</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>is the name of the snippet; e.g. snippet with title <code>file::something</code> has
<code>something</code> as its name.  Note that snippet name is <em>a string</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>is the line number from the literate source code from where the snippet is
extracted</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>is the content of the snippet as a list of lines, this is for performance
purpose</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>determines whether this snippet has been processed? to include others, when
created for the first time, <code>'processed?</code> is always <code>#f</code>.  It&#8217;s only changed
after the snippet has been passed through
<a href="#include-snippet"><code>include-snippet</code></a></td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="icon-important" title="Important"></i>
</td>
<td class="content">
Snippets should never be created by directly by using hash.  They
should be created with <a href="#func/create-snippet"><code>create-snippet</code></a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since a snippet stores a list of lines as its content, it&#8217;d be convenient to
have a helper that joins those lines into a complete string:</p>
</div>
<div class="listingblock">
<div class="title">code::get-snippet-content</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4</div></td><td class="code"><span class="tok-c1">;; lang racket</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">get-snippet-content</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nf">string-join</span> <span class="tok-p">(</span><span class="tok-nf">%</span> <span class="tok-ss">&#39;lines</span><span class="tok-p">)</span> <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>create-snippet</code> is simply implemented as followed:</p>
</div>
<div id="func/create-snippet" class="listingblock">
<div class="title">code::create-snippet</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</div></td><td class="code"><span class="tok-c1">;; #lang racket</span>

<span class="tok-c1">;; include::get-snippet-content</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">create-snippet</span> <span class="tok-kd">#:type</span> <span class="tok-nv">type</span>
                        <span class="tok-kd">#:name</span> <span class="tok-nv">name</span>
                        <span class="tok-kd">#:linenum</span> <span class="tok-nv">linenum</span>
                        <span class="tok-kd">#:lines</span> <span class="tok-nv">lines</span>
                        <span class="tok-kd">#:processed?</span> <span class="tok-p">[</span><span class="tok-nf">processed?</span> <span class="tok-no">#f</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">([</span><span class="tok-nf">type</span> <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nb">symbol? </span><span class="tok-nv">type</span><span class="tok-p">)</span>
                  <span class="tok-nv">type</span>
                  <span class="tok-p">(</span><span class="tok-nb">string-&gt;symbol </span><span class="tok-nv">type</span><span class="tok-p">))]</span>
        <span class="tok-p">[</span><span class="tok-nf">name</span> <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nb">symbol? </span><span class="tok-nv">name</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-nb">symbol-&gt;string </span><span class="tok-nv">name</span><span class="tok-p">)</span>
                  <span class="tok-nv">name</span><span class="tok-p">)]</span>
        <span class="tok-p">[</span><span class="tok-nf">lines</span> <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nb">string? </span><span class="tok-nv">lines</span><span class="tok-p">)</span>
                   <span class="tok-p">(</span><span class="tok-nf">string-split</span> <span class="tok-nv">lines</span> <span class="tok-s">&quot;\n&quot;</span> <span class="tok-kd">#:trim?</span> <span class="tok-no">#f</span><span class="tok-p">)</span>
                   <span class="tok-nv">lines</span><span class="tok-p">)])</span>
    <span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-nv">type</span>
     <span class="tok-ss">&#39;name</span> <span class="tok-nv">name</span>
     <span class="tok-ss">&#39;linenum</span> <span class="tok-nv">linenum</span>
     <span class="tok-ss">&#39;lines</span> <span class="tok-nv">lines</span>
     <span class="tok-ss">&#39;processed?</span> <span class="tok-nv">processed?</span><span class="tok-p">}))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">create-snippet</span> <span class="tok-kd">#:type</span> <span class="tok-ss">&#39;file</span>
                                <span class="tok-kd">#:name</span> <span class="tok-ss">&#39;hello-world</span>
                                <span class="tok-kd">#:linenum</span> <span class="tok-mi">10</span>
                                <span class="tok-kd">#:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Hmm&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;file</span>
                 <span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;hello-world&quot;</span>
                 <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">10</span>
                 <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Hmm&quot;</span><span class="tok-p">)</span>
                 <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#f</span><span class="tok-p">})</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">create-snippet</span> <span class="tok-kd">#:type</span> <span class="tok-s">&quot;string&quot;</span>
                                <span class="tok-kd">#:name</span> <span class="tok-s">&quot;string&quot;</span>
                                <span class="tok-kd">#:linenum</span> <span class="tok-mi">100</span>
                                <span class="tok-kd">#:lines</span> <span class="tok-s">&quot;string&quot;</span><span class="tok-p">)</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;string</span>
                 <span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;string&quot;</span>
                 <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">100</span>
                 <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;string&quot;</span><span class="tok-p">)</span>
                 <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#f</span><span class="tok-p">}))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the helper <code>create-snippet</code> is ready.  Let&#8217;s move on to
<code>extract-snippets-from-file</code>.</p>
</div>
<div class="paragraph">
<p><code>extract-snippets-from-file</code> needs to determine whether <em>a line in a code
block</em> belongs to a <em>code snippet</em>, or <em>file snippet</em>, or none of those; then
extracts the content of the code block and store it if necessary.  Let&#8217;s have
a look at 3 types of code block to see how we could tackle this problem:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>code snippet</em> has the following format:</p>
<div class="listingblock">
<div class="content">
<pre>.code::title-of-the-code-block  <i class="conum" data-value="1"></i><b>(1)</b>
[source]                        <i class="conum" data-value="2"></i><b>(2)</b>
----                            <i class="conum" data-value="3"></i><b>(3)</b>
Content of the code block
----                            <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[source]                        <i class="conum" data-value="2"></i><b>(2)</b>
.code::title-of-the-code-block  <i class="conum" data-value="1"></i><b>(1)</b>
----                            <i class="conum" data-value="3"></i><b>(3)</b>
Content of the code block
----                            <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
</li>
<li>
<p>A <em>file snippet</em> shares the same structure as a <em>code snippet</em>:</p>
<div class="listingblock">
<div class="content">
<pre>.file::title-of-the-code-block  <i class="conum" data-value="1"></i><b>(1)</b>
[source]                        <i class="conum" data-value="2"></i><b>(2)</b>
----                            <i class="conum" data-value="3"></i><b>(3)</b>
Content of the code block
----                            <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[source]                        <i class="conum" data-value="2"></i><b>(2)</b>
.file::title-of-the-code-block  <i class="conum" data-value="1"></i><b>(1)</b>
----                            <i class="conum" data-value="3"></i><b>(3)</b>
Content of the code block
----                            <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
</li>
<li>
<p>A non-snippet code block is any block without <code>code::&#8230;</code> or <code>file::&#8230;</code> as
its title:</p>
<div class="listingblock">
<div class="content">
<pre>[source]                        <i class="conum" data-value="2"></i><b>(2)</b>
----                            <i class="conum" data-value="3"></i><b>(3)</b>
Content of the code block
----                            <i class="conum" data-value="4"></i><b>(4)</b>

....                            <i class="conum" data-value="3"></i><b>(3)</b>
This is a literal block
....                            <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>block title</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>block type</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>block delimiter</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>block delimiter</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As we can clearly see from the 3 examples, <em>code snippets</em> and <em>file snippets</em>
could be determined by checking 2<sup>nd</sup> previous line from block delimiter to
see if it starts with <code>.file::</code> or <code>.code::</code>.  Everything between the 2
delimiters is stored as the content of the snippet.</p>
</div>
<div class="paragraph">
<p>Hence, we have the following algorithm for <code>extract-snippets-from-file</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read the content of a file</p>
</li>
<li>
<p>Break the content into lines preserving line numbers (call <code>string-split</code>
with <code>#:trim? #f</code>).</p>
</li>
<li>
<p>For each line:</p>
<div class="ulist">
<ul>
<li>
<p>If we&#8217;re already inside a snippet:</p>
<div class="ulist">
<ul>
<li>
<p>Complete a snippet and add it to snippet list if current line is a block
delimiter (i.e. <code>----</code>)</p>
</li>
<li>
<p>Add current line to the current snippet&#8217;s content if current line is not a
block delimiter</p>
</li>
</ul>
</div>
</li>
<li>
<p>If we&#8217;re outside a snippet, we only care if current line is a block
delimiter (i.e. <code>----</code>):</p>
<div class="ulist">
<ul>
<li>
<p>If this block has a title that marks the beginning of a snippet (i.e. the
2<sup>nd</sup> previous line starts with <code>.file::</code> or <code>.code::</code>), extract snippet
name and add a new snippet.  Otherwise</p>
</li>
<li>
<p>If this block does not mark the beginning of a snippet, ignore it.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="func/extract-snippets-from-file" class="listingblock">
<div class="title">code::extract-snippets-from-file</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</div></td><td class="code"><span class="tok-c1">;; include::extract-snippets-from-file-helpers</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">extract-snippets-from-file</span> <span class="tok-nv">path</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">file-content</span> <span class="tok-p">(</span><span class="tok-nf">read-file</span> <span class="tok-nv">path</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">lines</span>        <span class="tok-p">(</span><span class="tok-nf">string-split</span> <span class="tok-nv">file-content</span> <span class="tok-s">&quot;\n&quot;</span> <span class="tok-kd">#:trim?</span> <span class="tok-no">#f</span><span class="tok-p">)]</span>

         <span class="tok-p">[</span><span class="tok-nf">snippets</span>        <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{}</span>
                                      <span class="tok-ss">&#39;code</span> <span class="tok-p">{}})]</span>

         <span class="tok-p">[</span><span class="tok-nf">prev-prev-line</span>  <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-s">&quot;&quot;</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">prev-line</span>       <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-s">&quot;&quot;</span><span class="tok-p">)]</span>

         <span class="tok-p">[</span><span class="tok-nf">snippet-type</span>    <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-nv">null</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">snippet-lines</span>   <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-o">&#39;</span><span class="tok-p">())]</span>
         <span class="tok-p">[</span><span class="tok-nf">snippet-name</span>    <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-s">&quot;&quot;</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">snippet-linenum</span> <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-mi">0</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">inside-snippet</span>  <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-no">#f</span><span class="tok-p">)])</span>

    <span class="tok-p">(</span><span class="tok-nf">for</span> <span class="tok-p">([</span><span class="tok-nf">line-num</span>    <span class="tok-p">(</span><span class="tok-nf">in-naturals</span> <span class="tok-mi">1</span><span class="tok-p">)]</span>
          <span class="tok-p">[</span><span class="tok-nf">line</span>        <span class="tok-p">(</span><span class="tok-nf">in-list</span> <span class="tok-nv">lines</span><span class="tok-p">)])</span>

      <span class="tok-p">(</span><span class="tok-k">cond </span><span class="tok-p">[(</span><span class="tok-k">and </span><span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">inside-snippet</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-nb">not </span><span class="tok-p">(</span><span class="tok-nf">is-block-delimiter?</span> <span class="tok-nv">line</span><span class="tok-p">)))</span>

             <span class="tok-p">(</span><span class="tok-nf">box-swap!</span> <span class="tok-nv">snippet-lines</span> <span class="tok-nv">append</span> <span class="tok-p">(</span><span class="tok-nb">list </span><span class="tok-nv">line</span><span class="tok-p">))]</span>

            <span class="tok-p">[(</span><span class="tok-k">and </span><span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">inside-snippet</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-nf">is-block-delimiter?</span> <span class="tok-nv">line</span><span class="tok-p">))</span>

             <span class="tok-p">(</span><span class="tok-nf">box-set!</span> <span class="tok-nv">inside-snippet</span> <span class="tok-no">#f</span><span class="tok-p">)</span>
             <span class="tok-p">(</span><span class="tok-nf">box-swap!</span> <span class="tok-nv">snippets</span>
                        <span class="tok-nv">add-snippets</span>
                        <span class="tok-p">(</span><span class="tok-nf">create-snippet</span> <span class="tok-kd">#:type</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">snippet-type</span><span class="tok-p">)</span>
                                        <span class="tok-kd">#:name</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">snippet-name</span><span class="tok-p">)</span>
                                        <span class="tok-kd">#:linenum</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">snippet-linenum</span><span class="tok-p">)</span>
                                        <span class="tok-kd">#:lines</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">snippet-lines</span><span class="tok-p">)))]</span>
            <span class="tok-p">[(</span><span class="tok-nf">is-block-delimiter?</span> <span class="tok-nv">line</span><span class="tok-p">)</span>

             <span class="tok-p">(</span><span class="tok-k">when </span><span class="tok-p">(</span><span class="tok-k">or </span><span class="tok-p">(</span><span class="tok-nf">is-block-title?</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">prev-prev-line</span><span class="tok-p">))</span>
                       <span class="tok-p">(</span><span class="tok-nf">is-block-title?</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">prev-line</span><span class="tok-p">)))</span>
               <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">([</span><span class="tok-nf">title-line</span> <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">is-block-title?</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">prev-prev-line</span><span class="tok-p">))</span>
                                     <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">prev-prev-line</span><span class="tok-p">)</span>
                                     <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">prev-line</span><span class="tok-p">))])</span>
                 <span class="tok-p">(</span><span class="tok-nf">box-set!</span> <span class="tok-nv">inside-snippet</span> <span class="tok-no">#t</span><span class="tok-p">)</span>

                 <span class="tok-p">(</span><span class="tok-nf">box-set!</span> <span class="tok-nv">snippet-type</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-type</span> <span class="tok-nv">title-line</span><span class="tok-p">))</span>
                 <span class="tok-p">(</span><span class="tok-nf">box-set!</span> <span class="tok-nv">snippet-name</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-name</span> <span class="tok-nv">title-line</span><span class="tok-p">))</span>
                 <span class="tok-p">(</span><span class="tok-nf">box-set!</span> <span class="tok-nv">snippet-lines</span> <span class="tok-o">&#39;</span><span class="tok-p">())</span>
                 <span class="tok-p">(</span><span class="tok-nf">box-set!</span> <span class="tok-nv">snippet-linenum</span> <span class="tok-p">(</span><span class="tok-nf">dec</span> <span class="tok-nv">line-num</span><span class="tok-p">))))])</span>

      <span class="tok-c1">;; Always update previous line</span>
      <span class="tok-p">(</span><span class="tok-nf">box-set!</span> <span class="tok-nv">prev-prev-line</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">prev-line</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">box-set!</span> <span class="tok-nv">prev-line</span>      <span class="tok-nv">line</span><span class="tok-p">))</span>

    <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">snippets</span><span class="tok-p">)))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, for <code>extract-snippets-from-file</code> to function, the following helpers are
necessary:</p>
</div>
<div class="listingblock">
<div class="title">code::extract-snippets-from-file-helpers</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">is-block-delimiter?</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nb">regexp-match? </span><span class="tok-sr">#rx&quot;^----( *)$&quot;</span> <span class="tok-nv">%</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-block-delimiter?</span> <span class="tok-s">&quot;----&quot;</span><span class="tok-p">)</span>    <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-block-delimiter?</span> <span class="tok-s">&quot; ----&quot;</span><span class="tok-p">)</span>   <span class="tok-no">#f</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-block-delimiter?</span> <span class="tok-s">&quot;---- &quot;</span><span class="tok-p">)</span>   <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-block-delimiter?</span> <span class="tok-s">&quot;----  &quot;</span><span class="tok-p">)</span>  <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-block-delimiter?</span> <span class="tok-s">&quot;----a&quot;</span><span class="tok-p">)</span>   <span class="tok-no">#f</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">is-block-title?</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nb">regexp-match? </span><span class="tok-sr">#rx&quot;^\\.(file|code)::&quot;</span> <span class="tok-nv">%</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-block-title?</span> <span class="tok-s">&quot;.file::something&quot;</span><span class="tok-p">)</span>       <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-block-title?</span> <span class="tok-s">&quot;.file::something else&quot;</span><span class="tok-p">)</span>  <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-block-title?</span> <span class="tok-s">&quot;.file::&quot;</span><span class="tok-p">)</span>                <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-block-title?</span> <span class="tok-s">&quot;.file:something&quot;</span><span class="tok-p">)</span>        <span class="tok-no">#f</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">get-snippet-type</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nf">~&gt;</span> <span class="tok-p">(</span><span class="tok-nf">string-rest</span> <span class="tok-nv">%</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nf">string-split</span> <span class="tok-s">&quot;::&quot;</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nb">list-ref </span><span class="tok-mi">0</span><span class="tok-p">)</span>
      <span class="tok-nv">string-&gt;symbol</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-type</span> <span class="tok-s">&quot;.file::&quot;</span><span class="tok-p">)</span>  <span class="tok-ss">&#39;file</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-type</span> <span class="tok-s">&quot;.code::&quot;</span><span class="tok-p">)</span>  <span class="tok-ss">&#39;code</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">get-snippet-name</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nf">~&gt;</span> <span class="tok-p">(</span><span class="tok-nf">string-rest</span> <span class="tok-nv">%</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nf">string-split</span> <span class="tok-s">&quot;::&quot;</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nb">append </span><span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;&quot;</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nb">list-ref </span><span class="tok-mi">1</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-name</span> <span class="tok-s">&quot;.file::&quot;</span><span class="tok-p">)</span>     <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-name</span> <span class="tok-s">&quot;.code::&quot;</span><span class="tok-p">)</span>     <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-name</span> <span class="tok-s">&quot;.file::abc&quot;</span><span class="tok-p">)</span>  <span class="tok-s">&quot;abc&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-name</span> <span class="tok-s">&quot;.code::a b&quot;</span><span class="tok-p">)</span>  <span class="tok-s">&quot;a b&quot;</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">add-snippets</span> <span class="tok-nv">snippets</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">type</span> <span class="tok-p">(</span><span class="tok-nf">snippet</span> <span class="tok-ss">&#39;type</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">name</span> <span class="tok-p">(</span><span class="tok-nf">snippet</span> <span class="tok-ss">&#39;name</span><span class="tok-p">)]</span>

         <span class="tok-p">[</span><span class="tok-nf">snippets/typed</span>         <span class="tok-p">(</span><span class="tok-nf">snippets</span> <span class="tok-nv">type</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">snippets/typed/updated</span> <span class="tok-p">(</span><span class="tok-nf">snippets/typed</span> <span class="tok-nv">name</span> <span class="tok-nv">snippet</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-nf">snippets</span> <span class="tok-nv">type</span> <span class="tok-nv">snippets/typed/updated</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">add-snippets</span> <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{}</span>
                               <span class="tok-ss">&#39;code</span> <span class="tok-p">{}}</span>
                              <span class="tok-p">(</span><span class="tok-nf">create-snippet</span> <span class="tok-kd">#:type</span> <span class="tok-ss">&#39;file</span>
                                              <span class="tok-kd">#:name</span> <span class="tok-ss">&#39;hello</span>
                                              <span class="tok-kd">#:linenum</span> <span class="tok-mi">10</span>
                                              <span class="tok-kd">#:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Something&quot;</span><span class="tok-p">)))</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;file</span>
                                 <span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;hello&quot;</span>
                                 <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">10</span>
                                 <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Something&quot;</span><span class="tok-p">)</span>
                                 <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#f</span><span class="tok-p">}}</span>
                 <span class="tok-ss">&#39;code</span> <span class="tok-p">{}})</span>

  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">add-snippets</span> <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;file</span>
                                               <span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;hello&quot;</span>
                                               <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">10</span>
                                               <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Something&quot;</span><span class="tok-p">)</span>
                                               <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#f</span><span class="tok-p">}}</span>
                               <span class="tok-ss">&#39;code</span> <span class="tok-p">{}}</span>
                              <span class="tok-p">(</span><span class="tok-nf">create-snippet</span> <span class="tok-kd">#:type</span> <span class="tok-ss">&#39;code</span>
                                              <span class="tok-kd">#:name</span> <span class="tok-ss">&#39;say-something</span>
                                              <span class="tok-kd">#:linenum</span> <span class="tok-mi">100</span>
                                              <span class="tok-kd">#:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Something else&quot;</span><span class="tok-p">)))</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;file</span>
                                 <span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;hello&quot;</span>
                                 <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">10</span>
                                 <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Something&quot;</span><span class="tok-p">)</span>
                                 <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#f</span><span class="tok-p">}}</span>
                 <span class="tok-ss">&#39;code</span> <span class="tok-p">{</span><span class="tok-s">&quot;say-something&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                                         <span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;say-something&quot;</span>
                                         <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">100</span>
                                         <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Something else&quot;</span><span class="tok-p">)</span>
                                         <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#f</span><span class="tok-p">}}}))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a result, <code>extract-snippets</code>, which extracts snippets from all AsciiDoc
documents in a directory recursively, makes use of
<code>extract-snippets-from-file</code> to function.  <code>extract-snippets</code> takes a path and
return a hash of following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-nv">file-snippets-hash</span>
 <span class="tok-ss">&#39;code</span> <span class="tok-nv">code-snippets-hash</span><span class="tok-p">}</span>
</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>file-snippets-hash</code> and <code>code-snippets-hash</code> follow <a href="#snippet-format">snippet
format</a> defined above.</p>
</div>
<div class="listingblock">
<div class="title">code::extract-snippets</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125</div></td><td class="code"><span class="tok-c1">;; include::extract-snippets-from-file</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">extract-snippets</span> <span class="tok-nv">from-dir</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">for/fold</span> <span class="tok-p">([</span><span class="tok-nf">snippet</span> <span class="tok-p">{}])</span>
      <span class="tok-p">([</span><span class="tok-nf">file</span> <span class="tok-p">(</span><span class="tok-nf">list-all-adocs</span> <span class="tok-p">(</span><span class="tok-nf">standardize-path</span> <span class="tok-nv">from-dir</span><span class="tok-p">))])</span>
    <span class="tok-p">(</span><span class="tok-nf">dict-merge</span> <span class="tok-nv">snippet</span> <span class="tok-p">(</span><span class="tok-nf">extract-snippets-from-file</span> <span class="tok-nv">file</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">temp-dir</span> <span class="tok-p">(</span><span class="tok-nf">get-relative-path</span> <span class="tok-p">(</span><span class="tok-nf">get-temp-dir</span><span class="tok-p">)</span>
                                      <span class="tok-s">&quot;./ulqui-extract-snippets&quot;</span><span class="tok-p">)]</span>

         <span class="tok-p">[</span><span class="tok-nf">expected-code-snippets</span>
          <span class="tok-p">{</span><span class="tok-s">&quot;main-program&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-join</span>
                           <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;;; include::utils&quot;</span>
                             <span class="tok-s">&quot;&quot;</span>
                             <span class="tok-s">&quot;(module+ main&quot;</span>
                             <span class="tok-s">&quot;  (displayln (string-reverse \&quot;¡Hola mundo!\&quot;)))&quot;</span>
                             <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
                           <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)</span>
           <span class="tok-s">&quot;use-rackjure&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-join</span>
                           <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;#lang rackjure&quot;</span>
                             <span class="tok-s">&quot;(current-curly-dict hash)&quot;</span><span class="tok-p">)</span>
                           <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)</span>
           <span class="tok-s">&quot;license-header&quot;</span> <span class="tok-s">&quot;;; Just a sample license header.&quot;</span>
           <span class="tok-s">&quot;utils&quot;</span> <span class="tok-s">&quot;;; include::utils-string&quot;</span>
           <span class="tok-s">&quot;utils-string&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-join</span>
                           <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;(define (string-reverse str)&quot;</span>
                             <span class="tok-s">&quot;  (~&gt; (string-&gt;list str)&quot;</span>
                             <span class="tok-s">&quot;    reverse&quot;</span>
                             <span class="tok-s">&quot;    list-&gt;string))&quot;</span><span class="tok-p">)</span>
                           <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)}]</span>

         <span class="tok-p">[</span><span class="tok-nf">expected-file-snippets</span>
          <span class="tok-p">{</span><span class="tok-s">&quot;/tmp/tmp.rkt&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-join</span>
                           <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;;; include::license-header&quot;</span>
                             <span class="tok-s">&quot;&quot;</span>
                             <span class="tok-s">&quot;;; include::use-rackjure&quot;</span>
                             <span class="tok-s">&quot;&quot;</span>
                             <span class="tok-s">&quot;;; include::main-program&quot;</span>
                             <span class="tok-s">&quot;&quot;</span>
                             <span class="tok-s">&quot;== Main program&quot;</span>
                             <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
                           <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)}]</span>

         <span class="tok-p">[</span><span class="tok-nf">file-list</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Main&quot;</span>
                      <span class="tok-s">&quot;License&quot;</span>
                      <span class="tok-s">&quot;inside/Utils&quot;</span>
                      <span class="tok-s">&quot;inside/Utils-String&quot;</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">source-files</span> <span class="tok-p">(</span><span class="tok-nf">for/list</span> <span class="tok-p">([</span><span class="tok-nf">name</span> <span class="tok-p">(</span><span class="tok-nf">in-list</span> <span class="tok-nv">file-list</span><span class="tok-p">)])</span>
                         <span class="tok-p">(</span><span class="tok-nf">get-relative-path</span> <span class="tok-p">(</span><span class="tok-nb">format </span><span class="tok-s">&quot;~a./~a.adoc&quot;</span>
                                                    <span class="tok-nv">temp-dir</span>
                                                    <span class="tok-nv">name</span><span class="tok-p">)))]</span>
         <span class="tok-p">[</span><span class="tok-nf">content</span>
          <span class="tok-p">{</span><span class="tok-s">&quot;Main&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-join</span>
                   <span class="tok-p">(</span><span class="tok-nb">list </span><span class="tok-s">&quot;= A document&quot;</span>
                         <span class="tok-s">&quot;&quot;</span>
                         <span class="tok-s">&quot;Just a hello world program&quot;</span>
                         <span class="tok-s">&quot;&quot;</span>
                         <span class="tok-s">&quot;[source,racket,linenums]&quot;</span>
                         <span class="tok-s">&quot;.file::/tmp/tmp.rkt&quot;</span>
                         <span class="tok-s">&quot;----&quot;</span>
                         <span class="tok-p">(</span><span class="tok-nf">expected-file-snippets</span> <span class="tok-s">&quot;/tmp/tmp.rkt&quot;</span><span class="tok-p">)</span>
                         <span class="tok-s">&quot;----&quot;</span>
                         <span class="tok-s">&quot;.code::main-program&quot;</span>
                         <span class="tok-s">&quot;[source,racket,linenums]&quot;</span>
                         <span class="tok-s">&quot;----&quot;</span>
                         <span class="tok-p">(</span><span class="tok-nf">expected-code-snippets</span> <span class="tok-s">&quot;main-program&quot;</span><span class="tok-p">)</span>
                         <span class="tok-s">&quot;----&quot;</span>
                         <span class="tok-s">&quot;.code::use-rackjure&quot;</span>
                         <span class="tok-s">&quot;[source]&quot;</span>
                         <span class="tok-s">&quot;----&quot;</span>
                         <span class="tok-p">(</span><span class="tok-nf">expected-code-snippets</span> <span class="tok-s">&quot;use-rackjure&quot;</span><span class="tok-p">)</span>
                         <span class="tok-s">&quot;----&quot;</span>
                         <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
                   <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)</span>
           <span class="tok-s">&quot;License&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-join</span>
                      <span class="tok-p">(</span><span class="tok-nb">list </span><span class="tok-s">&quot;= License header&quot;</span>
                            <span class="tok-s">&quot;&quot;</span>
                            <span class="tok-s">&quot;.code::license-header&quot;</span>
                            <span class="tok-s">&quot;[source,racket]&quot;</span>
                            <span class="tok-s">&quot;----&quot;</span>
                            <span class="tok-p">(</span><span class="tok-nf">expected-code-snippets</span> <span class="tok-s">&quot;license-header&quot;</span><span class="tok-p">)</span>
                            <span class="tok-s">&quot;----&quot;</span><span class="tok-p">)</span>
                      <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)</span>
           <span class="tok-s">&quot;inside/Utils&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-join</span>
                           <span class="tok-p">(</span><span class="tok-nb">list </span><span class="tok-s">&quot;= Utils&quot;</span>
                                 <span class="tok-s">&quot;&quot;</span>
                                 <span class="tok-s">&quot;Right now, we just want to include string utililities.&quot;</span>
                                 <span class="tok-s">&quot;&quot;</span>
                                 <span class="tok-s">&quot;.code::utils&quot;</span>
                                 <span class="tok-s">&quot;[source,racket,linenums]&quot;</span>
                                 <span class="tok-s">&quot;----&quot;</span>
                                 <span class="tok-p">(</span><span class="tok-nf">expected-code-snippets</span> <span class="tok-s">&quot;utils&quot;</span><span class="tok-p">)</span>
                                 <span class="tok-s">&quot;----&quot;</span><span class="tok-p">)</span>
                           <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)</span>
           <span class="tok-s">&quot;inside/Utils-String&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-join</span>
                                  <span class="tok-p">(</span><span class="tok-nb">list </span><span class="tok-s">&quot;= String Utilities&quot;</span>
                                        <span class="tok-s">&quot;&quot;</span>
                                        <span class="tok-s">&quot;.code::utils-string&quot;</span>
                                        <span class="tok-s">&quot;[source,racket,linenums]&quot;</span>
                                        <span class="tok-s">&quot;----&quot;</span>
                                        <span class="tok-p">(</span><span class="tok-nf">expected-code-snippets</span> <span class="tok-s">&quot;utils-string&quot;</span><span class="tok-p">)</span>
                                        <span class="tok-s">&quot;----&quot;</span><span class="tok-p">)</span>
                                  <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)}])</span>
    <span class="tok-p">(</span><span class="tok-k">with-handlers </span><span class="tok-p">([</span><span class="tok-nf">exn:fail?</span> <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nf">remove-dir</span> <span class="tok-nv">temp-dir</span><span class="tok-p">)])</span>
      <span class="tok-p">(</span><span class="tok-nf">remove-dir</span> <span class="tok-nv">temp-dir</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nf">create-dir</span> <span class="tok-p">(</span><span class="tok-nf">get-relative-path</span> <span class="tok-nv">temp-dir</span>
                                     <span class="tok-s">&quot;./inside&quot;</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">for</span> <span class="tok-p">([(</span><span class="tok-nf">filename</span> <span class="tok-nv">content</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nf">in-hash</span> <span class="tok-nv">content</span><span class="tok-p">)])</span>
        <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">([</span><span class="tok-nf">path</span> <span class="tok-p">(</span><span class="tok-nf">get-relative-path</span> <span class="tok-nv">temp-dir</span>
                                       <span class="tok-p">(</span><span class="tok-nb">format </span><span class="tok-s">&quot;./~a.adoc&quot;</span> <span class="tok-nv">filename</span><span class="tok-p">))])</span>
          <span class="tok-p">(</span><span class="tok-nf">display-to-file</span> <span class="tok-nv">content</span> <span class="tok-nv">path</span><span class="tok-p">)))</span>

      <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">snippets</span> <span class="tok-p">(</span><span class="tok-nf">extract-snippets</span> <span class="tok-nv">temp-dir</span><span class="tok-p">)]</span>
             <span class="tok-p">[</span><span class="tok-nf">code-snippet</span> <span class="tok-p">(</span><span class="tok-nf">get-code-snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">)]</span>
             <span class="tok-p">[</span><span class="tok-nf">file-snippet</span> <span class="tok-p">(</span><span class="tok-nf">get-file-snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">)])</span>

        <span class="tok-p">(</span><span class="tok-nf">for</span> <span class="tok-p">([(</span><span class="tok-nf">name</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span> <span class="tok-nv">code-snippet</span><span class="tok-p">])</span>
          <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-content</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span>
                        <span class="tok-p">(</span><span class="tok-nf">expected-code-snippets</span> <span class="tok-nv">name</span><span class="tok-p">)))</span>

        <span class="tok-p">(</span><span class="tok-nf">for</span> <span class="tok-p">([(</span><span class="tok-nf">name</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span> <span class="tok-nv">file-snippet</span><span class="tok-p">])</span>
          <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-content</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span>
                        <span class="tok-p">(</span><span class="tok-nf">expected-file-snippets</span> <span class="tok-nv">name</span><span class="tok-p">))))</span>
      <span class="tok-p">(</span><span class="tok-nf">remove-dir</span> <span class="tok-nv">temp-dir</span><span class="tok-p">))))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>After <code>extract-snippets</code>, the next important function is <code>include-snippet</code>,
which is use to include other snippets into one targeted snippet.  Let&#8217;s see
how we could implement it.</p>
</div>
</div>
<div class="sect2">
<h3 id="section/include-snippets">2.2. Including snippets into each other</h3>
<div class="paragraph">
<p><code>include-snippet</code> should take 2 arguments: a hash containing all snippets,
and the snippet which needs to be checked and included.  Thus this function
has the following signature: <code>(include-snippet snippets target)</code>
<code>include-snippet</code> working by browsing its content, one line at a time, then
replace the line with <code>include</code> directive with the corresponding <em>code
snippet</em>.  If no snippet is found, leave that line as-is.</p>
</div>
<div class="paragraph">
<p>Note that there are a couple things to bring into concern there:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Snippet A includes snippet B, snippets B includes snippets C and D.  So the
best scenario is to include C and D into B while we&#8217;re actually
processing A.  I.e. <code>include-snippet</code> should be recursive to accumulate the
results.</p>
</li>
<li>
<p>Also because of the above reason, <code>snippets</code> should be able to receive the
changes across all calls recursive to <code>include-snippet</code>.  I.e. consider
this dummy, incorrect implementation:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">include-snippet</span> <span class="tok-nv">snippets</span> <span class="tok-nv">target</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">unless </span><span class="tok-p">(</span><span class="tok-nb">= </span><span class="tok-p">(</span><span class="tok-nf">snippets</span> <span class="tok-ss">&#39;a</span><span class="tok-p">)</span> <span class="tok-mi">12</span><span class="tok-p">)</span>
    <span class="tok-c1">;; Increase (snippets &#39;a)</span>
    <span class="tok-p">(</span><span class="tok-nf">include-snippet</span> <span class="tok-nv">snippets</span> <span class="tok-nv">new-target</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">([</span><span class="tok-nf">snippets</span> <span class="tok-p">{</span><span class="tok-ss">&#39;a</span> <span class="tok-mi">10</span><span class="tok-p">}])</span>
 <span class="tok-p">(</span><span class="tok-nf">include-snippet</span> <span class="tok-nv">snippets</span> <span class="tok-nv">some-target</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">displayln </span><span class="tok-p">(</span><span class="tok-nf">snippets</span> <span class="tok-ss">&#39;a</span><span class="tok-p">))</span>
<span class="tok-c1">;; ⇨ 12</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see after returning from any call, the value of snippets should be
changed as it is changed inside those calls.</p>
</div>
<div class="paragraph">
<p>One of the solutions for this is to construct a helper and put <code>snippets</code> into
a <code>box</code> to make it safely immutable, then change it value for each time the
helper is call.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><code>box</code> and mutability</div>
This is a perfect example of safe use mutable values in combination with
<a href="http://docs.racket-lang.org/reference/boxes.html"><code>box</code></a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Snippet A includes snippet B, then snippet B includes snippet A again,
creating circular dependency.  To prevent this, a list of currently included
snippet must be kept track of.  If a snippet has already been in the track,
include it but don&#8217;t process it.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
In case of circular dependency, the results are <strong>unexpected</strong>.  Thus,
make sure snippets are well-managed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Henceforth, our helper will takes the signature: <code>(process-include-snippet
target track)</code></p>
</div>
<div class="paragraph">
<p>With all the reasons stated above, we have this implementation:</p>
</div>
<div id="func/include-snippet" class="listingblock">
<div class="title">code::include-snippet</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142</div></td><td class="code"><span class="tok-c1">;; lang racket</span>

<span class="tok-c1">;; include::include-snippet-helpers</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">include-snippet</span> <span class="tok-nv">boxed</span>
                         <span class="tok-nv">target</span>
                         <span class="tok-p">[</span><span class="tok-nf">included?</span> <span class="tok-p">{}])</span>
  <span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">updated-included?</span> <span class="tok-p">(</span><span class="tok-nf">included?</span> <span class="tok-p">(</span><span class="tok-nf">target</span> <span class="tok-ss">&#39;name</span><span class="tok-p">)</span> <span class="tok-no">#t</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">unless </span><span class="tok-p">(</span><span class="tok-nf">target</span> <span class="tok-ss">&#39;processed?</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">lines</span>
            <span class="tok-p">(</span><span class="tok-nf">for/list</span> <span class="tok-p">([</span><span class="tok-nf">line</span> <span class="tok-p">(</span><span class="tok-nf">target</span> <span class="tok-ss">&#39;lines</span><span class="tok-p">)])</span>
              <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-nv">line</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">included-snippet-name</span> <span class="tok-p">(</span><span class="tok-nf">get-included-snippet-name</span> <span class="tok-nv">line</span><span class="tok-p">)]</span>
                         <span class="tok-p">[</span><span class="tok-nf">snippet-to-include</span>    <span class="tok-p">(</span><span class="tok-nf">get-snippet-by-name</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">boxed</span><span class="tok-p">)</span>
                                                                     <span class="tok-nv">included-snippet-name</span><span class="tok-p">)])</span>
                    <span class="tok-p">(</span><span class="tok-k">cond </span><span class="tok-p">[(</span><span class="tok-k">or </span><span class="tok-p">(</span><span class="tok-nf">updated-included?</span> <span class="tok-nv">included-snippet-name</span><span class="tok-p">)</span>
                               <span class="tok-p">(</span><span class="tok-nb">not </span><span class="tok-nv">snippet-to-include</span><span class="tok-p">))</span>

                           <span class="tok-c1">;; This snippet has already been included on the</span>
                           <span class="tok-c1">;; track or there&#39;s no such snippet ⇨ do nothing</span>
                           <span class="tok-nv">line</span><span class="tok-p">]</span>

                          <span class="tok-p">[(</span><span class="tok-nf">snippet-to-include</span> <span class="tok-ss">&#39;processed?</span><span class="tok-p">)</span>

                           <span class="tok-c1">;; When the snippet is already processed, simply</span>
                           <span class="tok-c1">;; return it</span>
                           <span class="tok-p">(</span><span class="tok-nf">string-join</span> <span class="tok-p">(</span><span class="tok-nf">snippet-to-include</span> <span class="tok-ss">&#39;lines</span><span class="tok-p">)</span> <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)]</span>

                          <span class="tok-p">[</span><span class="tok-nf">else</span>

                           <span class="tok-c1">;; When the snippet we&#39;re about to include exists</span>
                           <span class="tok-c1">;; and hasn&#39;t been processed</span>
                           <span class="tok-p">(</span><span class="tok-nf">include-snippet</span> <span class="tok-nv">boxed</span>
                                            <span class="tok-nv">snippet-to-include</span>
                                            <span class="tok-p">(</span><span class="tok-nf">updated-included?</span> <span class="tok-nv">included-snippet-name</span> <span class="tok-no">#t</span><span class="tok-p">))</span>

                           <span class="tok-c1">;; Of course, then we must return it after</span>
                           <span class="tok-c1">;; processed</span>
                           <span class="tok-p">(</span><span class="tok-nf">~&gt;</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-by-name</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">boxed</span><span class="tok-p">)</span>
                                                    <span class="tok-nv">included-snippet-name</span><span class="tok-p">)</span>
                             <span class="tok-ss">&#39;lines</span>
                             <span class="tok-p">(</span><span class="tok-nf">string-join</span> <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">))]))</span>

                  <span class="tok-nv">line</span><span class="tok-p">))]</span>

           <span class="tok-p">[</span><span class="tok-nf">new-snippet</span> <span class="tok-p">(</span><span class="tok-nf">create-snippet</span> <span class="tok-kd">#:type</span> <span class="tok-p">(</span><span class="tok-nf">target</span> <span class="tok-ss">&#39;type</span><span class="tok-p">)</span>
                                        <span class="tok-kd">#:name</span> <span class="tok-p">(</span><span class="tok-nf">target</span> <span class="tok-ss">&#39;name</span><span class="tok-p">)</span>
                                        <span class="tok-kd">#:linenum</span> <span class="tok-p">(</span><span class="tok-nf">target</span> <span class="tok-ss">&#39;linenum</span><span class="tok-p">)</span>
                                        <span class="tok-kd">#:lines</span> <span class="tok-nv">lines</span>
                                        <span class="tok-kd">#:processed?</span> <span class="tok-no">#t</span><span class="tok-p">)])</span>
      <span class="tok-p">(</span><span class="tok-nf">update-snippet/boxed</span> <span class="tok-nv">boxed</span> <span class="tok-nv">new-snippet</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">file-snippet-tmp</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;/tmp/tmp.rkt&quot;</span>
                            <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;file</span>
                            <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;;; include::A&quot;</span><span class="tok-p">)</span>
                            <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">10</span><span class="tok-p">}]</span>
         <span class="tok-p">[</span><span class="tok-nf">snippets</span> <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{</span><span class="tok-s">&quot;/tmp/tmp.rkt&quot;</span> <span class="tok-nv">file-snippet-tmp</span><span class="tok-p">}</span>
                    <span class="tok-ss">&#39;code</span> <span class="tok-p">{</span><span class="tok-s">&quot;A&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;A&quot;</span>
                                <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                                <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;World&quot;</span> <span class="tok-s">&quot;;; include::B&quot;</span><span class="tok-p">)</span>
                                <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">20</span><span class="tok-p">}</span>
                           <span class="tok-s">&quot;B&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;B&quot;</span>
                                <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                                <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Hello&quot;</span><span class="tok-p">)</span>
                                <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">30</span><span class="tok-p">}</span>
                           <span class="tok-s">&quot;C&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;C&quot;</span>
                                <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                                <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Unprocessed&quot;</span><span class="tok-p">)</span>
                                <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">30</span>
                                <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#f</span><span class="tok-p">}}}]</span>
         <span class="tok-p">[</span><span class="tok-nf">boxed</span> <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-nv">snippets</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-nf">include-snippet</span> <span class="tok-nv">boxed</span> <span class="tok-nv">file-snippet-tmp</span> <span class="tok-p">{})</span>
    <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">boxed</span><span class="tok-p">)</span>
                  <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{</span><span class="tok-s">&quot;/tmp/tmp.rkt&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;/tmp/tmp.rkt&quot;</span>
                                          <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;file</span>
                                          <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;World\nHello&quot;</span><span class="tok-p">)</span>
                                          <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">10</span>
                                          <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#t</span><span class="tok-p">}}</span>
                   <span class="tok-ss">&#39;code</span> <span class="tok-p">{</span><span class="tok-s">&quot;A&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;A&quot;</span>
                               <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                               <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;World&quot;</span> <span class="tok-s">&quot;Hello&quot;</span><span class="tok-p">)</span>
                               <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">20</span>
                               <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#t</span><span class="tok-p">}</span>
                          <span class="tok-s">&quot;B&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;B&quot;</span>
                               <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                               <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Hello&quot;</span><span class="tok-p">)</span>
                               <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">30</span>
                               <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#t</span><span class="tok-p">}</span>
                          <span class="tok-s">&quot;C&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;C&quot;</span>
                               <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                               <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Unprocessed&quot;</span><span class="tok-p">)</span>
                               <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">30</span>
                               <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#f</span><span class="tok-p">}}}))</span>

  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">snippet-a</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;A&quot;</span>
                     <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                     <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;World&quot;</span> <span class="tok-s">&quot;;; include::B&quot;</span><span class="tok-p">)</span>
                     <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">20</span><span class="tok-p">}]</span>
         <span class="tok-p">[</span><span class="tok-nf">snippets</span> <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{}</span>
                    <span class="tok-ss">&#39;code</span> <span class="tok-p">{</span><span class="tok-s">&quot;A&quot;</span> <span class="tok-nv">snippet-a</span>
                           <span class="tok-s">&quot;B&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;B&quot;</span>
                                <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                                <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Hello&quot;</span> <span class="tok-s">&quot;;; include::A&quot;</span><span class="tok-p">)</span>
                                <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">30</span><span class="tok-p">}}}]</span>
         <span class="tok-p">[</span><span class="tok-nf">boxed</span> <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-nv">snippets</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-nf">include-snippet</span> <span class="tok-nv">boxed</span> <span class="tok-nv">snippet-a</span> <span class="tok-p">{})</span>
    <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">boxed</span><span class="tok-p">)</span>
                  <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{}</span>
                   <span class="tok-ss">&#39;code</span> <span class="tok-p">{</span><span class="tok-s">&quot;A&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;A&quot;</span>
                               <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                               <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;World&quot;</span> <span class="tok-s">&quot;Hello\n;; include::A&quot;</span><span class="tok-p">)</span>
                               <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">20</span>
                               <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#t</span><span class="tok-p">}</span>
                          <span class="tok-s">&quot;B&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;B&quot;</span>
                               <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                               <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Hello&quot;</span> <span class="tok-s">&quot;;; include::A&quot;</span><span class="tok-p">)</span>
                               <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">30</span>
                               <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#t</span><span class="tok-p">}}}))</span>

  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">snippet-a</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;A&quot;</span>
                     <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                     <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;World&quot;</span> <span class="tok-s">&quot;;; include::B&quot;</span><span class="tok-p">)</span>
                     <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">20</span><span class="tok-p">}]</span>
         <span class="tok-p">[</span><span class="tok-nf">snippets</span> <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{}</span>
                    <span class="tok-ss">&#39;code</span> <span class="tok-p">{</span><span class="tok-s">&quot;A&quot;</span> <span class="tok-nv">snippet-a</span><span class="tok-p">}}]</span>
         <span class="tok-p">[</span><span class="tok-nf">boxed</span> <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-nv">snippets</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-nf">include-snippet</span> <span class="tok-nv">boxed</span> <span class="tok-nv">snippet-a</span> <span class="tok-p">{})</span>
    <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">boxed</span><span class="tok-p">)</span>
                  <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{}</span>
                   <span class="tok-ss">&#39;code</span> <span class="tok-p">{</span><span class="tok-s">&quot;A&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;A&quot;</span>
                               <span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                               <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;World&quot;</span> <span class="tok-s">&quot;;; include::B&quot;</span><span class="tok-p">)</span>
                               <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">20</span>
                               <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#t</span><span class="tok-p">}}})))</span>

<span class="tok-c1">;; (define (include-snippet snippets target)</span>
<span class="tok-c1">;;   (let* ([boxed (box snippets)]</span>
<span class="tok-c1">;;          [snippet-name (target &#39;name)])</span>
<span class="tok-c1">;;     (include-snippet boxed</span>
<span class="tok-c1">;;                              #:name snippet-name</span>
<span class="tok-c1">;;                              #:included {})))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>As we can see, <code>include-snippet</code> makes use of a lot of helpers.  All of them
are short and easily implemented like so:</p>
</div>
<div class="listingblock">
<div class="title">code::include-snippet-helpers</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">update-snippet/boxed</span> <span class="tok-nv">snippets/box</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">type</span> <span class="tok-p">(</span><span class="tok-nf">snippet</span> <span class="tok-ss">&#39;type</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">name</span> <span class="tok-p">(</span><span class="tok-nf">snippet</span> <span class="tok-ss">&#39;name</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-nf">box-swap!</span> <span class="tok-nv">snippets/box</span>
               <span class="tok-p">(</span><span class="tok-err">λ</span> <span class="tok-p">(</span><span class="tok-nf">snippets</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">snippets/typed</span> <span class="tok-p">(</span><span class="tok-nf">snippets</span> <span class="tok-nv">type</span><span class="tok-p">)]</span>
                        <span class="tok-p">[</span><span class="tok-nf">snippets/typed/updated</span> <span class="tok-p">(</span><span class="tok-nf">snippets/typed</span> <span class="tok-nv">name</span> <span class="tok-nv">snippet</span><span class="tok-p">)]</span>
                        <span class="tok-p">[</span><span class="tok-nf">snippets/updated</span> <span class="tok-p">(</span><span class="tok-nf">snippets</span> <span class="tok-nv">type</span> <span class="tok-nv">snippets/typed/updated</span><span class="tok-p">)])</span>
                   <span class="tok-nv">snippets/updated</span><span class="tok-p">)))))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">snippets</span> <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{}</span>
                    <span class="tok-ss">&#39;code</span> <span class="tok-p">{</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                                    <span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;hello&quot;</span>
                                    <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;original&quot;</span><span class="tok-p">)</span>
                                    <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">20</span>
                                    <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#f</span><span class="tok-p">}}}]</span>
         <span class="tok-p">[</span><span class="tok-nf">snippets/box</span> <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-nv">snippets</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-nf">update-snippet/boxed</span> <span class="tok-nv">snippets/box</span>
                          <span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                           <span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;hello&quot;</span>
                           <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;changed&quot;</span><span class="tok-p">)</span>
                           <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">10</span>
                           <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#t</span><span class="tok-p">})</span>
    <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">snippets/box</span><span class="tok-p">)</span>
                  <span class="tok-p">{</span><span class="tok-ss">&#39;file</span> <span class="tok-p">{}</span>
                   <span class="tok-ss">&#39;code</span> <span class="tok-p">{</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-p">{</span><span class="tok-ss">&#39;type</span> <span class="tok-ss">&#39;code</span>
                                   <span class="tok-ss">&#39;name</span> <span class="tok-s">&quot;hello&quot;</span>
                                   <span class="tok-ss">&#39;lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;changed&quot;</span><span class="tok-p">)</span>
                                   <span class="tok-ss">&#39;linenum</span> <span class="tok-mi">10</span>
                                   <span class="tok-ss">&#39;processed?</span> <span class="tok-no">#t</span><span class="tok-p">}}})))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">is-include-directive?</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-k">or </span><span class="tok-p">(</span><span class="tok-nb">regexp-match? </span><span class="tok-sr">#px&quot;^[#;/-]{2} include::.*&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-trim</span> <span class="tok-nv">%</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nb">regexp-match? </span><span class="tok-sr">#px&quot;^&lt;!-- include::.* --&gt;&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-trim</span> <span class="tok-nv">%</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nb">regexp-match? </span><span class="tok-sr">#px&quot;^/\\* include::.* \\*/&quot;</span> <span class="tok-p">(</span><span class="tok-nf">string-trim</span> <span class="tok-nv">%</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-s">&quot;  ;; include::&quot;</span><span class="tok-p">)</span> <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-s">&quot;;; include::&quot;</span><span class="tok-p">)</span> <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-s">&quot;a;; include::&quot;</span><span class="tok-p">)</span> <span class="tok-no">#f</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-s">&quot;;; include::something&quot;</span><span class="tok-p">)</span> <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-s">&quot;## include::something&quot;</span><span class="tok-p">)</span> <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-s">&quot;// include::something&quot;</span><span class="tok-p">)</span> <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-s">&quot;/* include::something */&quot;</span><span class="tok-p">)</span> <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-s">&quot;&lt;!-- include::something --&gt;&quot;</span><span class="tok-p">)</span> <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-s">&quot;a &lt;!-- include::something --&gt;&quot;</span><span class="tok-p">)</span> <span class="tok-no">#f</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">get-included-snippet-name</span> <span class="tok-nv">line</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">is-include-directive?</span> <span class="tok-nv">line</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">line</span> <span class="tok-p">(</span><span class="tok-nf">string-trim</span> <span class="tok-nv">line</span><span class="tok-p">)]</span>
             <span class="tok-p">[</span><span class="tok-nf">line-2</span> <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">string-ends-with?</span> <span class="tok-nv">line</span> <span class="tok-s">&quot; --&gt;&quot;</span><span class="tok-p">)</span>
                         <span class="tok-p">(</span><span class="tok-nf">first</span> <span class="tok-p">(</span><span class="tok-nf">string-split</span> <span class="tok-nv">line</span> <span class="tok-s">&quot; --&gt;&quot;</span><span class="tok-p">))</span>
                         <span class="tok-nv">line</span><span class="tok-p">)]</span>
             <span class="tok-p">[</span><span class="tok-nf">line-3</span> <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">string-ends-with?</span> <span class="tok-nv">line-2</span> <span class="tok-s">&quot; */&quot;</span><span class="tok-p">)</span>
                         <span class="tok-p">(</span><span class="tok-nf">first</span> <span class="tok-p">(</span><span class="tok-nf">string-split</span> <span class="tok-nv">line-2</span> <span class="tok-s">&quot; */&quot;</span><span class="tok-p">))</span>
                         <span class="tok-nv">line-2</span><span class="tok-p">)]</span>
             <span class="tok-p">[</span><span class="tok-nf">splitted</span> <span class="tok-p">(</span><span class="tok-nf">string-split</span> <span class="tok-nv">line-3</span> <span class="tok-s">&quot;include::&quot;</span><span class="tok-p">)])</span>
        <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nb">&gt; </span><span class="tok-p">(</span><span class="tok-nb">length </span><span class="tok-nv">splitted</span><span class="tok-p">)</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
            <span class="tok-p">(</span><span class="tok-nf">last</span> <span class="tok-nv">splitted</span><span class="tok-p">)</span>
            <span class="tok-s">&quot;&quot;</span><span class="tok-p">))</span>
      <span class="tok-s">&quot;&quot;</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-included-snippet-name</span> <span class="tok-s">&quot;  ;; include::&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-included-snippet-name</span> <span class="tok-s">&quot;;; include::&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-included-snippet-name</span> <span class="tok-s">&quot;;; include::something&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;something&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-included-snippet-name</span> <span class="tok-s">&quot;## include::something&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;something&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-included-snippet-name</span> <span class="tok-s">&quot;// include::something&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;something&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-included-snippet-name</span> <span class="tok-s">&quot;/* include::something */&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;something&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-included-snippet-name</span> <span class="tok-s">&quot;&lt;!-- include::something --&gt;&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;something&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-included-snippet-name</span> <span class="tok-s">&quot;a &lt;!-- include::something --&gt;&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">get-snippet-by-name</span> <span class="tok-nv">snippets</span>
                             <span class="tok-nv">name</span>
                             <span class="tok-kd">#:type</span> <span class="tok-p">[</span><span class="tok-nf">type</span> <span class="tok-ss">&#39;code</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-nf">~&gt;</span> <span class="tok-nv">snippets</span> <span class="tok-nv">type</span> <span class="tok-nv">name</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that concludes the most important functions of Ulquikit.  Those functions
are used to implement the <a href="#section/generate-source"><code>generate-src</code></a> right below.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="command/generate-src">3. Generating source code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once snippets are extracted and included into each other, the act of
generateing source code becomes trivial, as implemented in <code>generate-src</code>
below.</p>
</div>
<div class="listingblock">
<div class="title">code::generate-src</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</div></td><td class="code"><span class="tok-c1">;; lang racket</span>

<span class="tok-c1">;; include::create-snippet</span>

<span class="tok-c1">;; include::extract-snippets</span>

<span class="tok-c1">;; include::include-snippet</span>

<span class="tok-c1">;; include::generate-snippets-helpers</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">generate-src</span> <span class="tok-kd">#:from</span> <span class="tok-p">[</span><span class="tok-nf">from</span> <span class="tok-s">&quot;src&quot;</span><span class="tok-p">]</span>
                      <span class="tok-kd">#:to</span>   <span class="tok-p">[</span><span class="tok-nf">to</span>   <span class="tok-s">&quot;generated-src&quot;</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">from</span> <span class="tok-p">(</span><span class="tok-nf">get-path</span> <span class="tok-nv">from</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">to</span>   <span class="tok-p">(</span><span class="tok-nf">get-path</span> <span class="tok-nv">to</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-nf">~&gt;</span> <span class="tok-p">(</span><span class="tok-nf">extract-snippets</span> <span class="tok-nv">from</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nf">include-file-snippets</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nf">generate-src-files</span> <span class="tok-nv">to</span><span class="tok-p">))))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The ultimate goal of generating source code is to produce files, so we only
need to include other snippets into file snippets.  <code>include-file-snippets</code>
does exactly that.  This function takes a hash of snippets as a result of the
call to <code>extract-snippets</code> and returns a hash of snippets with all file
snippets <a href="#section/include-snippets">included</a>.  Let&#8217;s combine the implement
of <code>include-file-snippets</code> and <code>generate-src-files</code> to make a complete set of
helpers for <code>generate-src</code>.</p>
</div>
<div class="listingblock">
<div class="title">code::generate-snippets-helpers</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</div></td><td class="code"><span class="tok-c1">;; lang racket</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">include-file-snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">([</span><span class="tok-nf">boxed</span> <span class="tok-p">(</span><span class="tok-nb">box </span><span class="tok-nv">snippets</span><span class="tok-p">)]</span>
        <span class="tok-p">[</span><span class="tok-nf">file-snippets/names</span> <span class="tok-p">(</span><span class="tok-nf">hash-keys</span> <span class="tok-p">(</span><span class="tok-nf">get-file-snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">))])</span>
    <span class="tok-p">(</span><span class="tok-nf">for</span> <span class="tok-p">([</span><span class="tok-nf">target-name</span> <span class="tok-nv">file-snippets/names</span><span class="tok-p">])</span>
      <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">target</span> <span class="tok-p">(</span><span class="tok-nf">~&gt;</span> <span class="tok-nv">snippets</span> <span class="tok-ss">&#39;file</span> <span class="tok-nv">target-name</span><span class="tok-p">)])</span>
        <span class="tok-p">(</span><span class="tok-nf">include-snippet</span> <span class="tok-nv">boxed</span> <span class="tok-nv">target</span> <span class="tok-p">{})))</span>
    <span class="tok-p">(</span><span class="tok-nb">unbox </span><span class="tok-nv">boxed</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">generate-src-files</span> <span class="tok-nv">snippets</span> <span class="tok-nv">to</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">for</span> <span class="tok-p">([(</span><span class="tok-nf">name</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nf">get-file-snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">path</span>    <span class="tok-p">(</span><span class="tok-nb">path-&gt;string </span><span class="tok-p">(</span><span class="tok-nf">get-relative-path</span> <span class="tok-nv">to</span> <span class="tok-nv">name</span><span class="tok-p">))]</span>
           <span class="tok-p">[</span><span class="tok-nf">content</span> <span class="tok-p">(</span><span class="tok-nf">get-snippet-content</span> <span class="tok-nv">snippet</span><span class="tok-p">)])</span>
      <span class="tok-p">(</span><span class="tok-nf">create-dir</span> <span class="tok-p">(</span><span class="tok-nf">path-&gt;directory</span> <span class="tok-nv">path</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nb">displayln </span><span class="tok-p">(</span><span class="tok-nf">~a</span> <span class="tok-s">&quot;-&gt; Writing &quot;</span> <span class="tok-nv">path</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nf">display-to-file</span> <span class="tok-nv">content</span> <span class="tok-nv">path</span> <span class="tok-kd">#:exists</span> <span class="tok-ss">&#39;truncate/replace</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">get-file-snippets</span> <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nf">%</span> <span class="tok-ss">&#39;file</span> <span class="tok-kd">#:else</span> <span class="tok-p">{}))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">get-code-snippets</span> <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nf">%</span> <span class="tok-ss">&#39;code</span> <span class="tok-kd">#:else</span> <span class="tok-p">{}))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>And of course, we need to define help string for <code>generate-src</code>:</p>
</div>
<div class="listingblock">
<div class="title">file::commands/generate-src.help.txt</div>
<div class="content">
<pre class="pygments highlight"><code class="text language-text"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</div></td><td class="code">ulqui generate-src [--from from] [--to to]

Generate source code from a location to another location.

  --from location where literate source code is stored, default: &quot;src&quot;
  --to   location where source are generated, default: &quot;generated-src&quot;

Examples

Generate source code from src/ to generated-src/
  ulqui generate-src

or explitcitly
  ulqui generate-src --from src/ --to generated-src/

Generate source code from ../literate-source/ to ../source/
  ulqui generate-src --from ../literate-source/ --to ../source/
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all functions are ready, let&#8217;s put them together into a command to
generate source code.</p>
</div>
<div class="listingblock">
<div class="title">file::commands/generate-src.rkt</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</div></td><td class="code"><span class="tok-c1">;; include::license-header</span>

<span class="tok-c1">;; include::use-rackjure</span>

<span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-s">&quot;../command-core.rkt&quot;</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-s">&quot;../utils/utils.rkt&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-s">&quot;../utils/path.rkt&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-s">&quot;../utils/string.rkt&quot;</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-k">provide </span><span class="tok-nv">run</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-nv">rackunit</span><span class="tok-p">))</span>

<span class="tok-c1">;; include::generate-src</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">run</span> <span class="tok-kd">#:from</span> <span class="tok-p">[</span><span class="tok-nf">from</span> <span class="tok-s">&quot;src&quot;</span><span class="tok-p">]</span>
             <span class="tok-kd">#:to</span>   <span class="tok-p">[</span><span class="tok-nf">to</span>   <span class="tok-s">&quot;generated-src&quot;</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-nf">display-command</span> <span class="tok-s">&quot;Generating source&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">generate-src</span> <span class="tok-kd">#:from</span> <span class="tok-nv">from</span>
                <span class="tok-kd">#:to</span>   <span class="tok-nv">to</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s how <code>generate-src</code> should be done.  It&#8217;s time to generalize this
structure for defining other commands as well.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_anatomy_of_a_ulquikit_command">4. Anatomy of a Ulquikit command</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ulquikit commands are actually a Racket modules, residing in <code>commands/</code>.  The
name of the module (without <code>.rkt</code> extension of course) is the actual command.
E.g. <code>commands/generate-src.rkt</code> implements <code>generate-src</code> command.</p>
</div>
<div class="paragraph">
<p>As a rule of thumb, each command has to provide at least 2 functions: <code>run</code>
and <code>help</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Command line arguments are parsed and passed through <code>run</code> function.  Named
arguments are automatically converted to either boolean or number and passed
as Racket keywords.</p>
<div class="paragraph">
<p>E.g.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ulqui generate-src</code> calls <code>commands/generate-src</code>'s <code>(run)</code>.</p>
</li>
<li>
<p><code>ulqui generate-src some-file</code> calls <code>commands/generate-src</code>'s <code>(run "some-file")</code>.</p>
</li>
<li>
<p><code>ulqui generate-src --from file1 --to file2</code> calls
<code>commands/generate-src</code>'s <code>(run #:from "file1" #:to "file2")</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>When <code>ulqui help command-name</code> or <code>ulqui command-name --help</code> is invoked,
the <code>help</code> function that belongs to <code>commands/command-name.rkt</code> module is
called.  The same effect could be achieved by calling <code>(run #:help #t)</code>.
This the <code>help</code> function takes no arguments and returns a string that would
be displayed as help.</p>
</li>
<li>
<p>Usually, in a typical program, help strings are hardcoded into the source
code, which makes the maintenance of help strings harder that necessary, not
to mention the code looks really ugly.  Ulquikit defines a convention for
writing and maintaining helps more effectively: command <code>do-something</code> has
its help stored in <code>commands/do-something.help.txt</code>.  See the implementation
of <a href="#command/generate-src"><code>generate-src</code></a> for more details on
<a href="#help/generate-src">how help string</a> is stored.</p>
</li>
<li>
<p>All commands must import <code>command-core.rkt</code> (relative to command directory:
<code>../command-core.rkt</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With all that has been said, let&#8217;s move on to the function which is used to
parse command line arguments.</p>
</div>
<div class="sect2">
<h3 id="_parsing_command_line_arguments_code_parse_command_args_code">4.1. Parsing command line arguments <code>parse-command-args</code></h3>
<div class="paragraph">
<p>This function takes all arguments passed to the command line as a list of
string and returns a map of following format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><span class="tok-p">{</span><span class="tok-ss">&#39;arguments</span> <span class="tok-nv">list-of-arguments</span>  <i class="conum" data-value="1"></i><b>(1)</b>
 <span class="tok-ss">&#39;options</span>   <span class="tok-nv">hash-of-options</span><span class="tok-p">}</span>   <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>main arguments collected as a list, with the same order as they are at the
command line</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>options are collected a hash; options that have no values are set to <code>#t</code></td>
</tr>
</table>
</div>
<div id="func/parse-command-args" class="listingblock">
<div class="title">code::parse-command-args</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</div></td><td class="code"><span class="tok-c1">;; include::parse-command-args-helpers</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">parse-command-args</span> <span class="tok-nv">args</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-p">([</span><span class="tok-nf">arguments</span> <span class="tok-p">(</span><span class="tok-nf">takef</span> <span class="tok-nv">args</span> <span class="tok-nv">is-argument?</span><span class="tok-p">)]</span>
        <span class="tok-p">[</span><span class="tok-nf">rest-args</span> <span class="tok-p">(</span><span class="tok-nf">dropf</span> <span class="tok-nv">args</span> <span class="tok-nv">is-argument?</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-k">let </span><span class="tok-nv">parse-options</span> <span class="tok-p">([</span><span class="tok-nf">rest-args</span>  <span class="tok-nv">rest-args</span><span class="tok-p">]</span>
                        <span class="tok-p">[</span><span class="tok-nf">options</span>    <span class="tok-p">{}])</span>
      <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">empty?</span> <span class="tok-nv">rest-args</span><span class="tok-p">)</span>
          <span class="tok-p">{</span><span class="tok-ss">&#39;arguments</span> <span class="tok-nv">arguments</span>
           <span class="tok-ss">&#39;options</span>   <span class="tok-nv">options</span><span class="tok-p">}</span>
          <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">option-name</span>   <span class="tok-p">(</span><span class="tok-nf">first</span> <span class="tok-nv">rest-args</span><span class="tok-p">)]</span>
                 <span class="tok-p">[</span><span class="tok-nf">option-values</span> <span class="tok-p">(</span><span class="tok-nf">takef</span> <span class="tok-p">(</span><span class="tok-nf">drop</span> <span class="tok-nv">rest-args</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-nv">is-argument?</span><span class="tok-p">)]</span>
                 <span class="tok-p">[</span><span class="tok-nf">rest-args</span>     <span class="tok-p">(</span><span class="tok-nf">dropf</span> <span class="tok-p">(</span><span class="tok-nf">rest</span> <span class="tok-nv">rest-args</span><span class="tok-p">)</span>   <span class="tok-nv">is-argument?</span><span class="tok-p">)]</span>

                 <span class="tok-p">[</span><span class="tok-nf">option-values/converted</span> <span class="tok-p">(</span><span class="tok-nb">map </span><span class="tok-nv">try-convert-value</span> <span class="tok-nv">option-values</span><span class="tok-p">)]</span>

                 <span class="tok-p">[</span><span class="tok-nf">name</span>   <span class="tok-p">(</span><span class="tok-nf">option-&gt;keyword</span> <span class="tok-nv">option-name</span><span class="tok-p">)]</span>
                 <span class="tok-p">[</span><span class="tok-nf">values</span> <span class="tok-p">(</span><span class="tok-k">cond </span><span class="tok-p">[(</span><span class="tok-nb">zero? </span><span class="tok-p">(</span><span class="tok-nb">length </span><span class="tok-nv">option-values/converted</span><span class="tok-p">))</span>
                                <span class="tok-no">#t</span><span class="tok-p">]</span>
                               <span class="tok-p">[(</span><span class="tok-nb">= </span><span class="tok-p">(</span><span class="tok-nb">length </span><span class="tok-nv">option-values/converted</span><span class="tok-p">)</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
                                <span class="tok-p">(</span><span class="tok-nf">first</span> <span class="tok-nv">option-values/converted</span><span class="tok-p">)]</span>
                               <span class="tok-p">[</span><span class="tok-nf">else</span>
                                <span class="tok-nv">option-values/converted</span><span class="tok-p">])])</span>
            <span class="tok-p">(</span><span class="tok-nf">parse-options</span> <span class="tok-nv">rest-args</span>
                           <span class="tok-p">(</span><span class="tok-nf">options</span> <span class="tok-nv">name</span> <span class="tok-nv">values</span><span class="tok-p">)))))))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">parse-command-args</span> <span class="tok-o">&#39;</span><span class="tok-p">())</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;arguments</span> <span class="tok-o">&#39;</span><span class="tok-p">()</span>
                 <span class="tok-ss">&#39;options</span>   <span class="tok-p">{}})</span>

  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">parse-command-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello-world&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;arguments</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello-world&quot;</span><span class="tok-p">)</span>
                 <span class="tok-ss">&#39;options</span>   <span class="tok-p">{}})</span>

  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">parse-command-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;world&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;arguments</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;world&quot;</span><span class="tok-p">)</span>
                 <span class="tok-ss">&#39;options</span>   <span class="tok-p">{}})</span>

  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">parse-command-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;--help&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;arguments</span> <span class="tok-o">&#39;</span><span class="tok-p">()</span>
                 <span class="tok-ss">&#39;options</span>   <span class="tok-p">{</span><span class="tok-o">&#39;</span><span class="tok-kd">#:help</span> <span class="tok-no">#t</span><span class="tok-p">}})</span>

  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">parse-command-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;--help&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;arguments</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span><span class="tok-p">)</span>
                 <span class="tok-ss">&#39;options</span>   <span class="tok-p">{</span><span class="tok-o">&#39;</span><span class="tok-kd">#:help</span> <span class="tok-no">#t</span><span class="tok-p">}})</span>

  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">parse-command-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;--help&quot;</span> <span class="tok-s">&quot;world&quot;</span> <span class="tok-s">&quot;args&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;arguments</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span><span class="tok-p">)</span>
                 <span class="tok-ss">&#39;options</span>   <span class="tok-p">{</span><span class="tok-o">&#39;</span><span class="tok-kd">#:help</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;world&quot;</span> <span class="tok-s">&quot;args&quot;</span><span class="tok-p">)}})</span>

  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">parse-command-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;--help&quot;</span> <span class="tok-s">&quot;hello&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;arguments</span> <span class="tok-o">&#39;</span><span class="tok-p">()</span>
                 <span class="tok-ss">&#39;options</span>   <span class="tok-p">{</span><span class="tok-o">&#39;</span><span class="tok-kd">#:help</span> <span class="tok-s">&quot;hello&quot;</span><span class="tok-p">}})</span>

  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">parse-command-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;world&quot;</span> <span class="tok-s">&quot;--help&quot;</span> <span class="tok-s">&quot;--set-tab&quot;</span> <span class="tok-s">&quot;4&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">{</span><span class="tok-ss">&#39;arguments</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;world&quot;</span><span class="tok-p">)</span>
                 <span class="tok-ss">&#39;options</span>   <span class="tok-p">{</span><span class="tok-o">&#39;</span><span class="tok-kd">#:help</span> <span class="tok-no">#t</span>
                             <span class="tok-o">&#39;</span><span class="tok-kd">#:set-tab</span> <span class="tok-mi">4</span><span class="tok-p">}}))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>As always, it&#8217;s a good style to implement some helpers for
<a href="#func/parse-command-args"><code>parse-command-args</code></a>.</p>
</div>
<div class="listingblock">
<div class="title">code::parse-command-args-helpers</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</div></td><td class="code"><span class="tok-c1">;; #lang racket</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">is-argument?</span> <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nb">not </span><span class="tok-p">(</span><span class="tok-nf">string-starts-with?</span> <span class="tok-nv">%</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-argument?</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>     <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-argument?</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>    <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-argument?</span> <span class="tok-s">&quot;-a&quot;</span><span class="tok-p">)</span>   <span class="tok-no">#f</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-argument?</span> <span class="tok-s">&quot;--a&quot;</span><span class="tok-p">)</span>  <span class="tok-no">#f</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-argument?</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">)</span>    <span class="tok-no">#f</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">is-option?</span> <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nb">not </span><span class="tok-p">(</span><span class="tok-nf">is-argument?</span> <span class="tok-nv">%</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-option?</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>     <span class="tok-no">#f</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-option?</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>    <span class="tok-no">#f</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-option?</span> <span class="tok-s">&quot;-a&quot;</span><span class="tok-p">)</span>   <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-option?</span> <span class="tok-s">&quot;--a&quot;</span><span class="tok-p">)</span>  <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">is-option?</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">)</span>    <span class="tok-no">#t</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">option-&gt;keyword</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nb">string-&gt;keyword </span><span class="tok-p">(</span><span class="tok-nf">~&gt;</span> <span class="tok-p">(</span><span class="tok-nb">string-&gt;list </span><span class="tok-nv">%</span><span class="tok-p">)</span>
                       <span class="tok-p">(</span><span class="tok-nf">dropf</span> <span class="tok-p">(</span><span class="tok-err">λ</span> <span class="tok-p">(</span><span class="tok-nf">ch</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nb">eq? </span><span class="tok-sc">#\-</span> <span class="tok-nv">ch</span><span class="tok-p">)))</span>
                       <span class="tok-nv">list-&gt;string</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">option-&gt;keyword</span> <span class="tok-s">&quot;-h&quot;</span><span class="tok-p">)</span>      <span class="tok-o">&#39;</span><span class="tok-kd">#:h)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">option-&gt;keyword</span> <span class="tok-s">&quot;--help&quot;</span><span class="tok-p">)</span>  <span class="tok-o">&#39;</span><span class="tok-kd">#:help)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">option-&gt;keyword</span> <span class="tok-s">&quot;---help&quot;</span><span class="tok-p">)</span> <span class="tok-o">&#39;</span><span class="tok-kd">#:help))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">try-convert-value</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nf">if-let</span> <span class="tok-p">[</span><span class="tok-nf">value</span> <span class="tok-p">(</span><span class="tok-nb">string-&gt;number </span><span class="tok-nv">%</span><span class="tok-p">)]</span>
      <span class="tok-nv">value</span>
      <span class="tok-p">(</span><span class="tok-k">cond </span><span class="tok-p">[(</span><span class="tok-nb">string=? </span><span class="tok-s">&quot;true&quot;</span> <span class="tok-nv">%</span><span class="tok-p">)</span>
             <span class="tok-no">#t</span><span class="tok-p">]</span>
            <span class="tok-p">[(</span><span class="tok-nb">string=? </span><span class="tok-s">&quot;false&quot;</span> <span class="tok-nv">%</span><span class="tok-p">)</span>
             <span class="tok-no">#f</span><span class="tok-p">]</span>
            <span class="tok-p">[</span><span class="tok-nf">else</span>
             <span class="tok-nv">%</span><span class="tok-p">])))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">try-convert-value</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">)</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">try-convert-value</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">try-convert-value</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">)</span>  <span class="tok-no">#t</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">try-convert-value</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">)</span> <span class="tok-no">#f</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_calling_corresponding_command">4.2. Calling corresponding command</h3>
<div class="paragraph">
<p>Function <code>run-command</code> does exactly that, i.e. it calls corresponding command
and passes necessary arguments.</p>
</div>
<div id="func/run-command" class="listingblock">
<div class="title">code::run-command</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">run-command</span> <span class="tok-nv">command</span> <span class="tok-nv">args</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">module-location</span> <span class="tok-p">(</span><span class="tok-nf">string-&gt;path</span>
                           <span class="tok-p">(</span><span class="tok-nf">get-path</span> <span class="tok-nv">+this-directory+</span>
                                     <span class="tok-p">(</span><span class="tok-nb">format </span><span class="tok-s">&quot;commands/~a.rkt&quot;</span>
                                             <span class="tok-nv">command</span><span class="tok-p">)))]</span>
         <span class="tok-p">[</span><span class="tok-nf">run-func</span>        <span class="tok-p">(</span><span class="tok-nb">dynamic-require </span><span class="tok-nv">module-location</span> <span class="tok-ss">&#39;run</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">args</span>            <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">hash?</span> <span class="tok-nv">args</span><span class="tok-p">)</span>
                              <span class="tok-nv">args</span>
                              <span class="tok-p">(</span><span class="tok-nf">parse-command-args</span> <span class="tok-nv">args</span><span class="tok-p">))]</span>
         <span class="tok-p">[</span><span class="tok-nf">main-args</span>       <span class="tok-p">(</span><span class="tok-nf">args</span> <span class="tok-ss">&#39;arguments</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">keyword-list</span>    <span class="tok-p">(</span><span class="tok-nf">hash-keys</span> <span class="tok-p">(</span><span class="tok-nf">args</span> <span class="tok-ss">&#39;options</span><span class="tok-p">))]</span>
         <span class="tok-p">[</span><span class="tok-nf">val-list</span>        <span class="tok-p">(</span><span class="tok-nf">hash-values</span> <span class="tok-p">(</span><span class="tok-nf">args</span> <span class="tok-ss">&#39;options</span><span class="tok-p">))])</span>
    <span class="tok-p">(</span><span class="tok-nf">keyword-apply</span> <span class="tok-nv">run-func</span>
                   <span class="tok-nv">keyword-list</span>
                   <span class="tok-nv">val-list</span>
                   <span class="tok-nv">main-args</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nf">newline</span><span class="tok-p">)))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Besides <a href="#func/run-command"><code>run-command</code></a>, we also have <code>run-help</code> as a
helper to display help of a command.  <code>run-help</code> simply reads the help file of
the corresponding command and returns its content.</p>
</div>
<div class="listingblock">
<div class="title">code::run-help</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">run-help</span> <span class="tok-nv">command</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">help-file</span> <span class="tok-p">(</span><span class="tok-nf">get-path</span> <span class="tok-nv">+this-directory+</span>
                              <span class="tok-p">(</span><span class="tok-nb">format </span><span class="tok-s">&quot;commands/~a.help.txt&quot;</span>
                                      <span class="tok-nv">command</span><span class="tok-p">))])</span>
    <span class="tok-p">(</span><span class="tok-nb">displayln </span><span class="tok-p">(</span><span class="tok-nf">read-file</span> <span class="tok-nv">help-file</span><span class="tok-p">))))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_putting_all_command_things_together">4.3. Putting all command things together</h3>
<div class="paragraph">
<p>With all necessary functions implemented, module <code>command-core</code> which all
other commands have to <code>required</code> comes down to this little piece below:</p>
</div>
<div class="listingblock">
<div class="title">file::command-core.rkt</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</div></td><td class="code"><span class="tok-c1">;; include::license-header</span>

<span class="tok-c1">;; include::use-rackjure</span>

<span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-s">&quot;utils/path.rkt&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-s">&quot;utils/string.rkt&quot;</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-k">provide </span><span class="tok-nv">run-command</span>
         <span class="tok-p">(</span><span class="tok-nf">rename-out</span> <span class="tok-p">[</span><span class="tok-nf">run-help</span> <span class="tok-nv">run-command-help</span><span class="tok-p">]</span>
                     <span class="tok-p">[</span><span class="tok-nf">run-help</span> <span class="tok-nv">run-help</span><span class="tok-p">])</span>
         <span class="tok-nv">display-command</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-nv">racket/runtime-path</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-nf">define-runtime-path</span> <span class="tok-nv">+this-directory+</span> <span class="tok-s">&quot;.&quot;</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-nv">rackunit</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">display-command</span> <span class="tok-nv">title</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nb">displayln </span><span class="tok-p">(</span><span class="tok-nf">str</span> <span class="tok-s">&quot;==== &quot;</span> <span class="tok-nv">title</span> <span class="tok-s">&quot; ====&quot;</span><span class="tok-p">)))</span>

<span class="tok-c1">;; include::parse-command-args</span>

<span class="tok-c1">;; include::run-command</span>

<span class="tok-c1">;; include::run-help</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next big piece of Ulquikit is the <code>generate-html</code> command which generates
HTML documents with some default options.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generating_html">5. Generating HTML</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, let&#8217;s decide upon how this command is used:</p>
</div>
<div class="listingblock">
<div class="title">file::commands/generate-html.help.txt</div>
<div class="content">
<pre class="pygments highlight"><code class="text language-text"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</div></td><td class="code">Usage: generate-html [--from from] [--to to]

Generate HTMLs from a location containing AsciiDoc recursively.

  --from       location where AsciiDoc documents are stored, default: &quot;src&quot;
  --to         location where HTMLs are generated, default: &quot;generated-html&quot;

Examples

Generate HTMLs from src/ to generated-html/ recursively
  ulqui generate-html

or explicitly
  ulqui generate-html --from src/ --to generated-html/

Generate HTMLs from literate-source/ to generated-documents/
  ulqui generate-html \
    --from literate-source/ \
    --to generated-documents
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>As in other commands, <code>generate-html</code> also has a main function, which is named
<code>generate-html</code> as well, taking 2 optional directories: source (of AsciiDoc
documents) and destination (where HTML documents are generated), namedly
<code>:from</code> and <code>:to</code> as in <a href="#func/generate-src"><code>generate-src</code></a>.</p>
</div>
<div class="listingblock">
<div class="title">code::generate-html</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6
7
8
9</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">generate-html</span> <span class="tok-kd">#:from</span>      <span class="tok-p">[</span><span class="tok-nf">from</span> <span class="tok-s">&quot;src&quot;</span><span class="tok-p">]</span>
                       <span class="tok-kd">#:to</span>        <span class="tok-p">[</span><span class="tok-nf">to</span> <span class="tok-s">&quot;generated-html&quot;</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">from</span>  <span class="tok-p">(</span><span class="tok-nf">get-path</span> <span class="tok-nv">from</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">to</span>    <span class="tok-p">(</span><span class="tok-nf">get-path</span> <span class="tok-nv">to</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">docs</span>  <span class="tok-p">(</span><span class="tok-nf">list-all-adocs</span> <span class="tok-nv">from</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-k">parameterize </span><span class="tok-p">([</span><span class="tok-nf">current-directory</span> <span class="tok-nv">from</span><span class="tok-p">])</span>
      <span class="tok-p">(</span><span class="tok-nf">for</span> <span class="tok-p">([</span><span class="tok-nf">doc</span> <span class="tok-nv">docs</span><span class="tok-p">])</span>
        <span class="tok-p">(</span><span class="tok-nf">render-asciidoc</span> <span class="tok-nv">doc</span>
                         <span class="tok-p">(</span><span class="tok-nf">get-relative-path</span> <span class="tok-nv">to</span> <span class="tok-p">(</span><span class="tok-nf">get-output-file</span> <span class="tok-nv">doc</span><span class="tok-p">)))))))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s dig into some helpers for this function.  The first helper to notice is
<code>render-asciidoc</code>, used to build and run rendering command with AsciiDoctor.</p>
</div>
<div class="paragraph">
<p>By default, AsciiDoctor is invoked with <code>--doctype book</code>.  Customization could
be added later.</p>
</div>
<div class="listingblock">
<div class="title">code::render-asciidoc</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">asciidoctor-format-command</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nb">format </span><span class="tok-s">&quot;asciidoctor ~a -d book -o ~a&quot;</span> <span class="tok-nv">%1</span> <span class="tok-nv">%2</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">render-asciidoc</span> <span class="tok-nv">input-file</span> <span class="tok-nv">output-file</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nb">displayln </span><span class="tok-p">(</span><span class="tok-nf">str</span> <span class="tok-s">&quot;-&gt; &quot;</span> <span class="tok-nv">input-file</span> <span class="tok-s">&quot; =&gt; &quot;</span> <span class="tok-nv">output-file</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nf">system</span> <span class="tok-p">(</span><span class="tok-nf">asciidoctor-format-command</span> <span class="tok-nv">input-file</span> <span class="tok-nv">output-file</span><span class="tok-p">)))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>And last but not least, for <code>generate-html</code> to be ready, we need a function to
extract file name and replace <code>.adoc</code> extension with <code>.html</code> extension.</p>
</div>
<div class="listingblock">
<div class="title">code::get-output-file</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6
7
8</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">get-output-file</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nf">~&gt;</span> <span class="tok-p">(</span><span class="tok-nf">file-name-from-path</span> <span class="tok-nv">%</span><span class="tok-p">)</span>
      <span class="tok-nv">path-&gt;string</span>
      <span class="tok-p">(</span><span class="tok-nf">string-replace</span> <span class="tok-s">&quot;.adoc&quot;</span> <span class="tok-s">&quot;.html&quot;</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-output-file</span> <span class="tok-s">&quot;/tmp/tmp.adoc&quot;</span><span class="tok-p">)</span>   <span class="tok-s">&quot;tmp.html&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">check-equal?</span> <span class="tok-p">(</span><span class="tok-nf">get-output-file</span> <span class="tok-s">&quot;/tmp/world.adoc&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;world.html&quot;</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code for command <code>generate-html</code> is as simple as followed:</p>
</div>
<div class="listingblock">
<div class="title">file::commands/generate-html.rkt</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</div></td><td class="code"><span class="tok-c1">;; include::license-header</span>

<span class="tok-c1">;; include::use-rackjure</span>

<span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-s">&quot;../command-core.rkt&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-s">&quot;../utils/path.rkt&quot;</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-k">provide </span><span class="tok-nv">run</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">test</span>
  <span class="tok-p">(</span><span class="tok-k">require </span><span class="tok-nv">rackunit</span><span class="tok-p">))</span>

<span class="tok-c1">;; include::render-asciidoc</span>

<span class="tok-c1">;; include::get-output-file</span>

<span class="tok-c1">;; include::generate-html</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">run</span> <span class="tok-kd">#:from</span> <span class="tok-p">[</span><span class="tok-nf">from</span> <span class="tok-s">&quot;src&quot;</span><span class="tok-p">]</span>
             <span class="tok-kd">#:to</span>   <span class="tok-p">[</span><span class="tok-nf">to</span>   <span class="tok-s">&quot;generated-html&quot;</span><span class="tok-p">])</span>
  <span class="tok-p">(</span><span class="tok-nf">display-command</span> <span class="tok-s">&quot;Generating HTML&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">generate-html</span> <span class="tok-kd">#:from</span> <span class="tok-nv">from</span>
                 <span class="tok-kd">#:to</span>   <span class="tok-nv">to</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_code_ulqui_code_script">6. The <code>ulqui</code> script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we have been going through all important internal components of
Ulquikit.  What&#8217;s left to make a complete, usable application is the main
command that takes care of user interactive: the <code>ulqui</code> script.  <code>ulqui</code> is a
complete Racket module.</p>
</div>
<div class="paragraph">
<p>First and foremost, this module should be able to detect all built-in commands
residing in <code>commands/</code> directory.  This task is simple and straightforward:
find all <code>.rkt</code> files is <code>commands/</code> directory and return them as a list
without their extensions.</p>
</div>
<div class="listingblock">
<div class="title">code::ulqui/list-commands</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6
7</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">list-commands</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">command-dir</span> <span class="tok-p">(</span><span class="tok-nf">get-path</span> <span class="tok-nv">+ulqui-dir+</span> <span class="tok-s">&quot;../commands/&quot;</span><span class="tok-p">)]</span>
         <span class="tok-p">[</span><span class="tok-nf">commands</span>    <span class="tok-p">(</span><span class="tok-nf">~&gt;&gt;</span> <span class="tok-p">(</span><span class="tok-nb">directory-list </span><span class="tok-nv">command-dir</span><span class="tok-p">)</span>
                        <span class="tok-p">(</span><span class="tok-nb">map </span><span class="tok-nv">path-&gt;string</span><span class="tok-p">)</span>
                        <span class="tok-p">(</span><span class="tok-nf">filter</span> <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nf">string-ends-with?</span> <span class="tok-nv">%</span> <span class="tok-s">&quot;.rkt&quot;</span><span class="tok-p">))</span>
                        <span class="tok-p">(</span><span class="tok-nb">map </span><span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nb">regexp-replace </span><span class="tok-sr">#px&quot;\\.rkt$&quot; % &quot;&quot;</span><span class="tok-p">)))])</span>
    <span class="tok-nv">commands</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ulqui</code> might be liked, or copied indenpently, so the help of <code>ulqui</code> should
should be within in source.  Besides, whenever help is called, <code>ulqui</code> should
be able to detect all available commands and brief their helps.</p>
</div>
<div class="listingblock">
<div class="title">code::ulqui/display-help</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-p">(</span><span class="tok-nf">display-help</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">displayln</span>
   <span class="tok-nv">@str</span><span class="tok-p">{</span><span class="tok-nf">Usage:</span> <span class="tok-nv">ulqui</span> <span class="tok-nv">&lt;command&gt;</span> <span class="tok-p">[</span><span class="tok-nf">options</span><span class="tok-p">]</span> <span class="tok-o">...</span>

<span class="tok-nv">Ulquikit</span> <span class="tok-nv">is</span> <span class="tok-nv">yet</span> <span class="tok-nv">another</span> <span class="tok-nv">literate</span> <span class="tok-nv">programming</span> <span class="tok-nv">tool,</span> <span class="tok-nv">with</span> <span class="tok-nv">the</span> <span class="tok-nv">main</span> <span class="tok-nv">tasks</span> <span class="tok-nv">of</span>
<span class="tok-nv">generating</span> <span class="tok-nv">code</span> <span class="tok-k">and </span><span class="tok-nv">documentation</span> <span class="tok-nv">from</span> <span class="tok-nv">literate</span> <span class="tok-nv">source</span><span class="tok-o">.</span>

<span class="tok-nv">Supported</span> <span class="tok-nv">markup</span> <span class="tok-nv">language:</span> <span class="tok-nv">AsciiDoc</span><span class="tok-o">.</span>
<span class="tok-nv">Supported</span> <span class="tok-nv">output</span> <span class="tok-nv">formats</span> <span class="tok-nv">for</span> <span class="tok-nv">documentation:</span> <span class="tok-nv">HTML</span><span class="tok-o">.</span>

<span class="tok-nv">Available</span> <span class="tok-nv">commands:</span>

<span class="tok-p">})</span>
  <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">commands</span>   <span class="tok-p">(</span><span class="tok-nf">list-commands</span><span class="tok-p">)]</span>

         <span class="tok-p">[</span><span class="tok-nf">full-helps</span> <span class="tok-p">(</span><span class="tok-nb">map </span><span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nf">with-output-to-string</span>
                              <span class="tok-p">(</span><span class="tok-err">λ</span> <span class="tok-p">()</span>
                                <span class="tok-p">(</span><span class="tok-nf">run-help</span> <span class="tok-nv">%</span><span class="tok-p">)))</span> <span class="tok-nv">commands</span><span class="tok-p">)]</span>

         <span class="tok-p">[</span><span class="tok-nf">helps</span>      <span class="tok-p">(</span><span class="tok-nf">for/list</span> <span class="tok-p">([</span><span class="tok-nf">text</span> <span class="tok-nv">full-helps</span><span class="tok-p">])</span>
                       <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">lines</span> <span class="tok-p">(</span><span class="tok-nf">string-split</span> <span class="tok-nv">text</span> <span class="tok-s">&quot;\n&quot;</span> <span class="tok-kd">#:trim?</span> <span class="tok-no">#f</span><span class="tok-p">)]</span>
                              <span class="tok-p">[</span><span class="tok-nf">usage-omitted</span> <span class="tok-p">(</span><span class="tok-nf">dropf</span> <span class="tok-nv">lines</span>
                                                    <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nb">not </span><span class="tok-p">(</span><span class="tok-nb">string=? </span><span class="tok-nv">%</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">)))]</span>
                              <span class="tok-p">[</span><span class="tok-nf">help</span> <span class="tok-p">(</span><span class="tok-nf">takef</span> <span class="tok-p">(</span><span class="tok-nf">rest</span> <span class="tok-nv">usage-omitted</span><span class="tok-p">)</span>
                                           <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nb">not </span><span class="tok-p">(</span><span class="tok-nb">string=? </span><span class="tok-nv">%</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">)))])</span>
                         <span class="tok-p">(</span><span class="tok-nf">string-join</span> <span class="tok-nv">help</span> <span class="tok-s">&quot;\n&quot;</span><span class="tok-p">)))])</span>
    <span class="tok-p">(</span><span class="tok-nb">map </span><span class="tok-p">(</span><span class="tok-err">λ</span> <span class="tok-p">(</span><span class="tok-nf">command</span> <span class="tok-nv">help</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-nb">displayln </span><span class="tok-p">(</span><span class="tok-nf">str</span> <span class="tok-p">(</span><span class="tok-nb">format </span><span class="tok-p">(</span><span class="tok-nf">~a</span> <span class="tok-nv">command</span>
                                       <span class="tok-kd">#:width</span> <span class="tok-mi">15</span><span class="tok-p">))</span>
                           <span class="tok-s">&quot; :: &quot;</span>
                           <span class="tok-nv">help</span><span class="tok-p">)))</span>
         <span class="tok-nv">commands</span>
         <span class="tok-nv">helps</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nf">newline</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nf">displayln</span>
   <span class="tok-nv">@str</span><span class="tok-p">{</span>
<span class="tok-nv">Use</span> <span class="tok-ss">&#39;ulqui</span> <span class="tok-nv">help</span><span class="tok-o">&#39;</span> <span class="tok-k">or </span><span class="tok-ss">&#39;ulqui</span> <span class="tok-nv">--help</span><span class="tok-o">&#39;</span> <span class="tok-nv">to</span> <span class="tok-nv">bring</span> <span class="tok-nv">this</span> <span class="tok-nv">help</span><span class="tok-o">.</span>
<span class="tok-nv">Use</span> <span class="tok-ss">&#39;ulqui</span> <span class="tok-nv">help</span> <span class="tok-nv">&lt;command&gt;</span><span class="tok-o">&#39;</span> <span class="tok-k">or </span><span class="tok-ss">&#39;ulqui</span> <span class="tok-nv">&lt;command&gt;</span> <span class="tok-nv">--help</span><span class="tok-o">&#39;</span> <span class="tok-nv">to</span> <span class="tok-nv">get</span> <span class="tok-nv">help</span> <span class="tok-nv">for</span> <span class="tok-nv">a</span>
<span class="tok-nv">command</span><span class="tok-o">.</span><span class="tok-p">})</span>
  <span class="tok-p">(</span><span class="tok-nf">newline</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>One important thing to note is that <code>ulqui</code> script might be linked to and run
from different places.  Once it has been linked, Ulquikit directory is not the
directory that contains this script anymore, thus it needs to be re-calculated
and all functions which are imported need to be <code>require</code>d manually:</p>
</div>
<div class="listingblock">
<div class="title">code::ulqui/require-utils</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</div></td><td class="code"><span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">+ulqui-script-path+</span>
  <span class="tok-p">(</span><span class="tok-nb">resolve-path </span><span class="tok-p">(</span><span class="tok-nb">syntax-source </span><span class="tok-o">#</span><span class="tok-ss">&#39;here</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">+ulqui-dir+</span>
  <span class="tok-p">(</span><span class="tok-k">let-values </span><span class="tok-p">([(</span><span class="tok-nf">base</span> <span class="tok-nv">name</span> <span class="tok-nv">must-be-dir?</span><span class="tok-p">)</span>
                <span class="tok-p">(</span><span class="tok-nb">split-path </span><span class="tok-nv">+ulqui-script-path+</span><span class="tok-p">)])</span>
    <span class="tok-nv">base</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">get-ulqui-module-path</span>
  <span class="tok-o">#</span><span class="tok-err">λ</span><span class="tok-p">(</span><span class="tok-nb">build-path </span><span class="tok-nv">+ulqui-dir+</span> <span class="tok-nv">%</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">string-ends-with?</span>
 <span class="tok-p">(</span><span class="tok-nb">dynamic-require </span><span class="tok-p">(</span><span class="tok-nf">get-ulqui-module-path</span> <span class="tok-s">&quot;../utils/string.rkt&quot;</span><span class="tok-p">)</span>
                  <span class="tok-ss">&#39;string-ends-with?</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">get-path</span>
  <span class="tok-p">(</span><span class="tok-nb">dynamic-require </span><span class="tok-p">(</span><span class="tok-nf">get-ulqui-module-path</span> <span class="tok-s">&quot;../utils/path.rkt&quot;</span><span class="tok-p">)</span>
                   <span class="tok-ss">&#39;get-path</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">run-help</span>
  <span class="tok-p">(</span><span class="tok-nb">dynamic-require </span><span class="tok-p">(</span><span class="tok-nf">get-ulqui-module-path</span> <span class="tok-s">&quot;../command-core.rkt&quot;</span><span class="tok-p">)</span>
                   <span class="tok-ss">&#39;run-help</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define </span><span class="tok-nv">run-command</span>
 <span class="tok-p">(</span><span class="tok-nb">dynamic-require </span><span class="tok-p">(</span><span class="tok-nf">get-ulqui-module-path</span> <span class="tok-s">&quot;../command-core.rkt&quot;</span><span class="tok-p">)</span>
                  <span class="tok-ss">&#39;run-command</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Putting all things mentioned above together, we have the following <code>ulqui</code>
script.  To make the script as practical as possible, certain things should be
clarified:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By default, running <code>ulqui</code> alone usually means users need some help.  Thus
running <code>ulqui</code> is equivalent to running <code>ulqui help</code>.</p>
</li>
<li>
<p>If users execute invalid command, this script also fallbacks to <code>ulqui
help</code> with a small error message.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">file::bin/ulqui</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</div></td><td class="code"><span class="tok-o">#</span><span class="tok-nv">!/usr/bin/env</span> <span class="tok-nv">racket</span>

<span class="tok-c1">;; include::license-header</span>

<span class="tok-kn">#lang at-exp</span> <span class="tok-nv">rackjure</span>

<span class="tok-p">(</span><span class="tok-nf">current-curly-dict</span> <span class="tok-nv">hash</span><span class="tok-p">)</span>

<span class="tok-c1">;; include::ulqui/require-utils</span>

<span class="tok-c1">;; include::ulqui/list-commands</span>

<span class="tok-c1">;; include::ulqui/display-help</span>

<span class="tok-p">(</span><span class="tok-nf">module+</span> <span class="tok-nv">main</span>
  <span class="tok-p">(</span><span class="tok-nf">void</span>
   <span class="tok-p">(</span><span class="tok-k">let* </span><span class="tok-p">([</span><span class="tok-nf">command-list</span> <span class="tok-p">(</span><span class="tok-nf">list-commands</span><span class="tok-p">)]</span>
          <span class="tok-p">[</span><span class="tok-nf">arguments</span> <span class="tok-p">(</span><span class="tok-nb">vector-&gt;list </span><span class="tok-p">(</span><span class="tok-nf">current-command-line-arguments</span><span class="tok-p">))]</span>
          <span class="tok-p">[</span><span class="tok-nf">arg-list</span>  <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">empty?</span> <span class="tok-nv">arguments</span><span class="tok-p">)</span>
                         <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;help&quot;</span><span class="tok-p">)</span>
                         <span class="tok-nv">arguments</span><span class="tok-p">)]</span>
          <span class="tok-p">[</span><span class="tok-nf">command</span>   <span class="tok-p">(</span><span class="tok-nf">first</span> <span class="tok-nv">arg-list</span><span class="tok-p">)]</span>
          <span class="tok-p">[</span><span class="tok-nf">args</span>      <span class="tok-p">(</span><span class="tok-nf">rest</span> <span class="tok-nv">arg-list</span><span class="tok-p">)])</span>
     <span class="tok-p">(</span><span class="tok-k">cond </span><span class="tok-p">[(</span><span class="tok-nb">string=? </span><span class="tok-s">&quot;help&quot;</span> <span class="tok-nv">command</span><span class="tok-p">)</span>
            <span class="tok-p">(</span><span class="tok-k">if </span><span class="tok-p">(</span><span class="tok-nf">empty?</span> <span class="tok-nv">args</span><span class="tok-p">)</span>
                <span class="tok-p">(</span><span class="tok-nf">display-help</span><span class="tok-p">)</span>
                <span class="tok-p">(</span><span class="tok-nf">run-help</span> <span class="tok-p">(</span><span class="tok-nf">first</span> <span class="tok-nv">args</span><span class="tok-p">)))]</span>
           <span class="tok-p">[(</span><span class="tok-nb">not </span><span class="tok-p">(</span><span class="tok-nb">member </span><span class="tok-nv">command</span> <span class="tok-nv">command-list</span><span class="tok-p">))</span>
            <span class="tok-p">(</span><span class="tok-nb">displayln </span><span class="tok-p">(</span><span class="tok-nf">str</span> <span class="tok-s">&quot;-&gt; Invalid command &quot;</span> <span class="tok-nv">command</span> <span class="tok-s">&quot;.\n&quot;</span><span class="tok-p">))</span>
            <span class="tok-p">(</span><span class="tok-nf">display-help</span><span class="tok-p">)]</span>
           <span class="tok-p">[</span><span class="tok-nf">else</span>
            <span class="tok-p">(</span><span class="tok-nf">run-command</span> <span class="tok-nv">command</span> <span class="tok-nv">args</span><span class="tok-p">)]))))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_packaging">7. Packaging</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_misc">8. Misc</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">code::use-rackjure</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3</div></td><td class="code"><span class="tok-kn">#lang rackjure</span>

<span class="tok-p">(</span><span class="tok-nf">current-curly-dict</span> <span class="tok-nv">hash</span><span class="tok-p">)</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_license_header">9. License header</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Of course, since Ulquikit is distributed under the terms of GPLv3, the license
header is necessary.</p>
</div>
<div class="listingblock">
<div class="title">code::license-header</div>
<div class="content">
<pre class="pygments highlight"><code class="racket language-racket"><span class="tok-c1">;;</span>
<span class="tok-c1">;; This file is part of Ulquikit project.</span>
<span class="tok-c1">;;</span>
<span class="tok-c1">;; Copyright (C) 2014 Nguyễn Hà Dương &lt;cmpitg AT gmailDOTcom&gt;</span>
<span class="tok-c1">;;</span>
<span class="tok-c1">;; Ulquikit is free software: you can redistribute it and/or modify it under</span>
<span class="tok-c1">;; the terms of the GNU General Public License as published by the Free</span>
<span class="tok-c1">;; Software Foundation, either version 3 of the License, or (at your option)</span>
<span class="tok-c1">;; any later version.</span>
<span class="tok-c1">;;</span>
<span class="tok-c1">;; Ulquikit is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="tok-c1">;; WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="tok-c1">;; FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more</span>
<span class="tok-c1">;; details.</span>
<span class="tok-c1">;;</span>
<span class="tok-c1">;; You should have received a copy of the GNU General Public License along</span>
<span class="tok-c1">;; with Ulquikit.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="tok-c1">;;</span>
</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extras">10. Extras</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_utility_functions">11. Utility functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>See <a href="Utilities.html">Utilities</a>.</p>
</div>
<div class="sect2">
<h3 id="_command_list">11.1. Command list</h3>

</div>
<div class="sect2">
<h3 id="_story_how_the_racket_version_of_ulquikit_was_actually_developed">11.2. Story: How the Racket version of Ulquikit was actually developed</h3>

</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2014-08-04 22:00:22 ICT
</div>
</div>
</body>
</html>