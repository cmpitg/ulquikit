= Utilities for Ulquikit
:Author: Ha-Duong Nguyen (cmpitg)
:Email: <cmpitg@gmail.com>
:toc: left
:toclevels: 4
:numbered:
:icons: font
:source-highlighter: pygments
:pygments-css: class
:website: http://reference-error.org/projects/ulquikit

Below is the list of utilities/helpers that Ulquikit makes use of.  All of
them are written with simplicity and reusability in mind, while maintaining
relative good performance.

.file::utils.lisp
[source,lisp,linenums]
----
;; include::license-header

(defpackage #:ulqui/utils
  (:use :cl
        :alexandria)
  (:export #:join-lines
           #:->keyword
           #:->string
           #:sethash
           #:read-file))

(defpackage #:ulqui/utils-tests
  (:use :cl
        :lisp-unit
        :ulqui/utils)
  (:import-from :alexandria :when-let))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Implementation
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(in-package #:ulqui/utils)

(defun join-lines (lines)
  "Joins a list of strings with newline as separator."
  (declare (list lines))
  (the string (format nil "~{~A~^~%~}" lines)))

(in-package #:ulqui/utils-tests)

(define-test test-join-lines
  (assert-equal "" (join-lines '()))
  (assert-equal "a" (join-lines '("a")))
  (assert-equal (format nil "a~%b") (join-lines '("a" "b")))
  (assert-equal (format nil "a~%b~%") (join-lines '("a" "b" ""))))

;; (run-tests '(test-join-lines))

(in-package #:ulqui/utils)

(defun ->keyword (val)
  "Converts a symbol or string into keyword."
  (declare ((or symbol string) val))
  (the keyword (etypecase val
                 (keyword val)
                 (symbol (intern (string-upcase (symbol-name val)) 'keyword))
                 (string (intern (string-upcase val) 'keyword)))))

(defun ->string (val)
  "Converts a symbol or keyword into string."
  (declare ((or symbol string) val))
  (the string (etypecase val
                (string val)
                ((or symbol keyword) (string-downcase (symbol-name val))))))

(in-package #:ulqui/utils)

(defun sethash (key hash value &rest args)
  "Conveniently combining `setf' and `gethash'.

`\(setf \(gethash o hash\) obj\)' ⬄ `\(sethash o hash obj\)'
`\(setf \(gethash o hash\) obj
      \(gethash a hash\) abj\)'
⬄
`\(sethash o hash obj
         a hash abj\)'
"
  (declare (hash-table hash))
  (unless (zerop (mod (length args) 3))
    (error "number of arguments must be divisible by 3."))

  (setf (gethash key hash) value)

  (unless (null args)
    (apply #'sethash (first args) (second args) (third args) (subseq args 3))))

(in-package #:ulqui/utils-tests)

(define-test test-macro-sethash
  (let ((hash (make-hash-table)))
    (sethash :first hash "hello")
    (sethash :second hash "world")
    (assert-equal "hello" (gethash :first hash))
    (assert-equal "world" (gethash :second hash))))

;; (run-tests '(test-macro-sethash))

(in-package #:ulqui/utils)

(defun read-file (path)
  "Reads a file as UTF-8 encoded string."
  (declare ((or string pathname) path))
  (with-open-file (in path :element-type '(unsigned-byte 8))
    (read-utf-8-string in :stop-at-eof t)))

----
