<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<meta name="author" content="Ha-Duong Nguyen">
<title>Ulquikit</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments, .listingblock .pygments code { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Ulquikit</h1>
<div class="details">
<span id="author" class="author">Ha-Duong Nguyen</span><br>
<span id="email" class="email">&lt;<a href="mailto:cmpitg@gmail.com">cmpitg@gmail.com</a>&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_terminology">1. Terminology</a></li>
<li><a href="#_utilities">2. Utilities</a></li>
<li><a href="#_interfaces">3. Interfaces</a></li>
<li><a href="#_extracting_and_including_snippets">4. Extracting and including snippets</a>
<ul class="sectlevel2">
<li><a href="#_extracting_snippets">4.1. Extracting snippets</a>
<ul class="sectlevel3">
<li><a href="#_retrieving_snippet_content">4.1.1. Retrieving snippet content</a></li>
<li><a href="#_creating_a_snippet">4.1.2. Creating a snippet</a></li>
<li><a href="#_extracting_snippets_from_file">4.1.3. Extracting snippets from file</a>
<ul class="sectlevel4">
<li><a href="#_retrieving_all_asciidoc_documents_in_a_directory">Retrieving all ASCIIDoc documents in a directory</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_including_snippets_into_each_other_with_code_include_snippet_code">4.2. Including snippets into each other with <code>include-snippet!</code></a></li>
<li><a href="#_generating_source_code">4.3. Generating source code</a></li>
</ul>
</li>
<li><a href="#_anatomy_of_a_ulquikit_command">5. Anatomy of a Ulquikit command</a>
<ul class="sectlevel2">
<li><a href="#_parsing_command_line_arguments_with_code_parse_cmd_args_code">5.1. Parsing command line arguments with <code>parse-cmd-args</code></a></li>
<li><a href="#_calling_corresponding_command">5.2. Calling corresponding command</a></li>
<li><a href="#_putting_all_command_helpers_together">5.3. Putting all command helpers together</a></li>
</ul>
</li>
<li><a href="#_generating_html">6. Generating HTML</a>
<ul class="sectlevel2">
<li><a href="#_the_main_function_code_generate_html_code">6.1. The main function: <code>generate-html</code></a></li>
<li><a href="#_rendering_an_asciidoc_document_to_html">6.2. Rendering an ASCIIDoc document to HTML</a></li>
</ul>
</li>
<li><a href="#_the_asdf_system_definition">7. The ASDF system definition</a></li>
<li><a href="#_the_code_ulqui_code_executable">8. The <code>ulqui</code> executable</a>
<ul class="sectlevel2">
<li><a href="#_general_help">8.1. General help</a></li>
<li><a href="#_the_code_main_code_function">8.2. The <code>main</code> function</a></li>
<li><a href="#_the_code_version_code_command">8.3. The <code>version</code> command</a></li>
</ul>
</li>
<li><a href="#_managing_ulquikit_source_code">9. Managing Ulquikit source code</a>
<ul class="sectlevel2">
<li><a href="#_generating_source_code_and_html_documentation">9.1. Generating source code and HTML documentation</a></li>
<li><a href="#_update_self">9.2. Update self</a></li>
<li><a href="#_mark_current_source_as_stable">9.3. Mark current source as stable</a></li>
<li><a href="#_release">9.4. Release</a></li>
<li><a href="#_run_current_dev_version_of_ulquikit">9.5. Run current dev version of Ulquikit</a></li>
<li><a href="#_run_tests">9.6. Run tests</a></li>
<li><a href="#_clean_up">9.7. Clean up</a></li>
<li><a href="#_help">9.8. Help</a></li>
<li><a href="#_combine_into_schiffer">9.9. Combine into schiffer</a></li>
</ul>
</li>
<li><a href="#_updating_ulquikit">10. Updating Ulquikit</a>
<ul class="sectlevel2">
<li><a href="#_retrieve_latest_version">10.1. Retrieve latest version</a></li>
<li><a href="#_download_and_replace_ulquikit">10.2. Download and replace Ulquikit</a>
<ul class="sectlevel3">
<li><a href="#_construct_download_url">10.2.1. Construct download URL</a></li>
<li><a href="#_download_and_unzip">10.2.2. Download and unzip</a></li>
</ul>
</li>
<li><a href="#_the_update_command">10.3. The update command</a></li>
<li><a href="#_quick_installation_script">10.4. Quick installation script</a>
<ul class="sectlevel3">
<li><a href="#_make_sure_racket_is_installed">10.4.1. Make sure Racket is installed</a></li>
<li><a href="#_install_ruby_1_9_using_rvm_if_necessary">10.4.2. Install Ruby 1.9 (using RVM) if necessary</a></li>
<li><a href="#_install_asciidoctor_if_necessary">10.4.3. Install AsciiDoctor if necessary</a></li>
<li><a href="#_install_rackjure_if_necessary">10.4.4. Install Rackjure if necessary</a></li>
<li><a href="#_install_ulquikit">10.4.5. Install Ulquikit</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_license_header">11. License header</a></li>
<li><a href="#_extras">12. Extras</a>
<ul class="sectlevel2">
<li><a href="#_command_list">12.1. Command list</a></li>
<li><a href="#_story_how_the_racket_version_of_ulquikit_was_actually_developed">12.2. Story: How the Racket version of Ulquikit was actually developed</a></li>
<li><a href="#_enhancing_narrow_region_functionality_in_emacs">12.3. Enhancing narrow-region functionality in Emacs</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Current version:</p>
</div>
<div class="listingblock">
<div class="title">code::declare-version</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defvar</span> <span class="tok-vg">*ulquikit-version*</span> <span class="tok-s">&quot;2.0.0&quot;</span><span class="tok-p">)</span>
</td></tr></table></code></pre>
</div>
</div>
<hr>
<div class="paragraph">
<p>Ulquikit is an extensible literate programming tool supporting multiple markup
languages with user-friendly interface.</p>
</div>
<div class="paragraph">
<p>Ulquikit was originally written in Racket.  The current version is a complete
rewrite in Common Lisp for better startup time and deployment.</p>
</div>
<div class="paragraph">
<p>This document is the literate source code Ulquikit itself.  TODO: Reason why
Ulquikit exists.</p>
</div>
<div class="paragraph">
<p>To build Ulquikit, the following dependencies are required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ruby 2.1+ with</p>
<div class="ulist">
<ul>
<li>
<p><a href="http://asciidoctor.org">AsciiDoctor</a>: AsciiDoc renderer</p>
</li>
<li>
<p><a href="https://github.com/tmm1/pygments.rb">pygments.rb</a>: Syntax highlighter</p>
</li>
</ul>
</div>
</li>
<li>
<p>An ANSI-compliant Common Lisp implementation, preferably
<a href="http://www.sbcl.org">SBCL</a>, with</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://common-lisp.net/project/asdf">ASDF 3</a>: Build tool</p>
</li>
<li>
<p><a href="https://www.quicklisp.org/beta/">Quicklisp</a>: Library manager</p>
</li>
<li>
<p><a href="https://github.com/OdonataResearchLLC/lisp-unit">lisp-unit</a>: Unit testing
framework, designed and implemented with simplicity of use in mind.</p>
</li>
<li>
<p><a href="https://github.com/keithj/alexandria">Alexandria</a>: Collection of Common Lisp
utilities</p>
</li>
<li>
<p><a href="https://github.com/sharplispers/split-sequence">split-sequence</a>: Utility for
sequence splitting</p>
</li>
<li>
<p><a href="http://weitz.de/cl-ppcre/">CL-PPCRE</a>: Portable Perl-compatible regular
expressions library</p>
</li>
<li>
<p><a href="https://common-lisp.net/project/trivial-utf-8/">Trivial UTF-8</a>: UTF-8
library</p>
</li>
<li>
<p><a href="https://common-lisp.net/project/iterate/">Iterate</a>: Iteration construct
library</p>
</li>
<li>
<p><a href="https://github.com/sionescu/bordeaux-threads">bordeaux-threads</a>: Portable
threading concurrency library.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>To install them, please consult their official documentations.  On my setup, I
use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Official <a href="http://www.sbcl.org/platform-table.html">SBCL binary</a>.</p>
</li>
<li>
<p>Ruby 2.3.3p222 with <a href="https://rvm.io">RVM</a> (Ruby Version Manager)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>TODO: quick installation</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_terminology">1. Terminology</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>A <strong>code block</strong> is an AsciiDoc/Markdown/&#8230;&#8203; code block.</p>
</li>
<li>
<p>A <strong>snippet</strong> is a code block with Ulquikit-defined title.  By default, a code
block title that starts with <code>file::</code> and <code>code::</code> defines a <em>file snippet</em>
and <em>code snippet</em>, respectively:</p>
<div class="ulist">
<ul>
<li>
<p>A <strong>file snippet</strong> is a snippet corresponding to a file.</p>
</li>
<li>
<p>A <strong>code snippet</strong> is a snippet that can be included into other snippets.</p>
</li>
</ul>
</div>
</li>
<li>
<p>An <strong>include directive</strong> is a line of code that:</p>
<div class="ulist">
<ul>
<li>
<p>belongs to a snippet</p>
</li>
<li>
<p>follows the <code>xx include::some-snippet-name</code> format, where <code>xx</code> are two
identical characters denoting a comment.  Ulquikit can recogize the
following comment types:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>// include::some-snippet-name
;; include::some-snippet-name
## include::some-snippet-name
-- include::some-snippet-name
&lt;!-- include::some-snippet-name -\-&gt;
/* include::some-snippet-name */</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_utilities">2. Utilities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ulquikit aims to be simple and straigtforward, easy to hack and port.  The
implementation in this document leverages a lot of utilities written in the
<a href="Ulquikit-Utils.html">Ulquikit Utils</a> document.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_interfaces">3. Interfaces</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before going into any detail, let us define the interface that Ulquikit uses
to interact with the outside world.</p>
</div>
<div class="paragraph">
<p>Essentially, Ulquikit consists of a collection of Common Lisp packages.  The
main package is <code>ulquikit</code>, along comes its test counterpart <code>ulquikit-tests</code>.
For testing, I decide to use
<a href="https://github.com/OdonataResearchLLC/lisp-unit">lisp-unit</a> since it has very
nice interface and helpful messages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Prior to <code>lisp-unit</code>, I have tried
<a href="https://github.com/capitaomorte/fiasco">Fiasco</a> with little success.  The API
is nice but inflexible.  There is no easy way to remove or redefine tests/test
packages.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">file::ulquikit.lisp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</div></td><td class="code"><span></span><span class="tok-c1">;; include::license-header</span>

<span class="tok-p">(</span><span class="tok-nb">defpackage</span> <span class="tok-ss">#:ulquikit</span>
  <span class="tok-p">(</span><span class="tok-ss">:use</span> <span class="tok-ss">:cl</span>
        <span class="tok-ss">:alexandria</span>
        <span class="tok-ss">:split-sequence</span>
        <span class="tok-ss">:cl-ppcre</span>
        <span class="tok-ss">:iterate</span>
        <span class="tok-ss">:ulqui/utils</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-ss">:export</span> <span class="tok-vg">*ulquikit-version*</span>

           <span class="tok-ss">#:generate-src</span>
           <span class="tok-ss">#:generate-html</span>

           <span class="tok-ss">#:snippet-&gt;string</span>
           <span class="tok-ss">#:sethash</span>
           <span class="tok-ss">#:file?</span>

           <span class="tok-ss">#:snippet</span>
           <span class="tok-ss">#:create-snippet</span>
           <span class="tok-ss">#:extract-snippets</span>
           <span class="tok-ss">#:extract-snippets-from-file</span>
           <span class="tok-ss">#:collect-snippet</span>
           <span class="tok-ss">#:list-asciidocs</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">defpackage</span> <span class="tok-ss">#:ulquikit-tests</span>
  <span class="tok-p">(</span><span class="tok-ss">:use</span> <span class="tok-ss">:cl</span> <span class="tok-ss">:ulquikit</span> <span class="tok-ss">:cl-ppcre</span> <span class="tok-ss">:lisp-unit</span> <span class="tok-ss">:iterate</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-c1">;; Print failure details by default</span>
<span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-vg">*print-failures*</span> <span class="tok-no">t</span><span class="tok-p">)</span>

<span class="tok-c1">;; include::declare-version</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="tok-c1">;; Main</span>
<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-c1">;; include::snippet-struct</span>

<span class="tok-c1">;; include::snippets-struct</span>

<span class="tok-c1">;; include::create-snippet</span>

<span class="tok-c1">;; include::get-snippet-content</span>

<span class="tok-c1">;; include::extract-snippets</span>

<span class="tok-c1">;; include::extract-snippets-from-file</span>

<span class="tok-c1">;; include::include-snippet</span>

<span class="tok-c1">;; include::include-snippets</span>

<span class="tok-c1">;; include::include-file-snippets</span>

<span class="tok-c1">;; include::render-asciidoc</span>

<span class="tok-c1">;; include::list-asciidocs</span>

<span class="tok-c1">;; include::generate-src</span>

<span class="tok-c1">;; include::generate-html</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extracting_and_including_snippets">4. Extracting and including snippets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ulquikit works by</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>searching for all AsciiDoc documents inside directory, or using a single
AsciiDoc document,</p>
</li>
<li>
<p>building a database of snippets,</p>
</li>
<li>
<p>and including them into each other if necessary</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And provides user with operations to manage source code and documentation.</p>
</div>
<div class="paragraph">
<p>In a high-level perspective, the basic functionality of a literate programming
tool is to support source code and documentation generation.  Thus, we define
the following functions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#extract-snippets-from-file"><code>extract-snippets-from-file</code></a></p>
</li>
<li>
<p><a href="#func/include-snippet"><code>include-snippet!</code></a>, used as a building block to
<a href="#section/include-snippets">include snippets</a> into each other later on.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_extracting_snippets">4.1. Extracting snippets</h3>
<div class="paragraph">
<p>First, we need to decide a data structure to store a snippet.  This is very
important because every change made to this would affect the code later on.</p>
</div>
<div class="paragraph">
<p>Each snippet is a struct with the following alist representation:</p>
</div>
<div class="paragraph">
<p><a id="snippet-format"></a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><span class="tok-p">((</span><span class="tok-ss">:type</span>       <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-nv">snippet-type</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
 <span class="tok-p">(</span><span class="tok-ss">:name</span>       <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-nv">snippet-name</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
 <span class="tok-p">(</span><span class="tok-ss">:linenum</span>    <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-nv">line-number</span><span class="tok-p">)</span>   <i class="conum" data-value="3"></i><b>(3)</b>
 <span class="tok-p">(</span><span class="tok-ss">:lines</span>      <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-nv">snippet-lines</span><span class="tok-p">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
 <span class="tok-p">(</span><span class="tok-ss">:processed?</span> <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-nv">processed?</span><span class="tok-p">))</span> <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>is either <code>:file</code> or <code>:code</code>, corresponding to a file or a code snippet</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>is the name of the snippet; e.g. snippet with title <code>file::something</code> has
<code>something</code> as its name.  Snippet name is a <em>string</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>is the line number from the literate source code where the snippet is
extracted.  The line number is an integer.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>is the content of the snippet as a list of lines (list of strings).</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>determines whether this snippet has been processed; when created for the
first time, <code>:processed?</code> is always <code>nil</code>.  It is only changed to <code>t</code> after
the snippet is passed through <a href="#func/include-snippet">include-snippet!</a></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the above alist representation, we have the <code>snippet</code> struct implemented
as followed:</p>
</div>
<div class="listingblock">
<div class="title">code::snippet-struct</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6
7
8</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defstruct</span> <span class="tok-p">(</span><span class="tok-nv">snippet</span> <span class="tok-p">(</span><span class="tok-ss">:conc-name</span> <span class="tok-nv">snippet/</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">type</span> <span class="tok-ss">:code</span>     <span class="tok-ss">:type</span> <span class="tok-kt">keyword</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">name</span> <span class="tok-s">&quot;&quot;</span>        <span class="tok-ss">:type</span> <span class="tok-nb">string</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">linenum</span> <span class="tok-mi">0</span>      <span class="tok-ss">:type</span> <span class="tok-nc">integer</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">lines</span> <span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-p">)</span>   <span class="tok-ss">:type</span> <span class="tok-nb">list</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">processed?</span> <span class="tok-no">nil</span> <span class="tok-ss">:type</span> <span class="tok-kt">boolean</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For maintainability and extensiblity reasons, snippets should never
be created directly with <code>make-snippet</code>.  Instead, they should be created with
the <a href="#create-snippet"><code>create-snippet</code></a> helper.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_retrieving_snippet_content">4.1.1. Retrieving snippet content</h4>
<div class="paragraph">
<p>Since a snippet stores a list of lines as its content, it&#8217;d be convenient to
have a helper that joins those lines into a complete string:</p>
</div>
<div class="listingblock">
<div class="title">code::get-snippet-content</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">get-snippet-content</span> <span class="tok-p">(</span><span class="tok-nv">snippet</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Returns the content of a snippet as string.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nv">snippet</span> <span class="tok-nv">snippet</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">join-lines</span> <span class="tok-p">(</span><span class="tok-nv">snippet/lines</span> <span class="tok-nv">snippet</span><span class="tok-p">)))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="create-snippet"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_snippet">4.1.2. Creating a snippet</h4>
<div class="paragraph">
<p><code>create-snippet</code> is simply implemented as followed:</p>
</div>
<div class="listingblock">
<div class="title">code::create-snippet</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">create-snippet</span> <span class="tok-p">(</span><span class="tok-k">&amp;key</span> <span class="tok-p">(</span><span class="tok-k">type</span> <span class="tok-ss">:code</span><span class="tok-p">)</span>
                         <span class="tok-p">(</span><span class="tok-nv">name</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
                         <span class="tok-p">(</span><span class="tok-nv">linenum</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
                         <span class="tok-p">(</span><span class="tok-nv">lines</span> <span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-p">))</span>
                         <span class="tok-p">(</span><span class="tok-nv">processed?</span> <span class="tok-no">nil</span><span class="tok-p">))</span>
  <span class="tok-s">&quot;Helper to create snippet.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nc">symbol</span><span class="tok-p">)</span> <span class="tok-k">type</span> <span class="tok-nv">name</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">list</span><span class="tok-p">)</span> <span class="tok-nv">lines</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-nc">integer</span> <span class="tok-nv">linenum</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-kt">boolean</span> <span class="tok-nv">processed?</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-k">type</span> <span class="tok-p">(</span><span class="tok-nv">-&gt;keyword</span> <span class="tok-k">type</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nv">name</span> <span class="tok-p">(</span><span class="tok-nv">-&gt;string</span> <span class="tok-nv">name</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nv">lines</span> <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nb">stringp</span> <span class="tok-nv">lines</span><span class="tok-p">)</span>
                   <span class="tok-p">(</span><span class="tok-nv">split-sequence</span> <span class="tok-sc">#\Newline</span> <span class="tok-nv">lines</span><span class="tok-p">)</span>
                 <span class="tok-nv">lines</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-nv">snippet</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:type</span> <span class="tok-k">type</span>
                               <span class="tok-ss">:name</span> <span class="tok-nv">name</span>
                               <span class="tok-ss">:linenum</span> <span class="tok-nv">linenum</span>
                               <span class="tok-ss">:lines</span> <span class="tok-nv">lines</span>
                               <span class="tok-ss">:processed?</span> <span class="tok-nv">processed?</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-snippet-creation</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equalp</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:type</span> <span class="tok-ss">:file</span>
                               <span class="tok-ss">:name</span> <span class="tok-s">&quot;hello-world&quot;</span>
                               <span class="tok-ss">:linenum</span> <span class="tok-mi">10</span>
                               <span class="tok-ss">:lines</span> <span class="tok-p">(</span><span class="tok-s">&quot;Hmm&quot;</span><span class="tok-p">)</span>
                               <span class="tok-ss">:processed?</span> <span class="tok-no">nil</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nv">create-snippet</span> <span class="tok-ss">:type</span> <span class="tok-ss">:file</span>
                                 <span class="tok-ss">:name</span> <span class="tok-ss">&#39;hello-world</span>
                                 <span class="tok-ss">:linenum</span> <span class="tok-mi">10</span>
                                 <span class="tok-ss">:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Hmm&quot;</span><span class="tok-p">)))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equalp</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:type</span> <span class="tok-ss">:string</span>
                               <span class="tok-ss">:name</span> <span class="tok-s">&quot;string&quot;</span>
                               <span class="tok-ss">:linenum</span> <span class="tok-mi">100</span>
                               <span class="tok-ss">:lines</span> <span class="tok-p">(</span><span class="tok-s">&quot;string&quot;</span><span class="tok-p">)</span>
                               <span class="tok-ss">:processed?</span> <span class="tok-no">t</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nv">create-snippet</span> <span class="tok-ss">:type</span> <span class="tok-s">&quot;string&quot;</span>
                                 <span class="tok-ss">:name</span> <span class="tok-s">&quot;string&quot;</span>
                                 <span class="tok-ss">:linenum</span> <span class="tok-mi">100</span>
                                 <span class="tok-ss">:lines</span> <span class="tok-s">&quot;string&quot;</span>
                                 <span class="tok-ss">:processed?</span> <span class="tok-no">t</span><span class="tok-p">)))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Those are all snippet helpers we need.  Let&#8217;s move on to
<code>extract-snippets-from-file</code>.</p>
</div>
<div class="paragraph">
<p><a id="extract-snippets-from-file"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_extracting_snippets_from_file">4.1.3. Extracting snippets from file</h4>
<div class="paragraph">
<p>To extract snippets from a file, we need to determine whether <em>a line in a
code block</em> belongs to a <em>code snippet</em>, or <em>file snippet</em>, or just a line,
then extract the content of the code block.  There are 3 types of code block
we have to deal with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>code snippet</em> has the following format:</p>
<div class="listingblock">
<div class="content">
<pre>.code::code-block-title    <i class="conum" data-value="1"></i><b>(1)</b>
[source]                   <i class="conum" data-value="2"></i><b>(2)</b>
----                       <i class="conum" data-value="3"></i><b>(3)</b>
Code block content
----                       <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[source]                    <i class="conum" data-value="2"></i><b>(2)</b>
.code::code-block-title     <i class="conum" data-value="1"></i><b>(1)</b>
----                        <i class="conum" data-value="3"></i><b>(3)</b>
Code block content
----                        <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
</li>
<li>
<p>A <em>file snippet</em> shares the same structure as a <em>code snippet</em>:</p>
<div class="listingblock">
<div class="content">
<pre>.file::code-block-title     <i class="conum" data-value="1"></i><b>(1)</b>
[source]                    <i class="conum" data-value="2"></i><b>(2)</b>
----                        <i class="conum" data-value="3"></i><b>(3)</b>
Code block content
----                        <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[source]                    <i class="conum" data-value="2"></i><b>(2)</b>
.file::code-block-title     <i class="conum" data-value="1"></i><b>(1)</b>
----                        <i class="conum" data-value="3"></i><b>(3)</b>
Code block content
----                        <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
</li>
<li>
<p>A non-snippet code block is any block without <code>code::&#8230;&#8203;</code> and <code>file::&#8230;&#8203;</code> as
its title:</p>
<div class="listingblock">
<div class="content">
<pre>[source]                    <i class="conum" data-value="2"></i><b>(2)</b>
----                        <i class="conum" data-value="3"></i><b>(3)</b>
Code block content
----                        <i class="conum" data-value="4"></i><b>(4)</b>

....                        <i class="conum" data-value="3"></i><b>(3)</b>
This is a literal block
....                        <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>block title</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>block type</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>opening block delimiter</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>closing block delimiter</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As we can clearly see from the 3 examples, <em>code snippets</em> and <em>file snippets</em>
could be determined by checking 2 lines from the opening block delimiter
backward to see if it starts with <code>.file::</code> or <code>.code::</code>.  Everything between
the 2 delimiters is stored as content of the snippet.</p>
</div>
<div class="paragraph">
<p>Before diving into <code>extract-snippets-from-file</code>, let us define a data
structure for storing all snippets:</p>
</div>
<div class="listingblock">
<div class="title">code::snippets-struct</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defstruct</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span>
             <span class="tok-p">(</span><span class="tok-ss">:conc-name</span> <span class="tok-nv">snippets/</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">file</span> <span class="tok-p">(</span><span class="tok-nb">make-hash-table</span> <span class="tok-ss">:test</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">equal</span><span class="tok-p">)</span> <span class="tok-ss">:type</span> <span class="tok-nc">hash-table</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">code</span> <span class="tok-p">(</span><span class="tok-nb">make-hash-table</span> <span class="tok-ss">:test</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">equal</span><span class="tok-p">)</span> <span class="tok-ss">:type</span> <span class="tok-nc">hash-table</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>We have the following algorithm for <code>extract-snippets-from-file</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read the content of the file;</p>
</li>
<li>
<p>Break the content into lines, preserving line numbers;</p>
</li>
<li>
<p>For each line:</p>
<div class="ulist">
<ul>
<li>
<p>If we&#8217;re already inside a snippet:</p>
<div class="ulist">
<ul>
<li>
<p>Complete a snippet and add it to snippet list if current line is a block
delimiter (i.e. <code>----</code>)</p>
</li>
<li>
<p>Add current line to the current snippet&#8217;s content if current line is not a
block delimiter</p>
</li>
</ul>
</div>
</li>
<li>
<p>If we&#8217;re outside a snippet, we only care if current line is a block
delimiter (i.e. <code>----</code>):</p>
<div class="ulist">
<ul>
<li>
<p>If this block has a title that marks the beginning of a snippet (i.e. the
2<sup>nd</sup> previous line starts with <code>.file::</code> or <code>.code::</code>), extract snippet
name and add a new snippet.  Otherwise</p>
</li>
<li>
<p>If this block does not mark the beginning of a snippet, ignore it.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">code::extract-snippets-from-file</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">extract-snippets-from-file</span> <span class="tok-p">(</span><span class="tok-nv">path</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Extracts snippets from a file and return a `snippets&#39; struct.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span> <span class="tok-nv">path</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">text</span> <span class="tok-p">(</span><span class="tok-nb">string-trim</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-sc">#\Space</span> <span class="tok-sc">#\Newline</span> <span class="tok-sc">#\e</span> <span class="tok-sc">#\t</span> <span class="tok-sc">#\m</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">read-file</span> <span class="tok-nv">path</span><span class="tok-p">)))</span>
         <span class="tok-p">(</span><span class="tok-nv">lines</span> <span class="tok-p">(</span><span class="tok-nv">split-sequence</span> <span class="tok-sc">#\Newline</span> <span class="tok-nv">text</span><span class="tok-p">))</span>

         <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-nv">make-snippets</span><span class="tok-p">))</span>

         <span class="tok-p">(</span><span class="tok-nv">prev-prev-line</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
         <span class="tok-p">(</span><span class="tok-nv">prev-line</span>      <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
         <span class="tok-p">(</span><span class="tok-nv">linenum</span>        <span class="tok-mi">0</span><span class="tok-p">)</span>             <span class="tok-c1">; current line number</span>
         <span class="tok-p">(</span><span class="tok-nv">inside?</span>        <span class="tok-no">nil</span><span class="tok-p">)</span>           <span class="tok-c1">; currently inside a snippet?</span>

         <span class="tok-p">(</span><span class="tok-nv">s/type</span>       <span class="tok-ss">:code</span><span class="tok-p">)</span>
         <span class="tok-p">(</span><span class="tok-nv">s/lines/rev</span>  <span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">s/name</span>       <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
         <span class="tok-p">(</span><span class="tok-nv">s/linenum</span>    <span class="tok-mi">0</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nb">dolist</span> <span class="tok-p">(</span><span class="tok-nv">line</span> <span class="tok-nv">lines</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nb">incf</span> <span class="tok-nv">linenum</span><span class="tok-p">)</span>

      <span class="tok-c1">;; (format t &quot;~A |&gt; ~A~%&quot; linenum line)</span>
      <span class="tok-c1">;; (format t &quot;   |&gt; block? ~A~%&quot; (block-delimiter? line))</span>

      <span class="tok-p">(</span><span class="tok-nb">cond</span> <span class="tok-p">((</span><span class="tok-nb">and</span> <span class="tok-nv">inside?</span> <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nv">block-delimiter?</span> <span class="tok-nv">line</span><span class="tok-p">)))</span>

             <span class="tok-p">(</span><span class="tok-nb">push</span> <span class="tok-nv">line</span> <span class="tok-nv">s/lines/rev</span><span class="tok-p">))</span>

            <span class="tok-p">((</span><span class="tok-nb">and</span> <span class="tok-nv">inside?</span> <span class="tok-p">(</span><span class="tok-nv">block-delimiter?</span> <span class="tok-nv">line</span><span class="tok-p">))</span>

             <span class="tok-c1">;; Close the current snippet</span>
             <span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-nv">inside?</span>  <span class="tok-no">nil</span>
                   <span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-nv">collect-snippet</span> <span class="tok-nv">snippets</span>
                                             <span class="tok-p">(</span><span class="tok-nv">create-snippet</span>
                                              <span class="tok-ss">:type</span> <span class="tok-nv">s/type</span>
                                              <span class="tok-ss">:name</span> <span class="tok-nv">s/name</span>
                                              <span class="tok-ss">:lines</span> <span class="tok-p">(</span><span class="tok-nb">nreverse</span> <span class="tok-nv">s/lines/rev</span><span class="tok-p">)</span>
                                              <span class="tok-ss">:linenum</span> <span class="tok-nv">s/linenum</span><span class="tok-p">))))</span>

            <span class="tok-p">((</span><span class="tok-nb">and</span> <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-nv">inside?</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">block-delimiter?</span> <span class="tok-nv">line</span><span class="tok-p">))</span>
             <span class="tok-c1">;; (format t &quot;  found snippet &gt; num: ~A~%&quot; linenum)</span>

             <span class="tok-p">(</span><span class="tok-nv">when-let</span> <span class="tok-p">(</span><span class="tok-nv">title</span> <span class="tok-p">(</span><span class="tok-nb">cond</span> <span class="tok-p">((</span><span class="tok-nv">block-title?</span> <span class="tok-nv">prev-line</span><span class="tok-p">)</span> <span class="tok-nv">prev-line</span><span class="tok-p">)</span>
                                    <span class="tok-p">((</span><span class="tok-nv">block-title?</span> <span class="tok-nv">prev-prev-line</span><span class="tok-p">)</span> <span class="tok-nv">prev-prev-line</span><span class="tok-p">)</span>
                                    <span class="tok-p">(</span><span class="tok-no">t</span> <span class="tok-no">nil</span><span class="tok-p">)))</span>
               <span class="tok-p">(</span><span class="tok-nb">multiple-value-bind</span> <span class="tok-p">(</span><span class="tok-k">type</span> <span class="tok-nv">name</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">parse-snippet-title</span> <span class="tok-nv">title</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-nv">inside?</span>     <span class="tok-no">t</span>
                       <span class="tok-nv">s/type</span>      <span class="tok-k">type</span>
                       <span class="tok-nv">s/name</span>      <span class="tok-nv">name</span>
                       <span class="tok-nv">s/lines/rev</span> <span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-p">)</span>
                       <span class="tok-nv">s/linenum</span>   <span class="tok-p">(</span><span class="tok-nb">1-</span> <span class="tok-nv">linenum</span><span class="tok-p">))))))</span>

      <span class="tok-c1">;; Update previous lines</span>
      <span class="tok-p">(</span><span class="tok-nb">unless</span> <span class="tok-p">(</span><span class="tok-nb">zerop</span> <span class="tok-p">(</span><span class="tok-nb">length</span> <span class="tok-p">(</span><span class="tok-nb">string-trim</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-sc">#\Space</span> <span class="tok-sc">#\Newline</span> <span class="tok-sc">#\e</span> <span class="tok-sc">#\t</span> <span class="tok-sc">#\m</span><span class="tok-p">)</span> <span class="tok-nv">line</span><span class="tok-p">)))</span>
        <span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-nv">prev-prev-line</span> <span class="tok-nv">prev-line</span>
              <span class="tok-nv">prev-line</span>      <span class="tok-nv">line</span><span class="tok-p">)))</span>

    <span class="tok-c1">;; (list linenum (length lines) snippets)</span>
    <span class="tok-nv">snippets</span><span class="tok-p">))</span>

<span class="tok-c1">;; (extract-snippets-from-file &quot;/m/src/ulquikit/src/Ulquikit.adoc&quot;)</span>
<span class="tok-c1">;; (time (extract-snippets-from-file &quot;/m/src/ulquikit/src/Ulquikit.adoc&quot;))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="tok-c1">;; Helpers</span>
<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">block-delimiter?</span> <span class="tok-p">(</span><span class="tok-nv">str</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Determines if a string is a block delimiter.  TODO: Make this extensible.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-nv">str</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;^----( *)$&quot;</span> <span class="tok-nv">str</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-block-delimiter</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::block-delimiter?</span> <span class="tok-s">&quot;----&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::block-delimiter?</span> <span class="tok-s">&quot; ----&quot;</span><span class="tok-p">)))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::block-delimiter?</span> <span class="tok-s">&quot;---- &quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::block-delimiter?</span> <span class="tok-s">&quot;----  &quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::block-delimiter?</span> <span class="tok-s">&quot;----a&quot;</span><span class="tok-p">))))</span>

<span class="tok-c1">;; (run-tests &#39;(test-block-delimiter))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">block-title?</span> <span class="tok-p">(</span><span class="tok-nv">str</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Determines if a string is a block title.  TODO: Make this extensible.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-nv">str</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;^\\.(file|code)::&quot;</span> <span class="tok-nv">str</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-block-title</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::block-title?</span> <span class="tok-s">&quot;.file::something&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::block-title?</span> <span class="tok-s">&quot;.file::something else&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::block-title?</span> <span class="tok-s">&quot;.file::&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nb">null</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::block-title?</span> <span class="tok-s">&quot;.file:something&quot;</span><span class="tok-p">))))</span>

<span class="tok-c1">;; (run-tests &#39;(test-block-title))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">parse-snippet-title</span> <span class="tok-p">(</span><span class="tok-nv">title</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Parses a snippet title and returns `(values &lt;snippet-type&gt;</span>
<span class="tok-s">&lt;snippet-name&gt;)&#39;.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-nv">title</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nb">multiple-value-bind</span> <span class="tok-p">(</span><span class="tok-nv">_</span> <span class="tok-nv">res</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">scan-to-strings</span> <span class="tok-s">&quot;\.(file|code)::(.*)&quot;</span> <span class="tok-nv">title</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-k">ignore</span> <span class="tok-nv">_</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nb">values</span> <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-kt">keyword</span> <span class="tok-p">(</span><span class="tok-nv">-&gt;keyword</span> <span class="tok-p">(</span><span class="tok-nb">aref</span> <span class="tok-nv">res</span> <span class="tok-mi">0</span><span class="tok-p">)))</span>
            <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-nb">string</span>  <span class="tok-p">(</span><span class="tok-nb">aref</span> <span class="tok-nv">res</span> <span class="tok-mi">1</span><span class="tok-p">)))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-parse-snippet-title</span>
  <span class="tok-p">(</span><span class="tok-nb">dolist</span> <span class="tok-p">(</span><span class="tok-nv">el</span> <span class="tok-o">&#39;</span><span class="tok-p">((</span><span class="tok-s">&quot;.file::&quot;</span>    <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">(</span><span class="tok-s">&quot;.code::&quot;</span>    <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-ss">:code</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">(</span><span class="tok-s">&quot;.file::abc&quot;</span> <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-s">&quot;abc&quot;</span><span class="tok-p">))</span>
                <span class="tok-p">(</span><span class="tok-s">&quot;.code::a b&quot;</span> <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-ss">:code</span> <span class="tok-s">&quot;a b&quot;</span><span class="tok-p">))))</span>
    <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">title</span>    <span class="tok-p">(</span><span class="tok-nb">first</span> <span class="tok-nv">el</span><span class="tok-p">))</span>
          <span class="tok-p">(</span><span class="tok-nv">expected</span> <span class="tok-p">(</span><span class="tok-nb">rest</span>  <span class="tok-nv">el</span><span class="tok-p">)))</span>
      <span class="tok-p">(</span><span class="tok-nb">multiple-value-bind</span> <span class="tok-p">(</span><span class="tok-k">type</span> <span class="tok-nv">name</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::parse-snippet-title</span> <span class="tok-nv">title</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-nv">expected</span> <span class="tok-p">(</span><span class="tok-nb">list</span> <span class="tok-k">type</span> <span class="tok-nv">name</span><span class="tok-p">))))))</span>

<span class="tok-c1">;; (run-tests &#39;(test-parse-snippet-title))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">collect-snippet</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Collects `snippet&#39; into the list of snippets.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-nv">snippet</span>  <span class="tok-nv">snippet</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-k">type</span> <span class="tok-p">(</span><span class="tok-nv">snippet/type</span> <span class="tok-nv">snippet</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">name</span> <span class="tok-p">(</span><span class="tok-nv">snippet/name</span> <span class="tok-nv">snippet</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">current-file</span> <span class="tok-p">(</span><span class="tok-nv">snippets/file</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">current-code</span> <span class="tok-p">(</span><span class="tok-nv">snippets/code</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">file</span> <span class="tok-p">(</span><span class="tok-nb">case</span> <span class="tok-k">type</span>
                 <span class="tok-p">(</span><span class="tok-ss">:file</span>     <span class="tok-p">(</span><span class="tok-nv">sethash</span> <span class="tok-nv">name</span> <span class="tok-nv">current-file</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span>
                            <span class="tok-nv">current-file</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nv">otherwise</span> <span class="tok-nv">current-file</span><span class="tok-p">)))</span>
         <span class="tok-p">(</span><span class="tok-nv">code</span> <span class="tok-p">(</span><span class="tok-nb">case</span> <span class="tok-k">type</span>
                 <span class="tok-p">(</span><span class="tok-ss">:code</span>     <span class="tok-p">(</span><span class="tok-nv">sethash</span> <span class="tok-nv">name</span> <span class="tok-nv">current-code</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span>
                            <span class="tok-nv">current-code</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nv">otherwise</span> <span class="tok-nv">current-code</span><span class="tok-p">))))</span>
    <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-nv">make-snippets</span> <span class="tok-ss">:file</span> <span class="tok-nv">file</span>
                                 <span class="tok-ss">:code</span> <span class="tok-nv">code</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-collect-snippets</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equalp</span> <span class="tok-p">(</span><span class="tok-nv">collect-snippet</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippets</span><span class="tok-p">)</span>
                                  <span class="tok-p">(</span><span class="tok-nv">create-snippet</span> <span class="tok-ss">:type</span> <span class="tok-ss">:file</span>
                                                  <span class="tok-ss">:name</span> <span class="tok-ss">:hello</span>
                                                  <span class="tok-ss">:linenum</span> <span class="tok-mi">10</span>
                                                  <span class="tok-ss">:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Something&quot;</span><span class="tok-p">)))</span>
                 <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippets</span>
                  <span class="tok-ss">:file</span> <span class="tok-p">(</span><span class="tok-nv">alexandria:alist-hash-table</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippet</span>
                                                                    <span class="tok-ss">:type</span> <span class="tok-ss">:file</span>
                                                                    <span class="tok-ss">:name</span> <span class="tok-s">&quot;hello&quot;</span>
                                                                    <span class="tok-ss">:linenum</span> <span class="tok-mi">10</span>
                                                                    <span class="tok-ss">:lines</span> <span class="tok-p">(</span><span class="tok-s">&quot;Something&quot;</span><span class="tok-p">)</span>
                                                                    <span class="tok-ss">:processed?</span> <span class="tok-no">nil</span><span class="tok-p">)))</span>
                                                     <span class="tok-ss">:test</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">equal</span><span class="tok-p">)</span>
                  <span class="tok-ss">:code</span> <span class="tok-p">(</span><span class="tok-nb">make-hash-table</span> <span class="tok-ss">:test</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">equal</span><span class="tok-p">)))</span>

  <span class="tok-p">(</span><span class="tok-nv">assert-equalp</span> <span class="tok-p">(</span><span class="tok-nv">collect-snippet</span>
                  <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippets</span>
                   <span class="tok-ss">:file</span> <span class="tok-p">(</span><span class="tok-nv">alexandria:alist-hash-table</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippet</span>
                                                                     <span class="tok-ss">:type</span> <span class="tok-ss">:file</span>
                                                                     <span class="tok-ss">:name</span> <span class="tok-s">&quot;hello&quot;</span>
                                                                     <span class="tok-ss">:linenum</span> <span class="tok-mi">10</span>
                                                                     <span class="tok-ss">:lines</span> <span class="tok-p">(</span><span class="tok-s">&quot;Something&quot;</span><span class="tok-p">)</span>
                                                                     <span class="tok-ss">:processed?</span> <span class="tok-no">nil</span><span class="tok-p">)))</span>
                                                      <span class="tok-ss">:test</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">equal</span><span class="tok-p">)</span>
                   <span class="tok-ss">:code</span> <span class="tok-p">(</span><span class="tok-nb">make-hash-table</span> <span class="tok-ss">:test</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">equal</span><span class="tok-p">))</span>
                  <span class="tok-p">(</span><span class="tok-nv">create-snippet</span> <span class="tok-ss">:type</span> <span class="tok-ss">&#39;code</span>
                                  <span class="tok-ss">:name</span> <span class="tok-ss">&#39;say-something</span>
                                  <span class="tok-ss">:linenum</span> <span class="tok-mi">100</span>
                                  <span class="tok-ss">:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Something else&quot;</span><span class="tok-p">)))</span>
                 <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippets</span> <span class="tok-ss">:file</span> <span class="tok-p">(</span><span class="tok-nv">alexandria:alist-hash-table</span>
                                                 <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippet</span>
                                                                <span class="tok-ss">:type</span> <span class="tok-ss">:file</span>
                                                                <span class="tok-ss">:name</span> <span class="tok-s">&quot;hello&quot;</span>
                                                                <span class="tok-ss">:linenum</span> <span class="tok-mi">10</span>
                                                                <span class="tok-ss">:lines</span> <span class="tok-p">(</span><span class="tok-s">&quot;Something&quot;</span><span class="tok-p">)</span>
                                                                <span class="tok-ss">:processed?</span> <span class="tok-no">nil</span><span class="tok-p">)))</span>
                                                 <span class="tok-ss">:test</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">equal</span><span class="tok-p">)</span>
                                          <span class="tok-ss">:code</span> <span class="tok-p">(</span><span class="tok-nv">alexandria:alist-hash-table</span>
                                                 <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-s">&quot;say-something&quot;</span> <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippet</span>
                                                                       <span class="tok-ss">:type</span> <span class="tok-ss">:code</span>
                                                                       <span class="tok-ss">:name</span> <span class="tok-s">&quot;say-something&quot;</span>
                                                                       <span class="tok-ss">:linenum</span> <span class="tok-mi">100</span>
                                                                       <span class="tok-ss">:lines</span> <span class="tok-p">(</span><span class="tok-s">&quot;Something else&quot;</span><span class="tok-p">)</span>
                                                                       <span class="tok-ss">:processed?</span> <span class="tok-no">nil</span><span class="tok-p">)))</span>
                                                 <span class="tok-ss">:test</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">equal</span><span class="tok-p">))))</span>

<span class="tok-c1">;; (run-tests &#39;(test-collect-snippets))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a result, <code>extract-snippets</code>, which recursively extracts snippets from all
AsciiDoc documents in a directory, makes use of <code>extract-snippets-from-file</code>.
<code>extract-snippets</code> takes a path and returns a <code>snippets</code> struct.</p>
</div>
<div class="listingblock">
<div class="title">code::extract-snippets</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">extract-snippets</span> <span class="tok-p">(</span><span class="tok-nv">path</span> <span class="tok-k">&amp;key</span> <span class="tok-p">(</span><span class="tok-nv">recursive</span> <span class="tok-no">t</span><span class="tok-p">))</span>
  <span class="tok-s">&quot;Extracts all snippets from all AsciiDoc directory in `path&#39;.  The AsciiDoc</span>
<span class="tok-s">files are searched recursively or non-recursively depending on `recursive&#39;.</span>
<span class="tok-s">This function also takes `path&#39; as a single AsciiDoc file.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span> <span class="tok-nv">path</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nb">reduce</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">merge-snippets</span>
          <span class="tok-p">(</span><span class="tok-nv">list-asciidocs</span> <span class="tok-nv">path</span> <span class="tok-ss">:recursive</span> <span class="tok-nv">recursive</span><span class="tok-p">)</span>
          <span class="tok-ss">:initial-value</span> <span class="tok-p">(</span><span class="tok-nv">make-snippets</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-extract-snippets</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">test-dir</span> <span class="tok-p">(</span><span class="tok-nv">uiop:merge-pathnames*</span>
                    <span class="tok-s">&quot;ulquikit/test-extract-snippets/&quot;</span>
                    <span class="tok-p">(</span><span class="tok-nv">uiop:ensure-directory-pathname</span> <span class="tok-p">(</span><span class="tok-nv">uiop:getenv</span> <span class="tok-s">&quot;TMPDIR&quot;</span><span class="tok-p">))))</span>

         <span class="tok-p">(</span><span class="tok-nv">content</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-s">&quot;Main.adoc&quot;</span> <span class="tok-o">.</span> <span class="tok-s">&quot;= A sample program</span>

<span class="tok-s">This program consists of several snippets and a hello</span>

<span class="tok-s">== Main program</span>

<span class="tok-s">The main program includes function `say-hello` from `lib/Say-Hello.adoc` and</span>
<span class="tok-s">function `say-world` from `lib/Say-World.adoc` and calls them.</span>

<span class="tok-s">.file::/tmp/main.lisp</span>
<span class="tok-s">\----</span>
<span class="tok-s">;; include::say-hello</span>

<span class="tok-s">;; include::say-world</span>

<span class="tok-s">\(say-hello\)</span>
<span class="tok-s">\(say-world\)</span>

<span class="tok-s">\----</span>
<span class="tok-s">&quot;</span><span class="tok-p">)</span>
                    <span class="tok-p">(</span><span class="tok-s">&quot;License&quot;</span> <span class="tok-o">.</span> <span class="tok-s">&quot;Do what you want to do with it!&quot;</span><span class="tok-p">)</span>
                    <span class="tok-p">(</span><span class="tok-s">&quot;lib/Say-Hello.adoc&quot;</span> <span class="tok-o">.</span> <span class="tok-s">&quot;What do you actually expect in this</span>
<span class="tok-s">file?  Two snippets, one of which doesn&#39;t get captured.</span>

<span class="tok-s">.code::say-hello</span>
<span class="tok-s">[source,lisp,linenums]</span>
<span class="tok-s">\----</span>
<span class="tok-s">\(defun say-hello \(\)</span>
<span class="tok-s">  \(format t \&quot;Hello \&quot;\)\)</span>
<span class="tok-s">\----</span>

<span class="tok-s">The following snippet doesn&#39;t get captured as it has no title:</span>

<span class="tok-s">[source,lisp,linenums]</span>
<span class="tok-s">\----</span>
<span class="tok-s">\(defun throw-away \(\)</span>
<span class="tok-s">  \(error \&quot;If you see me, there is at least one error happened!\&quot;\)\)</span>
<span class="tok-s">\----</span>
<span class="tok-s">&quot;</span><span class="tok-p">)</span>
                    <span class="tok-p">(</span><span class="tok-s">&quot;lib/Say-World.adoc&quot;</span> <span class="tok-o">.</span> <span class="tok-s">&quot;Another way to define code block title with AsciiDoc:</span>

<span class="tok-s">[source,lisp,linenums]</span>
<span class="tok-s">.code::say-world</span>
<span class="tok-s">\----</span>
<span class="tok-s">\(defun say-world \(\)</span>
<span class="tok-s">  \(format t \&quot;world!~%\&quot;\)\)</span>
<span class="tok-s">\----</span>
<span class="tok-s">&quot;</span><span class="tok-p">)))</span>
         <span class="tok-p">(</span><span class="tok-nv">files</span> <span class="tok-p">(</span><span class="tok-nb">mapcar</span> <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">content-pair</span><span class="tok-p">)</span>
                            <span class="tok-p">(</span><span class="tok-nb">cons</span> <span class="tok-p">(</span><span class="tok-nv">uiop:merge-pathnames*</span> <span class="tok-p">(</span><span class="tok-nb">car</span> <span class="tok-nv">content-pair</span><span class="tok-p">)</span> <span class="tok-nv">test-dir</span><span class="tok-p">)</span>
                                  <span class="tok-p">(</span><span class="tok-nb">cdr</span> <span class="tok-nv">content-pair</span><span class="tok-p">)))</span>
                        <span class="tok-nv">content</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nv">uiop:delete-directory-tree</span> <span class="tok-nv">test-dir</span> <span class="tok-ss">:if-does-not-exist</span> <span class="tok-ss">:ignore</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">t</span> <span class="tok-s">&quot;Test dir: ~A~%&quot;</span> <span class="tok-nv">test-dir</span><span class="tok-p">)</span>

    <span class="tok-p">(</span><span class="tok-nb">dolist</span> <span class="tok-p">(</span><span class="tok-nv">path+content</span> <span class="tok-nv">files</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">path</span>    <span class="tok-p">(</span><span class="tok-nb">car</span> <span class="tok-nv">path+content</span><span class="tok-p">))</span>
            <span class="tok-p">(</span><span class="tok-nv">content</span> <span class="tok-p">(</span><span class="tok-nb">cdr</span> <span class="tok-nv">path+content</span><span class="tok-p">)))</span>
        <span class="tok-p">(</span><span class="tok-nb">ensure-directories-exist</span> <span class="tok-nv">path</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nb">with-open-file</span> <span class="tok-p">(</span><span class="tok-nv">out</span> <span class="tok-nv">path</span> <span class="tok-ss">:direction</span> <span class="tok-ss">:output</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-nb">princ</span> <span class="tok-nv">content</span> <span class="tok-nv">out</span><span class="tok-p">))))</span>

    <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::extract-snippets</span> <span class="tok-nv">test-dir</span><span class="tok-p">))</span>
           <span class="tok-p">(</span><span class="tok-nv">file-snippets</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippets/file</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
           <span class="tok-p">(</span><span class="tok-nv">code-snippets</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippets/code</span> <span class="tok-nv">snippets</span><span class="tok-p">)))</span>
      <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-mi">1</span> <span class="tok-p">(</span><span class="tok-nb">hash-table-count</span> <span class="tok-nv">file-snippets</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-mi">2</span> <span class="tok-p">(</span><span class="tok-nb">hash-table-count</span> <span class="tok-nv">code-snippets</span><span class="tok-p">))</span>

      <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;;; include::say-hello</span>

<span class="tok-s">;; include::say-world</span>

<span class="tok-s">\(say-hello\)</span>
<span class="tok-s">\(say-world\)</span>
<span class="tok-s">&quot;</span>
                    <span class="tok-p">(</span><span class="tok-nv">snippet-&gt;string</span> <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-s">&quot;/tmp/main.lisp&quot;</span> <span class="tok-nv">file-snippets</span><span class="tok-p">)))</span>
      <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;\(defun say-hello \(\)</span>
<span class="tok-s">  \(format t \&quot;Hello \&quot;\)\)&quot;</span>
                    <span class="tok-p">(</span><span class="tok-nv">snippet-&gt;string</span> <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-s">&quot;say-hello&quot;</span> <span class="tok-nv">code-snippets</span><span class="tok-p">)))</span>
      <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;\(defun say-world \(\)</span>
<span class="tok-s">  \(format t \&quot;world!~%\&quot;\)\)&quot;</span>
                    <span class="tok-p">(</span><span class="tok-nv">snippet-&gt;string</span> <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-s">&quot;say-world&quot;</span> <span class="tok-nv">code-snippets</span><span class="tok-p">))))))</span>

<span class="tok-c1">;; (run-tests &#39;(test-extract-snippets))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="tok-c1">;; Helpers</span>
<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">snippet-&gt;string</span> <span class="tok-p">(</span><span class="tok-nv">snippet</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Returns the string representation of a snippet.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nv">snippet</span> <span class="tok-nv">snippet</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">get-snippet-content</span> <span class="tok-nv">snippet</span><span class="tok-p">))</span>

<span class="tok-c1">;;; (snippet-&gt;string (make-snippet))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-snippet-&gt;string</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">(</span><span class="tok-nv">snippet-&gt;string</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span><span class="tok-p">)))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;aoeu&quot;</span> <span class="tok-p">(</span><span class="tok-nv">snippet-&gt;string</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;aoeu&quot;</span><span class="tok-p">))))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;aoeu</span>
<span class="tok-s">ueoa&quot;</span>
                <span class="tok-p">(</span><span class="tok-nv">snippet-&gt;string</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;aoeu&quot;</span> <span class="tok-s">&quot;ueoa&quot;</span><span class="tok-p">)))))</span>

<span class="tok-c1">;; (run-tests &#39;(test-snippet-&gt;string))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">merge-snippets</span> <span class="tok-p">(</span><span class="tok-nv">current-snippets</span> <span class="tok-nv">new-src</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Merges 2 chunks of snippet.  If `new-src&#39; is a literate source file,</span>
<span class="tok-s">`merge-snippets&#39; will perform the extraction before the merge first.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-nv">current-snippets</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span> <span class="tok-nv">snippets</span><span class="tok-p">)</span> <span class="tok-nv">new-src</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">new-snippets</span> <span class="tok-p">(</span><span class="tok-nb">typecase</span> <span class="tok-nv">new-src</span>
                        <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span>
                         <span class="tok-p">(</span><span class="tok-nv">extract-snippets-from-file</span> <span class="tok-nv">new-src</span><span class="tok-p">))</span>
                        <span class="tok-p">(</span><span class="tok-nv">snippets</span>
                         <span class="tok-nv">new-src</span><span class="tok-p">))))</span>
    <span class="tok-c1">;; Merging 2 snippets</span>
    <span class="tok-p">(</span><span class="tok-nb">maphash</span> <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">key</span> <span class="tok-nv">value</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nv">sethash</span> <span class="tok-nv">key</span>
                          <span class="tok-p">(</span><span class="tok-nv">snippets/file</span> <span class="tok-nv">current-snippets</span><span class="tok-p">)</span>
                          <span class="tok-nv">value</span><span class="tok-p">))</span>
             <span class="tok-p">(</span><span class="tok-nv">snippets/file</span> <span class="tok-nv">new-snippets</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nb">maphash</span> <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">key</span> <span class="tok-nv">value</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nv">sethash</span> <span class="tok-nv">key</span>
                          <span class="tok-p">(</span><span class="tok-nv">snippets/code</span> <span class="tok-nv">current-snippets</span><span class="tok-p">)</span>
                          <span class="tok-nv">value</span><span class="tok-p">))</span>
             <span class="tok-p">(</span><span class="tok-nv">snippets/code</span> <span class="tok-nv">new-snippets</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-nv">snippets</span> <span class="tok-nv">current-snippets</span><span class="tok-p">)))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>And last but not least, we need a helper to retrieve all AsciiDoc documents
from a directory, recursively or non-recursively.</p>
</div>
<div class="sect4">
<h5 id="_retrieving_all_asciidoc_documents_in_a_directory">Retrieving all ASCIIDoc documents in a directory</h5>
<div class="listingblock">
<div class="title">code::list-asciidocs</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-c1">;; TODO: list-asciidocs suppors taking path as a list</span>
<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">list-asciidocs</span> <span class="tok-p">(</span><span class="tok-nv">path</span> <span class="tok-k">&amp;key</span> <span class="tok-p">(</span><span class="tok-nv">recursive</span> <span class="tok-no">t</span><span class="tok-p">))</span>
  <span class="tok-s">&quot;Returns a list of all ASCIIDoc file (i.e. file with .adoc or .txt</span>
<span class="tok-s">extensions) from directory `path&#39;, ignoring all temporary files.  TODO: Make</span>
<span class="tok-s">this extensible.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span> <span class="tok-nv">path</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">uiop:file-exists-p</span> <span class="tok-nv">path</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nb">list</span> <span class="tok-nv">path</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">path</span> <span class="tok-p">(</span><span class="tok-nv">uiop:ensure-directory-pathname</span> <span class="tok-nv">path</span><span class="tok-p">))</span>
           <span class="tok-p">(</span><span class="tok-nv">current-asciidocs</span> <span class="tok-p">(</span><span class="tok-nb">remove-if</span> <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">path</span><span class="tok-p">)</span>
                                             <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nv">valid-asciidoc-file?</span> <span class="tok-nv">path</span><span class="tok-p">)))</span>
                                         <span class="tok-p">(</span><span class="tok-nv">uiop:directory-files</span> <span class="tok-nv">path</span><span class="tok-p">))))</span>
      <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-nv">recursive</span>
          <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">append</span>
                 <span class="tok-nv">current-asciidocs</span>
                 <span class="tok-p">(</span><span class="tok-nb">mapcar</span> <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">subdir</span><span class="tok-p">)</span>
                             <span class="tok-p">(</span><span class="tok-nv">list-asciidocs</span> <span class="tok-nv">subdir</span> <span class="tok-ss">:recursive</span> <span class="tok-nv">recursive</span><span class="tok-p">))</span>
                         <span class="tok-p">(</span><span class="tok-nv">uiop:subdirectories</span> <span class="tok-nv">path</span><span class="tok-p">)))</span>
        <span class="tok-nv">current-asciidocs</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">valid-asciidoc-file?</span> <span class="tok-p">(</span><span class="tok-nv">path</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Determines if a path refers to an AsciiDoc file based on its extension.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">path</span> <span class="tok-p">(</span><span class="tok-nb">namestring</span> <span class="tok-nv">path</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nb">and</span> <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nv">uiop:directory-pathname-p</span> <span class="tok-nv">path</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">cl-ppcre:scan</span> <span class="tok-s">&quot;^[^#]&quot;</span> <span class="tok-nv">path</span><span class="tok-p">)</span>
         <span class="tok-p">(</span><span class="tok-nv">cl-ppcre:scan</span> <span class="tok-s">&quot;\\.(adoc|txt|asciidoc)$&quot;</span> <span class="tok-nv">path</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-list-asciidocs</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">files</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;a.adoc&quot;</span>
                  <span class="tok-s">&quot;b.adoc&quot;</span>
                  <span class="tok-s">&quot;c.md&quot;</span>
                  <span class="tok-s">&quot;e.adoc&quot;</span>
                  <span class="tok-s">&quot;hello/a.adoc&quot;</span>
                  <span class="tok-s">&quot;hello/b.html&quot;</span>
                  <span class="tok-s">&quot;hello/world/hola.adoc&quot;</span>
                  <span class="tok-s">&quot;hello/world/mundo.adoc&quot;</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">temppath</span> <span class="tok-p">(</span><span class="tok-nv">uiop:merge-pathnames*</span> <span class="tok-s">&quot;ulquikit/test-list-asciidocs/&quot;</span>
                                          <span class="tok-p">(</span><span class="tok-nb">pathname</span> <span class="tok-p">(</span><span class="tok-nv">uiop:ensure-directory-pathname</span>
                                                     <span class="tok-p">(</span><span class="tok-nv">uiop:getenv</span> <span class="tok-s">&quot;TMPDIR&quot;</span><span class="tok-p">)))))</span>
         <span class="tok-p">(</span><span class="tok-nv">expected</span> <span class="tok-p">(</span><span class="tok-nv">iterate</span>
                    <span class="tok-p">(</span><span class="tok-nv">for</span> <span class="tok-nv">path</span> <span class="tok-nv">in</span> <span class="tok-nv">files</span><span class="tok-p">)</span>
                    <span class="tok-p">(</span><span class="tok-nb">when</span> <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;\\.adoc$&quot;</span> <span class="tok-nv">path</span><span class="tok-p">)</span>
                      <span class="tok-p">(</span><span class="tok-nv">collect</span> <span class="tok-p">(</span><span class="tok-nv">uiop:merge-pathnames*</span> <span class="tok-nv">path</span> <span class="tok-nv">temppath</span><span class="tok-p">))))))</span>
    <span class="tok-c1">;; Setup</span>
    <span class="tok-p">(</span><span class="tok-nv">uiop:delete-directory-tree</span> <span class="tok-nv">temppath</span> <span class="tok-ss">:if-does-not-exist</span> <span class="tok-ss">:ignore</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nb">dolist</span> <span class="tok-p">(</span><span class="tok-nv">path</span> <span class="tok-nv">files</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">file</span> <span class="tok-p">(</span><span class="tok-nv">uiop:merge-pathnames*</span> <span class="tok-nv">path</span> <span class="tok-nv">temppath</span><span class="tok-p">)))</span>
        <span class="tok-p">(</span><span class="tok-nb">ensure-directories-exist</span> <span class="tok-p">(</span><span class="tok-nv">uiop:pathname-directory-pathname</span> <span class="tok-nv">file</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nb">with-open-file</span> <span class="tok-p">(</span><span class="tok-nv">out</span> <span class="tok-nv">file</span> <span class="tok-ss">:direction</span> <span class="tok-ss">:output</span>
                             <span class="tok-ss">:if-exists</span> <span class="tok-ss">:supersede</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-nb">princ</span> <span class="tok-s">&quot;Hello world&quot;</span> <span class="tok-nv">out</span><span class="tok-p">))))</span>

    <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">adocs</span> <span class="tok-p">(</span><span class="tok-nv">list-asciidocs</span> <span class="tok-nv">temppath</span><span class="tok-p">)))</span>
      <span class="tok-p">(</span><span class="tok-nv">assert-equalp</span> <span class="tok-p">(</span><span class="tok-nb">sort</span> <span class="tok-nv">expected</span> <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">path1</span> <span class="tok-nv">path2</span><span class="tok-p">)</span>
                                        <span class="tok-p">(</span><span class="tok-nb">string&lt;</span> <span class="tok-p">(</span><span class="tok-nb">namestring</span> <span class="tok-nv">path1</span><span class="tok-p">)</span>
                                                 <span class="tok-p">(</span><span class="tok-nb">namestring</span> <span class="tok-nv">path2</span><span class="tok-p">))))</span>
                     <span class="tok-p">(</span><span class="tok-nb">sort</span> <span class="tok-nv">adocs</span> <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">path1</span> <span class="tok-nv">path2</span><span class="tok-p">)</span>
                                     <span class="tok-p">(</span><span class="tok-nb">string&lt;</span> <span class="tok-p">(</span><span class="tok-nb">namestring</span> <span class="tok-nv">path1</span><span class="tok-p">)</span>
                                              <span class="tok-p">(</span><span class="tok-nb">namestring</span> <span class="tok-nv">path2</span><span class="tok-p">))))))</span>

    <span class="tok-c1">;; Tear down</span>
    <span class="tok-p">(</span><span class="tok-nv">uiop:delete-directory-tree</span> <span class="tok-nv">temppath</span> <span class="tok-ss">:if-does-not-exist</span> <span class="tok-ss">:ignore</span><span class="tok-p">)))</span>

<span class="tok-c1">;; (run-tests &#39;(test-list-asciidocs))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>After <code>extract-snippets</code>, we need a function to include snippets into each
other.</p>
</div>
<div class="paragraph">
<p><a id="section/include-snippets"></a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_including_snippets_into_each_other_with_code_include_snippet_code">4.2. Including snippets into each other with <code>include-snippet!</code></h3>
<div class="paragraph">
<p>Taking 2 arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the current list of snippets,</p>
</li>
<li>
<p>a <code>(type . name)</code> cons representing the target snippet, i.e. the one being
processed, this snippet <strong>must</strong> be a part of the current list of snippets,</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>this function returns the new list of snippets with the target snippet
modified.</p>
</div>
<div class="paragraph">
<p><code>include-snippet!</code> works by browsing through the target snippet&#8217;s content, one
line at a time, and replacing line containing the <code>include::</code> directive with
the corresponding <em>code snippet</em>s in the list.  If no snippet is found, the
line doesn&#8217;t change.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
To prevent unnecessary copy, this function modifies its arguments,
hence its name is suffixed with a bang (<code>!</code>).  To safely use
<code>include-snippet!</code>, call it with a copy of the arguments (using <code>copy-list</code> or
<code>copy-tree</code>, etc.).
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
In case of circular dependency, e.g. snippet A includes itself, the
result is <strong>undefined</strong>.  Make sure your snippets are well managed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a id="func/include-snippet"></a></p>
</div>
<div class="listingblock">
<div class="title">code::include-snippet</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">include-snippet!</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-nv">type+name</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Processes target snippet \(presented by `type+name&#39;\) by replacing all of</span>
<span class="tok-s">its \&quot;include\&quot; directives with the corresponding code snippets found in</span>
<span class="tok-s">`snippets&#39;.  If the target snippet introduces circular dependency, the result</span>
<span class="tok-s">is undefined.</span>

<span class="tok-s">This function modifies `snippets&#39; in-place and returns it after processing.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">cons</span> <span class="tok-nv">type+name</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>

  <span class="tok-c1">;; (format t &quot;→ including snippet ~A~%&quot; type+name)</span>

  <span class="tok-c1">;; Ignore of the target snippet doesn&#39;t exist in the list of snippets</span>
  <span class="tok-p">(</span><span class="tok-nb">when</span> <span class="tok-p">(</span><span class="tok-nv">snippet-exists?</span> <span class="tok-nv">type+name</span> <span class="tok-nv">snippets</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">target/type</span> <span class="tok-p">(</span><span class="tok-nb">car</span> <span class="tok-nv">type+name</span><span class="tok-p">))</span>
           <span class="tok-p">(</span><span class="tok-nv">target/name</span> <span class="tok-p">(</span><span class="tok-nb">cdr</span> <span class="tok-nv">type+name</span><span class="tok-p">))</span>
           <span class="tok-p">(</span><span class="tok-nv">target</span>      <span class="tok-p">(</span><span class="tok-nv">snippets/get-snippet</span> <span class="tok-nv">snippets</span>
                                              <span class="tok-ss">:type</span> <span class="tok-nv">target/type</span>
                                              <span class="tok-ss">:name</span> <span class="tok-nv">target/name</span><span class="tok-p">))</span>
           <span class="tok-p">(</span><span class="tok-nv">lines</span>       <span class="tok-p">(</span><span class="tok-nv">snippet/lines</span> <span class="tok-nv">target</span><span class="tok-p">))</span>
           <span class="tok-p">(</span><span class="tok-nv">lines-final</span> <span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-p">)))</span>
      <span class="tok-c1">;; Also, we ignore if this snippet has already been processed</span>
      <span class="tok-p">(</span><span class="tok-nb">unless</span> <span class="tok-p">(</span><span class="tok-nv">snippet/processed?</span> <span class="tok-nv">target</span><span class="tok-p">)</span>
        <span class="tok-c1">;; Consider this snippet processed</span>
        <span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-p">(</span><span class="tok-nv">snippet/processed?</span> <span class="tok-nv">target</span><span class="tok-p">)</span> <span class="tok-no">t</span><span class="tok-p">)</span>

        <span class="tok-c1">;; Now, recollect lines</span>
        <span class="tok-p">(</span><span class="tok-nb">dolist</span> <span class="tok-p">(</span><span class="tok-nv">line</span> <span class="tok-nv">lines</span><span class="tok-p">)</span>
          <span class="tok-c1">;; (format t &quot;  Processing ~A~%&quot; line)</span>
          <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">include-directive?</span> <span class="tok-nv">line</span><span class="tok-p">)</span>
              <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">includee-name</span> <span class="tok-p">(</span><span class="tok-nv">parse-include-directive</span> <span class="tok-nv">line</span><span class="tok-p">))</span>
                     <span class="tok-p">(</span><span class="tok-nv">includee</span>      <span class="tok-p">(</span><span class="tok-nv">snippets/get-snippet</span> <span class="tok-nv">snippets</span>
                                                          <span class="tok-ss">:type</span> <span class="tok-ss">:code</span>
                                                          <span class="tok-ss">:name</span> <span class="tok-nv">includee-name</span><span class="tok-p">)))</span>
                <span class="tok-p">(</span><span class="tok-nb">cond</span> <span class="tok-p">((</span><span class="tok-nb">null</span> <span class="tok-nv">includee</span><span class="tok-p">)</span>
                       <span class="tok-c1">;; No such snippet to include</span>
                       <span class="tok-p">(</span><span class="tok-nb">push</span> <span class="tok-nv">line</span> <span class="tok-nv">lines-final</span><span class="tok-p">))</span>

                      <span class="tok-p">((</span><span class="tok-nv">snippet/processed?</span> <span class="tok-nv">includee</span><span class="tok-p">)</span>
                       <span class="tok-p">(</span><span class="tok-nb">push</span> <span class="tok-p">(</span><span class="tok-nv">snippet-&gt;string</span> <span class="tok-nv">includee</span><span class="tok-p">)</span> <span class="tok-nv">lines-final</span><span class="tok-p">))</span>

                      <span class="tok-p">((</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nv">snippet-exists?</span> <span class="tok-nv">includee</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
                       <span class="tok-p">(</span><span class="tok-nb">push</span> <span class="tok-nv">line</span> <span class="tok-nv">lines-final</span><span class="tok-p">))</span>

                      <span class="tok-p">(</span><span class="tok-no">t</span>
                       <span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-nv">include-snippet!</span>
                                       <span class="tok-nv">snippets</span>
                                       <span class="tok-o">`</span><span class="tok-p">(</span><span class="tok-ss">:code</span> <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-nv">includee-name</span><span class="tok-p">)))</span>
                       <span class="tok-p">(</span><span class="tok-nb">push</span> <span class="tok-p">(</span><span class="tok-nv">snippet-&gt;string</span> <span class="tok-nv">includee</span><span class="tok-p">)</span> <span class="tok-nv">lines-final</span><span class="tok-p">))))</span>
            <span class="tok-p">(</span><span class="tok-nb">push</span> <span class="tok-nv">line</span> <span class="tok-nv">lines-final</span><span class="tok-p">)))</span>

        <span class="tok-c1">;; (format t &quot;Snippet: ~A; result: ~A~%&quot;</span>
        <span class="tok-c1">;;         (cdr type+name)</span>
        <span class="tok-c1">;;         (join-lines (reverse (copy-list lines-final))))</span>

        <span class="tok-c1">;; Then, collect result</span>
        <span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-p">(</span><span class="tok-nv">snippet/lines</span> <span class="tok-nv">target</span><span class="tok-p">)</span>
              <span class="tok-p">(</span><span class="tok-nb">list</span> <span class="tok-p">(</span><span class="tok-nv">join-lines</span> <span class="tok-p">(</span><span class="tok-nb">nreverse</span> <span class="tok-nv">lines-final</span><span class="tok-p">)))))))</span>
  <span class="tok-nv">snippets</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-c1">;; (run-tests &#39;(test-include-snippet))</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-include-snippet</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">snp/file</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippet</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;/tmp/tmp.lisp&quot;</span>
                                           <span class="tok-ss">:type</span> <span class="tok-ss">:file</span>
                                           <span class="tok-ss">:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;;; include::A&quot;</span>
                                                    <span class="tok-s">&quot;;; The end&quot;</span><span class="tok-p">)</span>
                                           <span class="tok-ss">:linenum</span> <span class="tok-mi">10</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">snp/code/A</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippet</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;A&quot;</span>
                                             <span class="tok-ss">:type</span> <span class="tok-ss">:code</span>
                                             <span class="tok-ss">:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;World&quot;</span>
                                                      <span class="tok-s">&quot;;; include::B&quot;</span>
                                                      <span class="tok-s">&quot;;; include::D&quot;</span><span class="tok-p">)</span>
                                             <span class="tok-ss">:linenum</span> <span class="tok-mi">20</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">snp/code/B</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippet</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;B&quot;</span>
                                             <span class="tok-ss">:type</span> <span class="tok-ss">:code</span>
                                             <span class="tok-ss">:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Hello&quot;</span><span class="tok-p">)</span>
                                             <span class="tok-ss">:linenum</span> <span class="tok-mi">30</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">snp/code/C</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippet</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;C&quot;</span>
                                             <span class="tok-ss">:type</span> <span class="tok-ss">:code</span>
                                             <span class="tok-ss">:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;Not processed&quot;</span><span class="tok-p">)</span>
                                             <span class="tok-ss">:linenum</span> <span class="tok-mi">15</span><span class="tok-p">))</span>
         <span class="tok-c1">;; Circular dependency</span>
         <span class="tok-p">(</span><span class="tok-nv">snp/code/D</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippet</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;D&quot;</span>
                                             <span class="tok-ss">:type</span> <span class="tok-ss">:code</span>
                                             <span class="tok-ss">:lines</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;;; include A&quot;</span><span class="tok-p">)</span>
                                             <span class="tok-ss">:linenum</span> <span class="tok-mi">100</span><span class="tok-p">))</span>

         <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">res</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::make-snippets</span><span class="tok-p">))</span>
                          <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippets/file</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippets/file</span> <span class="tok-nv">res</span><span class="tok-p">))</span>
                          <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippets/code</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippets/code</span> <span class="tok-nv">res</span><span class="tok-p">)))</span>
                     <span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-s">&quot;/tmp/tmp.lisp&quot;</span> <span class="tok-nv">ulquikit::snippets/file</span><span class="tok-p">)</span> <span class="tok-nv">snp/file</span>
                           <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-s">&quot;A&quot;</span> <span class="tok-nv">ulquikit::snippets/code</span><span class="tok-p">)</span> <span class="tok-nv">snp/code/A</span>
                           <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-s">&quot;B&quot;</span> <span class="tok-nv">ulquikit::snippets/code</span><span class="tok-p">)</span> <span class="tok-nv">snp/code/B</span>
                           <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-s">&quot;C&quot;</span> <span class="tok-nv">ulquikit::snippets/code</span><span class="tok-p">)</span> <span class="tok-nv">snp/code/C</span>
                           <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-s">&quot;D&quot;</span> <span class="tok-nv">ulquikit::snippets/code</span><span class="tok-p">)</span> <span class="tok-nv">snp/code/D</span><span class="tok-p">)</span>
                     <span class="tok-c1">;; Don&#39;t add D right away</span>
                     <span class="tok-nv">res</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-snippet!</span> <span class="tok-nv">snippets</span> <span class="tok-o">`</span><span class="tok-p">(</span><span class="tok-ss">:code</span> <span class="tok-o">.</span> <span class="tok-s">&quot;A&quot;</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-no">t</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet/processed?</span> <span class="tok-nv">snp/code/A</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet/processed?</span> <span class="tok-nv">snp/code/B</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet/processed?</span> <span class="tok-nv">snp/code/D</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-false</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet/processed?</span> <span class="tok-nv">snp/code/C</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-false</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet/processed?</span> <span class="tok-nv">snp/file</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;^World\\nHello\\n&quot;</span>
                       <span class="tok-p">(</span><span class="tok-nb">nth</span> <span class="tok-mi">0</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet/lines</span> <span class="tok-nv">snp/code/A</span><span class="tok-p">))))</span>

    <span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-snippet!</span> <span class="tok-nv">snippets</span> <span class="tok-o">`</span><span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-o">.</span> <span class="tok-s">&quot;/tmp/tmp.lisp&quot;</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">content</span> <span class="tok-p">(</span><span class="tok-nb">nth</span> <span class="tok-mi">0</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet/lines</span> <span class="tok-nv">snp/file</span><span class="tok-p">))))</span>
      <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet/processed?</span> <span class="tok-nv">snp/file</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;^World\\nHello\\n&quot;</span> <span class="tok-nv">content</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nv">assert-true</span> <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;;; The end$&quot;</span> <span class="tok-nv">content</span><span class="tok-p">)))))</span>

<span class="tok-c1">;; (run-tests &#39;(test-include-snippet))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="tok-c1">;; Helpers</span>
<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">snippet-exists?</span> <span class="tok-p">(</span><span class="tok-nv">snippet</span> <span class="tok-nv">snippets</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Determines if the corresponding snippet is in `snippets&#39;.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nv">snippet</span> <span class="tok-nb">string</span> <span class="tok-nb">cons</span><span class="tok-p">)</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nb">typecase</span> <span class="tok-nv">snippet</span>
    <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">cons</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span>
     <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">name</span> <span class="tok-p">(</span><span class="tok-nb">typecase</span> <span class="tok-nv">snippet</span>
                   <span class="tok-p">(</span><span class="tok-nb">cons</span>    <span class="tok-p">(</span><span class="tok-nb">cdr</span> <span class="tok-nv">snippet</span><span class="tok-p">))</span>
                   <span class="tok-p">(</span><span class="tok-nv">snippet</span> <span class="tok-p">(</span><span class="tok-nv">snippet/name</span> <span class="tok-nv">snippet</span><span class="tok-p">))))</span>
           <span class="tok-p">(</span><span class="tok-k">type</span> <span class="tok-p">(</span><span class="tok-nb">typecase</span> <span class="tok-nv">snippet</span>
                   <span class="tok-p">(</span><span class="tok-nb">cons</span>    <span class="tok-p">(</span><span class="tok-nb">car</span> <span class="tok-nv">snippet</span><span class="tok-p">))</span>
                   <span class="tok-p">(</span><span class="tok-nv">snippet</span> <span class="tok-p">(</span><span class="tok-nv">snippet/type</span> <span class="tok-nv">snippet</span><span class="tok-p">)))))</span>
       <span class="tok-p">(</span><span class="tok-nb">case</span> <span class="tok-k">type</span>
         <span class="tok-p">(</span><span class="tok-ss">:code</span> <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nb">null</span> <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-nv">name</span> <span class="tok-p">(</span><span class="tok-nv">snippets/code</span> <span class="tok-nv">snippets</span><span class="tok-p">)))))</span>
         <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nb">null</span> <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-nv">name</span> <span class="tok-p">(</span><span class="tok-nv">snippets/file</span> <span class="tok-nv">snippets</span><span class="tok-p">))))))))</span>
    <span class="tok-p">(</span><span class="tok-nb">string</span>
     <span class="tok-p">(</span><span class="tok-nb">or</span> <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nb">null</span> <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-nv">snippet</span> <span class="tok-p">(</span><span class="tok-nv">snippets/code</span> <span class="tok-nv">snippets</span><span class="tok-p">))))</span>
         <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nb">null</span> <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-nv">snippet</span> <span class="tok-p">(</span><span class="tok-nv">snippets/file</span> <span class="tok-nv">snippets</span><span class="tok-p">))))))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-snippet-exists?</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">code/a</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;a&quot;</span> <span class="tok-ss">:type</span> <span class="tok-ss">:code</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">code/b</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;b&quot;</span> <span class="tok-ss">:type</span> <span class="tok-ss">:code</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">file/a</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;a&quot;</span> <span class="tok-ss">:type</span> <span class="tok-ss">:file</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">file/b</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;b&quot;</span> <span class="tok-ss">:type</span> <span class="tok-ss">:file</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">res</span> <span class="tok-p">(</span><span class="tok-nv">make-snippets</span><span class="tok-p">)))</span>
                     <span class="tok-p">(</span><span class="tok-nv">sethash</span> <span class="tok-s">&quot;a&quot;</span> <span class="tok-p">(</span><span class="tok-nv">snippets/code</span> <span class="tok-nv">res</span><span class="tok-p">)</span> <span class="tok-nv">code/a</span><span class="tok-p">)</span>
                     <span class="tok-p">(</span><span class="tok-nv">sethash</span> <span class="tok-s">&quot;a&quot;</span> <span class="tok-p">(</span><span class="tok-nv">snippets/file</span> <span class="tok-nv">res</span><span class="tok-p">)</span> <span class="tok-nv">file/a</span><span class="tok-p">)</span>
                     <span class="tok-nv">res</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet-exists?</span> <span class="tok-nv">code/a</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet-exists?</span> <span class="tok-nv">file/a</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet-exists?</span> <span class="tok-s">&quot;a&quot;</span>    <span class="tok-nv">snippets</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet-exists?</span> <span class="tok-o">`</span><span class="tok-p">(</span><span class="tok-ss">:code</span> <span class="tok-o">.</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet-exists?</span> <span class="tok-o">`</span><span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-o">.</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet-exists?</span> <span class="tok-o">`</span><span class="tok-p">(</span><span class="tok-ss">:code</span> <span class="tok-o">.</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet-exists?</span> <span class="tok-nv">code/b</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet-exists?</span> <span class="tok-nv">file/b</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippet-exists?</span> <span class="tok-s">&quot;b&quot;</span>    <span class="tok-nv">snippets</span><span class="tok-p">))))</span>

<span class="tok-c1">;; (run-tests &#39;(test-snippet-exists?))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">include-directive?</span> <span class="tok-p">(</span><span class="tok-nv">line</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Determines of the corresponding line is a include directive.  TODO: Make this extensible.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-nv">line</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-kt">boolean</span>
       <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">line</span> <span class="tok-p">(</span><span class="tok-nb">string-trim</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-sc">#\Space</span> <span class="tok-sc">#\e</span> <span class="tok-sc">#\t</span> <span class="tok-sc">#\m</span><span class="tok-p">)</span> <span class="tok-nv">line</span><span class="tok-p">)))</span>
         <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nb">null</span> <span class="tok-p">(</span><span class="tok-nb">or</span> <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;^[#;/-]{2} include::.*&quot;</span> <span class="tok-nv">line</span><span class="tok-p">)</span>
                        <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;^&lt;!-- include::.* --&gt;&quot;</span> <span class="tok-nv">line</span><span class="tok-p">)</span>
                        <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;^/\\* include::.* \\*/&quot;</span> <span class="tok-nv">line</span><span class="tok-p">)))))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-include-directive?</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-directive?</span> <span class="tok-s">&quot;  ;; include::&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-directive?</span> <span class="tok-s">&quot;;; include::&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-directive?</span> <span class="tok-s">&quot;a;; include::&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-directive?</span> <span class="tok-s">&quot;;; include::something&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-directive?</span> <span class="tok-s">&quot;## include::something&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-directive?</span> <span class="tok-s">&quot;// include::something&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-directive?</span> <span class="tok-s">&quot;/* include::something */&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-directive?</span> <span class="tok-s">&quot;&lt;!-- include::something --&gt;&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-eq</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::include-directive?</span> <span class="tok-s">&quot;a &lt;!-- include::something --&gt;&quot;</span><span class="tok-p">)))</span>

<span class="tok-c1">;; (run-tests &#39;(test-include-directive?))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">parse-include-directive</span> <span class="tok-p">(</span><span class="tok-nv">str</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Parses and extracts snippet name from an include directive.  See its tests</span>
<span class="tok-s">for detailed information on input/output format.  TODO: make this extensible.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-nv">str</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">the</span>
   <span class="tok-nb">string</span>
   <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">include-directive?</span> <span class="tok-nv">str</span><span class="tok-p">)</span>
       <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">input</span> <span class="tok-p">(</span><span class="tok-nb">cond</span> <span class="tok-p">((</span><span class="tok-nb">and</span> <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot; --&gt;$&quot;</span> <span class="tok-nv">str</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;^&lt;!-- &quot;</span> <span class="tok-nv">str</span><span class="tok-p">))</span>
                           <span class="tok-p">(</span><span class="tok-nb">subseq</span> <span class="tok-nv">str</span> <span class="tok-mi">0</span> <span class="tok-p">(</span><span class="tok-nb">-</span> <span class="tok-p">(</span><span class="tok-nb">length</span> <span class="tok-nv">str</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nb">length</span> <span class="tok-s">&quot; --&gt;&quot;</span><span class="tok-p">))))</span>
                          <span class="tok-p">((</span><span class="tok-nb">and</span> <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot; \\*/$&quot;</span> <span class="tok-nv">str</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">scan</span> <span class="tok-s">&quot;^/\\* &quot;</span> <span class="tok-nv">str</span><span class="tok-p">))</span>
                           <span class="tok-p">(</span><span class="tok-nb">subseq</span> <span class="tok-nv">str</span> <span class="tok-mi">0</span> <span class="tok-p">(</span><span class="tok-nb">-</span> <span class="tok-p">(</span><span class="tok-nb">length</span> <span class="tok-nv">str</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nb">length</span> <span class="tok-s">&quot; */&quot;</span><span class="tok-p">))))</span>
                          <span class="tok-p">(</span><span class="tok-no">t</span>
                           <span class="tok-nv">str</span><span class="tok-p">))))</span>
         <span class="tok-p">(</span><span class="tok-nb">multiple-value-bind</span> <span class="tok-p">(</span><span class="tok-nv">_</span> <span class="tok-nv">name/array</span><span class="tok-p">)</span>
             <span class="tok-p">(</span><span class="tok-nv">scan-to-strings</span> <span class="tok-s">&quot;include::(.*)$&quot;</span> <span class="tok-nv">input</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-k">ignore</span> <span class="tok-nv">_</span><span class="tok-p">))</span>
           <span class="tok-p">(</span><span class="tok-nb">elt</span> <span class="tok-nv">name/array</span> <span class="tok-mi">0</span><span class="tok-p">)))</span>
     <span class="tok-s">&quot;&quot;</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-include-directive</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::parse-include-directive</span> <span class="tok-s">&quot;  ;; include::&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::parse-include-directive</span> <span class="tok-s">&quot;;; include::&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::parse-include-directive</span>
                    <span class="tok-s">&quot;a &lt;!-- include::something --&gt;&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;something&quot;</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::parse-include-directive</span>
                             <span class="tok-s">&quot;;; include::something&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;something&quot;</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::parse-include-directive</span>
                             <span class="tok-s">&quot;## include::something&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;something&quot;</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::parse-include-directive</span>
                             <span class="tok-s">&quot;// include::something&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;something&quot;</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::parse-include-directive</span>
                             <span class="tok-s">&quot;/* include::something */&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;something&quot;</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::parse-include-directive</span>
                             <span class="tok-s">&quot;&lt;!-- include::something --&gt;&quot;</span><span class="tok-p">)))</span>

<span class="tok-c1">;; (run-tests &#39;(test-include-directive))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">snippets/get-snippet</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-k">&amp;key</span>
                                        <span class="tok-p">(</span><span class="tok-k">type</span> <span class="tok-ss">:code</span><span class="tok-p">)</span>
                                        <span class="tok-nv">name</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Helper to quickly retrieve a snippet from a `snippets&#39; struct.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-kt">keyword</span>  <span class="tok-k">type</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-nb">string</span>   <span class="tok-nv">name</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">hash</span> <span class="tok-p">(</span><span class="tok-nb">case</span> <span class="tok-k">type</span>
                <span class="tok-p">(</span><span class="tok-ss">:code</span> <span class="tok-p">(</span><span class="tok-nv">snippets/code</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
                <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-p">(</span><span class="tok-nv">snippets/file</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
                <span class="tok-p">(</span><span class="tok-nv">otherwise</span> <span class="tok-p">(</span><span class="tok-nb">make-hash-table</span><span class="tok-p">)))))</span>
    <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-p">(</span><span class="tok-nb">or</span> <span class="tok-kt">boolean</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nb">gethash</span> <span class="tok-nv">name</span> <span class="tok-nv">hash</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-snippets/get-snippet</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">snp/code/a</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:type</span> <span class="tok-ss">:code</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">snp/code/b</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:type</span> <span class="tok-ss">:code</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">snp/file/c</span> <span class="tok-p">(</span><span class="tok-nv">make-snippet</span> <span class="tok-ss">:type</span> <span class="tok-ss">:file</span> <span class="tok-ss">:name</span> <span class="tok-s">&quot;c.lisp&quot;</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">res</span> <span class="tok-p">(</span><span class="tok-nv">make-snippets</span><span class="tok-p">)))</span>
                     <span class="tok-p">(</span><span class="tok-nv">sethash</span> <span class="tok-s">&quot;a&quot;</span> <span class="tok-p">(</span><span class="tok-nv">snippets/code</span> <span class="tok-nv">res</span><span class="tok-p">)</span> <span class="tok-nv">snp/code/a</span><span class="tok-p">)</span>
                     <span class="tok-p">(</span><span class="tok-nv">sethash</span> <span class="tok-s">&quot;b&quot;</span> <span class="tok-p">(</span><span class="tok-nv">snippets/code</span> <span class="tok-nv">res</span><span class="tok-p">)</span> <span class="tok-nv">snp/code/b</span><span class="tok-p">)</span>
                     <span class="tok-p">(</span><span class="tok-nv">sethash</span> <span class="tok-s">&quot;c&quot;</span> <span class="tok-p">(</span><span class="tok-nv">snippets/file</span> <span class="tok-nv">res</span><span class="tok-p">)</span> <span class="tok-nv">snp/file/c</span><span class="tok-p">)</span>
                     <span class="tok-nv">res</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-nv">snp/code/a</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippets/get-snippet</span> <span class="tok-nv">snippets</span>
                                                             <span class="tok-ss">:type</span> <span class="tok-ss">:code</span>
                                                             <span class="tok-ss">:name</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-nv">snp/code/b</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippets/get-snippet</span> <span class="tok-nv">snippets</span>
                                                             <span class="tok-ss">:type</span> <span class="tok-ss">:code</span>
                                                             <span class="tok-ss">:name</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-nv">snp/file/c</span> <span class="tok-p">(</span><span class="tok-nv">ulquikit::snippets/get-snippet</span> <span class="tok-nv">snippets</span>
                                                             <span class="tok-ss">:type</span> <span class="tok-ss">:file</span>
                                                             <span class="tok-ss">:name</span> <span class="tok-s">&quot;c&quot;</span><span class="tok-p">))))</span>

<span class="tok-c1">;; (run-tests &#39;(test-snippets/get-snippet))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that concludes the most important functions of Ulquikit.  Those are used
to implement the higher-level <a href="#generate-source"><code>generate-src</code></a> functionality
right below.</p>
</div>
<div class="paragraph">
<p><a id="generate-src"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_generating_source_code">4.3. Generating source code</h3>
<div class="paragraph">
<p><code>generate-src</code> is a function taking 2 keyword arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>from</code> - where to read find literate source code, could be either a
directory or a file, and</p>
</li>
<li>
<p><code>to</code> - where to generate the source code to.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The literate source files are retrieved recursively from <code>from</code>.</p>
</div>
<div class="paragraph">
<p><a id="func/generate-src"></a></p>
</div>
<div class="listingblock">
<div class="title">code::generate-src</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">generate-src</span> <span class="tok-p">(</span><span class="tok-k">&amp;key</span> <span class="tok-p">(</span><span class="tok-nv">from</span> <span class="tok-s">&quot;src&quot;</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">to</span> <span class="tok-s">&quot;generated-src&quot;</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">recursive</span> <span class="tok-no">t</span><span class="tok-p">))</span>
  <span class="tok-s">&quot;Generates source code from all literate source files in `from&#39; to directory</span>
<span class="tok-s">`to&#39;.  `from&#39; is either a directory or a single literate source file.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span> <span class="tok-nb">list</span><span class="tok-p">)</span> <span class="tok-nv">from</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span> <span class="tok-nv">to</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">to</span>       <span class="tok-p">(</span><span class="tok-nv">full-path</span> <span class="tok-p">(</span><span class="tok-nv">uiop:ensure-directory-pathname</span> <span class="tok-nv">to</span><span class="tok-p">)))</span>
         <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-p">(</span><span class="tok-nb">typecase</span> <span class="tok-nv">from</span>
                     <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span>
                      <span class="tok-p">(</span><span class="tok-nv">extract-snippets</span> <span class="tok-nv">from</span> <span class="tok-ss">:recursive</span> <span class="tok-nv">recursive</span><span class="tok-p">))</span>
                     <span class="tok-p">(</span><span class="tok-nb">list</span>
                      <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">merge-snippets</span>
                             <span class="tok-p">(</span><span class="tok-nb">mapcar</span> <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">from</span><span class="tok-p">)</span>
                                         <span class="tok-p">(</span><span class="tok-nv">extract-snippets</span>
                                          <span class="tok-nv">from</span>
                                          <span class="tok-ss">:recursive</span> <span class="tok-nv">recursive</span><span class="tok-p">))</span>
                                     <span class="tok-nv">from</span><span class="tok-p">))))))</span>
    <span class="tok-c1">;; (format t &quot;Generating src from: ~A to: ~A~%&quot; from to)</span>
    <span class="tok-p">(</span><span class="tok-nv">write-src-files</span> <span class="tok-p">(</span><span class="tok-nv">include-file-snippets!</span> <span class="tok-nv">snippets</span><span class="tok-p">)</span> <span class="tok-nv">to</span><span class="tok-p">)))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="tok-c1">;; Helpers</span>
<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">write-src-files</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-nv">to</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Writes all source snippets as files to `to&#39;.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span> <span class="tok-nv">to</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">iter</span> <span class="tok-p">(</span><span class="tok-nv">for</span> <span class="tok-p">(</span><span class="tok-nv">name</span> <span class="tok-nv">snippet</span><span class="tok-p">)</span> <span class="tok-nv">in-hashtable</span> <span class="tok-p">(</span><span class="tok-nv">snippets/file</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">path</span> <span class="tok-p">(</span><span class="tok-nv">uiop:merge-pathnames*</span>
                     <span class="tok-nv">name</span>
                     <span class="tok-p">(</span><span class="tok-nv">uiop:merge-pathnames*</span>
                      <span class="tok-nv">to</span>
                      <span class="tok-p">(</span><span class="tok-nv">uiop:getcwd</span><span class="tok-p">))))</span>
              <span class="tok-p">(</span><span class="tok-nv">content</span> <span class="tok-p">(</span><span class="tok-nv">snippet-&gt;string</span> <span class="tok-nv">snippet</span><span class="tok-p">)))</span>
          <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">t</span> <span class="tok-s">&quot;Writing ~A~%&quot;</span> <span class="tok-nv">path</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-nb">ensure-directories-exist</span> <span class="tok-nv">path</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-nv">write-file</span> <span class="tok-nv">path</span> <span class="tok-nv">content</span><span class="tok-p">))))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>generate-src</code> function makes use a function, <code>include-file-snippets!</code>,
that we are about it to implement right below.  As the name suggests,
<code>include-file-snippets!</code> takes a list of snippets (of <code>snippets</code> struct) and
returns a new list with all file snippets
<a href="#section/include-snippets">included</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<code>include-file-snippets!</code> is destructive for the same reason
<a href="#func/include-snippet"><code>include-snippet!</code></a> is destructive.  Make sure you
don&#8217;t create unwanted side effects when using it directly.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">code::include-file-snippets</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">include-file-snippets!</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Includes all file snippets in `snippets&#39; and return a `snippets&#39; with all</span>
<span class="tok-s">file snippets included.  Note that this function is destructive.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nv">snippets</span> <span class="tok-nv">snippets</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">file-snippets</span> <span class="tok-p">(</span><span class="tok-nv">snippets/file</span> <span class="tok-nv">snippets</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nv">iter</span> <span class="tok-p">(</span><span class="tok-nv">for</span> <span class="tok-p">(</span><span class="tok-nv">name</span> <span class="tok-nv">_</span><span class="tok-p">)</span> <span class="tok-nv">in-hashtable</span> <span class="tok-nv">file-snippets</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-nv">include-snippet!</span> <span class="tok-nv">snippets</span> <span class="tok-o">`</span><span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-nv">name</span><span class="tok-p">))))</span>
  <span class="tok-nv">snippets</span><span class="tok-p">)</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>And of course, we need help string for <code>generate-src</code> command that we&#8217;ll talk
about right away:</p>
</div>
<div class="listingblock">
<div class="title">file::commands/generate-src.help.txt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="text">Usage: ulqui generate-src [--from from] [--to to] [--recursive recursive]

Generate source code from literate documents.

  --from       either path to a directory where literate documents are stored, or list of paths to literate documents; default: &quot;src/&quot;
  --to         directory where source code are generated to; default: &quot;generated-src/&quot;
  --recursive  either the literate documents are searched recursively or non-recursively; default: &quot;true&quot;

Examples

Generate source code from src/ to generated-src/ recursively
  ulqui generate-src

or explitcitly
  ulqui generate-src --from src/ --to generated-src/ --recursive true

Generate source code from literate-source/ to source/ non-recursively
  ulqui generate-src --from literate-source/ --to source/ --recursive false

Generate source code from Foo.adoc and quux/ to source/ recursively
  ulqui generate-src --from Foo.adoc quux/ --to source/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all functions are ready, let&#8217;s put them together into a command to
generate source code.  The <code>generate-src</code> command might look like so:</p>
</div>
<div class="listingblock">
<div class="title">file::commands/generate-src.lisp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</div></td><td class="code"><span></span><span class="tok-c1">;; include::license-header</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-cmd</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">defcmd</span> <span class="tok-nv">generate-src</span> <span class="tok-p">(</span><span class="tok-k">&amp;key</span> <span class="tok-p">(</span><span class="tok-nv">from</span> <span class="tok-s">&quot;src&quot;</span><span class="tok-p">)</span>
                           <span class="tok-p">(</span><span class="tok-nv">to</span> <span class="tok-s">&quot;generated-src&quot;</span><span class="tok-p">)</span>
                           <span class="tok-p">(</span><span class="tok-nv">recursive</span> <span class="tok-no">t</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span> <span class="tok-nb">list</span><span class="tok-p">)</span> <span class="tok-nv">from</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span> <span class="tok-nv">to</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">display-cmd</span> <span class="tok-s">&quot;Generating source&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">ulquikit:generate-src</span> <span class="tok-ss">:from</span> <span class="tok-nv">from</span> <span class="tok-ss">:to</span> <span class="tok-nv">to</span> <span class="tok-ss">:recursive</span> <span class="tok-nv">recursive</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course we need to define the <code>ulquikit-cmd</code> package that holds all Ulquikit
commands:</p>
</div>
<div class="listingblock">
<div class="title">file::ulquikit-cmd.lisp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6</div></td><td class="code"><span></span><span class="tok-c1">;; include::license-header</span>

<span class="tok-p">(</span><span class="tok-nb">defpackage</span> <span class="tok-ss">#:ulquikit-cmd</span>
  <span class="tok-p">(</span><span class="tok-ss">:use</span> <span class="tok-ss">:cl</span> <span class="tok-ss">:command-core</span> <span class="tok-ss">:cl-ppcre</span> <span class="tok-ss">:ulqui/utils</span><span class="tok-p">))</span>

<span class="tok-c1">;; include::ulquikit-cmd/main</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s generalize this idea for other commands.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_anatomy_of_a_ulquikit_command">5. Anatomy of a Ulquikit command</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Ulquikit command is a function that only has keyword arguments residing in
<code>ulquikit-cmd</code> package.  Its keyword arguments correspond to their
command-line counterparts.  This makes implementing a new command very
simple - just by adding a function to <code>ulquikit-cmd</code>.  With Common Lisp&#8217;s
powerful retrospection ability, commands could be inspected and extended very
easily as well.</p>
</div>
<div class="paragraph">
<p>Each command has their own source file in the <code>commands/</code> directory and is
defined with the <a href="#defcmd"><code>defcmd</code></a> macro.  This macro:
. generates the actual function corresponding to a command,
. assigns the help text from <code>commands/&lt;command-name&gt;.help.txt</code> as its
  documentation,
. and adds it to the command list (represented by the <code><strong>command-list</strong></code>
  variable in the corresponding package that where the function resides).</p>
</div>
<div class="paragraph">
<p>Commands are then loaded in alphabetical order of their source code files.
This way, one can override commands by adding another definition at later
stage.  Commands must have help.  It is recommended that functions
corresponding to a command is not exported.</p>
</div>
<div class="paragraph">
<p>When used as a command line argument tool, Ulquikit command invocation works
as followed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Command line arguments are parsed and passed with utilities in
<code>command-core</code> package:</p>
<div class="paragraph">
<p>E.g.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ulqui generate-src</code> calls <code>(ulquikit-cmd::generate-src)</code>.</p>
</li>
<li>
<p><code>ulqui generate-src some-file</code> calls <code>(ulquikit-cmd::generate-src
"some-file")</code>.</p>
</li>
<li>
<p><code>ulqui generate-src --from file1 --to file2</code> calls <code>(ulquikit-cmd::generate-src :from
"file1" :to "file2")</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>When <code>ulqui help command-name</code> or <code>ulqui command-name --help</code> is invoked,
<code>(command-core:help "command-name" :ulquikit-cmd)</code> is called.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s move on to utilities that are used to parse command line arguments.</p>
</div>
<div class="sect2">
<h3 id="_parsing_command_line_arguments_with_code_parse_cmd_args_code">5.1. Parsing command line arguments with <code>parse-cmd-args</code></h3>
<div class="paragraph">
<p>This function takes all arguments passed to the command line as a list of
strings and returns an alist as such:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2</div></td><td class="code"><span></span><span class="tok-p">((</span><span class="tok-ss">:arguments</span> <span class="tok-o">.</span> <span class="tok-nv">list-of-arguments</span><span class="tok-p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
 <span class="tok-p">(</span><span class="tok-ss">:options</span>   <span class="tok-o">.</span> <span class="tok-nv">alist-of-options</span><span class="tok-p">))</span> <i class="conum" data-value="2"></i><b>(2)</b>
</td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>main arguments collected as a list, with the same order as they are at the
command line</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>options are collected as alist; options that have no values are set to <code>t</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Ulquikit, options are prefixed with one or two dashes (<code>-</code> or <code>--</code>), while
arguments are not.  Option values are attempted to parse as number or boolean
(e.g. in case of <code>1</code>, <code>t</code>, <code>true</code>, <code>false</code>, &#8230;&#8203;).  See the test section of the
implementation below for detailed information.</p>
</div>
<div class="paragraph">
<p>The <code>command-core</code> package and its test counterpart could thus be declared
like so:</p>
</div>
<div class="listingblock">
<div class="title">code::define-command-core-package</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:cl</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defpackage</span> <span class="tok-ss">#:command-core</span>
  <span class="tok-p">(</span><span class="tok-ss">:use</span> <span class="tok-ss">:cl</span> <span class="tok-ss">:ulqui/utils</span> <span class="tok-ss">:iterate</span> <span class="tok-ss">:trivial-utf-8</span> <span class="tok-ss">:split-sequence</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-ss">:export</span> <span class="tok-ss">#:parse-cmd-args</span>
           <span class="tok-ss">#:argument?</span>
           <span class="tok-ss">#:option?</span>
           <span class="tok-ss">#:option-&gt;keyword</span>
           <span class="tok-ss">#:defcmd</span>
           <span class="tok-ss">#:run-cmd</span>
           <span class="tok-ss">#:display-cmd</span>
           <span class="tok-ss">#:run-help</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">defpackage</span> <span class="tok-ss">#:command-core-tests</span>
  <span class="tok-p">(</span><span class="tok-ss">:use</span> <span class="tok-ss">:cl</span> <span class="tok-ss">:lisp-unit</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-nv">lisp-unit:*print-failures*</span> <span class="tok-no">t</span>
      <span class="tok-nv">lisp-unit:*print-errors*</span>   <span class="tok-no">t</span><span class="tok-p">)</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">code::parse-command-line-arguments</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">parse-cmd-args</span> <span class="tok-p">(</span><span class="tok-nv">args</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">arguments</span> <span class="tok-p">(</span><span class="tok-nv">take-while</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">argument?</span> <span class="tok-nv">args</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nv">rest-args</span> <span class="tok-p">(</span><span class="tok-nv">drop-while</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">argument?</span> <span class="tok-nv">args</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-k">labels</span> <span class="tok-p">((</span><span class="tok-nv">parse-options</span> <span class="tok-p">(</span><span class="tok-nv">rest-args</span> <span class="tok-nv">current-opts</span><span class="tok-p">)</span>
               <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">list</span> <span class="tok-nv">rest-args</span> <span class="tok-nv">current-opts</span><span class="tok-p">))</span>
               <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nb">null</span> <span class="tok-nv">rest-args</span><span class="tok-p">)</span>

                   <span class="tok-c1">;; No more option to parse</span>
                   <span class="tok-nv">current-opts</span>

                 <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">option-name</span>   <span class="tok-p">(</span><span class="tok-nb">first</span> <span class="tok-nv">rest-args</span><span class="tok-p">))</span>
                        <span class="tok-p">(</span><span class="tok-nv">option-values</span> <span class="tok-p">(</span><span class="tok-nv">take-while</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">argument?</span> <span class="tok-p">(</span><span class="tok-nb">rest</span> <span class="tok-nv">rest-args</span><span class="tok-p">)))</span>
                        <span class="tok-p">(</span><span class="tok-nv">rest-args</span>     <span class="tok-p">(</span><span class="tok-nv">drop-while</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">argument?</span> <span class="tok-p">(</span><span class="tok-nb">rest</span> <span class="tok-nv">rest-args</span><span class="tok-p">)))</span>

                        <span class="tok-p">(</span><span class="tok-nv">option-values/converted</span> <span class="tok-p">(</span><span class="tok-nb">mapcar</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">try-convert-value</span> <span class="tok-nv">option-values</span><span class="tok-p">))</span>
                        <span class="tok-p">(</span><span class="tok-nv">option-name/keyword</span>     <span class="tok-p">(</span><span class="tok-nv">option-&gt;keyword</span> <span class="tok-nv">option-name</span><span class="tok-p">))</span>

                        <span class="tok-p">(</span><span class="tok-nv">option-values/res</span>
                         <span class="tok-p">(</span><span class="tok-nb">cond</span>
                           <span class="tok-p">((</span><span class="tok-nb">null</span> <span class="tok-nv">option-values</span><span class="tok-p">)</span>         <span class="tok-c1">;; --help → (:help . t)</span>
                            <span class="tok-no">t</span><span class="tok-p">)</span>

                           <span class="tok-p">((</span><span class="tok-nb">=</span> <span class="tok-mi">1</span> <span class="tok-p">(</span><span class="tok-nb">length</span> <span class="tok-nv">option-values</span><span class="tok-p">))</span> <span class="tok-c1">;; --help a → (:help . &quot;a&quot;)</span>
                            <span class="tok-p">(</span><span class="tok-nb">first</span> <span class="tok-nv">option-values/converted</span><span class="tok-p">))</span> <span class="tok-c1">;</span>

                           <span class="tok-p">(</span><span class="tok-no">t</span>                            <span class="tok-c1">;; --help a b → (:help . (&quot;a&quot; &quot;b&quot;))</span>
                            <span class="tok-nv">option-values/converted</span><span class="tok-p">)))</span>

                        <span class="tok-p">(</span><span class="tok-nv">new-option</span> <span class="tok-p">(</span><span class="tok-nb">cons</span> <span class="tok-nv">option-name/keyword</span> <span class="tok-nv">option-values/res</span><span class="tok-p">)))</span>
                   <span class="tok-p">(</span><span class="tok-nv">parse-options</span> <span class="tok-nv">rest-args</span>
                                  <span class="tok-p">(</span><span class="tok-nb">push</span> <span class="tok-nv">new-option</span>
                                        <span class="tok-nv">current-opts</span><span class="tok-p">))))))</span>
      <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-ss">:arguments</span> <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-nv">arguments</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-ss">:options</span>   <span class="tok-o">.</span> <span class="tok-o">,</span><span class="tok-p">(</span><span class="tok-nv">parse-options</span> <span class="tok-nv">rest-args</span> <span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-p">)))))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-parse-cmd-args</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-ss">:arguments</span> <span class="tok-o">.</span> <span class="tok-p">())</span>
                  <span class="tok-p">(</span><span class="tok-ss">:options</span>   <span class="tok-o">.</span> <span class="tok-p">()))</span>
                <span class="tok-p">(</span><span class="tok-nv">parse-cmd-args</span> <span class="tok-o">&#39;</span><span class="tok-p">()))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-ss">:arguments</span> <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-s">&quot;hello-world&quot;</span><span class="tok-p">))</span>
                  <span class="tok-p">(</span><span class="tok-ss">:options</span>   <span class="tok-o">.</span> <span class="tok-p">()))</span>
                <span class="tok-p">(</span><span class="tok-nv">parse-cmd-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello-world&quot;</span><span class="tok-p">)))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-ss">:arguments</span> <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;world&quot;</span><span class="tok-p">))</span>
                  <span class="tok-p">(</span><span class="tok-ss">:options</span>   <span class="tok-o">.</span> <span class="tok-p">()))</span>
                <span class="tok-p">(</span><span class="tok-nv">parse-cmd-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;world&quot;</span><span class="tok-p">)))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-ss">:arguments</span> <span class="tok-o">.</span> <span class="tok-p">())</span>
                  <span class="tok-p">(</span><span class="tok-ss">:options</span>   <span class="tok-o">.</span> <span class="tok-p">((</span><span class="tok-ss">:help</span> <span class="tok-o">.</span> <span class="tok-no">t</span><span class="tok-p">))))</span>
                <span class="tok-p">(</span><span class="tok-nv">parse-cmd-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;--help&quot;</span><span class="tok-p">)))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-ss">:arguments</span> <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span><span class="tok-p">))</span>
                  <span class="tok-p">(</span><span class="tok-ss">:options</span>   <span class="tok-o">.</span> <span class="tok-p">((</span><span class="tok-ss">:help</span> <span class="tok-o">.</span> <span class="tok-no">t</span><span class="tok-p">))))</span>
                <span class="tok-p">(</span><span class="tok-nv">parse-cmd-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;--help&quot;</span><span class="tok-p">)))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-ss">:arguments</span> <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span><span class="tok-p">))</span>
                  <span class="tok-p">(</span><span class="tok-ss">:options</span>   <span class="tok-o">.</span> <span class="tok-p">((</span><span class="tok-ss">:help</span> <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-s">&quot;world&quot;</span> <span class="tok-s">&quot;args&quot;</span><span class="tok-p">)))))</span>
                <span class="tok-p">(</span><span class="tok-nv">parse-cmd-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;--help&quot;</span> <span class="tok-s">&quot;world&quot;</span> <span class="tok-s">&quot;args&quot;</span><span class="tok-p">)))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-ss">:arguments</span> <span class="tok-o">.</span> <span class="tok-p">())</span>
                  <span class="tok-p">(</span><span class="tok-ss">:options</span>   <span class="tok-o">.</span> <span class="tok-p">((</span><span class="tok-ss">:help</span> <span class="tok-o">.</span> <span class="tok-s">&quot;hello&quot;</span><span class="tok-p">))))</span>
                <span class="tok-p">(</span><span class="tok-nv">parse-cmd-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;--help&quot;</span> <span class="tok-s">&quot;hello&quot;</span><span class="tok-p">)))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-ss">:arguments</span> <span class="tok-o">.</span> <span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;world&quot;</span><span class="tok-p">))</span>
                  <span class="tok-p">(</span><span class="tok-ss">:options</span>   <span class="tok-o">.</span> <span class="tok-p">((</span><span class="tok-ss">:set-tab</span> <span class="tok-o">.</span> <span class="tok-mi">4</span><span class="tok-p">)</span>
                                 <span class="tok-p">(</span><span class="tok-ss">:help</span>    <span class="tok-o">.</span> <span class="tok-no">t</span><span class="tok-p">))))</span>
                <span class="tok-p">(</span><span class="tok-nv">parse-cmd-args</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-s">&quot;hello&quot;</span> <span class="tok-s">&quot;world&quot;</span> <span class="tok-s">&quot;--help&quot;</span> <span class="tok-s">&quot;--set-tab&quot;</span> <span class="tok-s">&quot;4&quot;</span><span class="tok-p">))))</span>

<span class="tok-c1">;; (run-tests &#39;(test-parse-cmd-args))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="tok-c1">;; Helpers</span>
<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">argument?</span> <span class="tok-p">(</span><span class="tok-nv">str</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Determines if a string is considered an argument.  An argument is not</span>
<span class="tok-s">prefixed with a dash \&quot;-\&quot;.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-nv">str</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-kt">boolean</span> <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nv">alexandria:starts-with</span> <span class="tok-sc">#\-</span> <span class="tok-nv">str</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-argument?</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">argument?</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">argument?</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">argument?</span> <span class="tok-s">&quot;-a&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">argument?</span> <span class="tok-s">&quot;--a&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">argument?</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">)))</span>

<span class="tok-c1">;; (run-tests &#39;(test-argument?))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">option?</span> <span class="tok-p">(</span><span class="tok-nv">str</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Determines if a string is considered an option.  An option is prefixed with</span>
<span class="tok-s">a dash \&quot;-\&quot;.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-nv">str</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-kt">boolean</span> <span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nv">argument?</span> <span class="tok-nv">str</span><span class="tok-p">))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-option?</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">option?</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">nil</span> <span class="tok-p">(</span><span class="tok-nv">option?</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">option?</span> <span class="tok-s">&quot;-a&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">option?</span> <span class="tok-s">&quot;--a&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">t</span>   <span class="tok-p">(</span><span class="tok-nv">option?</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">)))</span>

<span class="tok-c1">;; (run-tests &#39;(test-option?))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">option-&gt;keyword</span> <span class="tok-p">(</span><span class="tok-nv">opt</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Converts option as string to Common Lisp keyword.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nc">symbol</span> <span class="tok-nb">string</span><span class="tok-p">)</span> <span class="tok-nv">opt</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-kt">keyword</span>
       <span class="tok-p">(</span><span class="tok-nb">typecase</span> <span class="tok-nv">opt</span>
         <span class="tok-p">(</span><span class="tok-kt">keyword</span> <span class="tok-nv">opt</span><span class="tok-p">)</span>
         <span class="tok-p">(</span><span class="tok-nc">symbol</span>  <span class="tok-p">(</span><span class="tok-nb">intern</span> <span class="tok-p">(</span><span class="tok-nb">symbol-name</span> <span class="tok-nv">opt</span><span class="tok-p">)</span> <span class="tok-ss">:keyword</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nb">string</span>  <span class="tok-p">(</span><span class="tok-nb">multiple-value-bind</span> <span class="tok-p">(</span><span class="tok-nv">_</span> <span class="tok-nv">xs</span><span class="tok-p">)</span>
                      <span class="tok-p">(</span><span class="tok-nv">cl-ppcre:scan-to-strings</span> <span class="tok-s">&quot;^-+(.+)$&quot;</span> <span class="tok-nv">opt</span><span class="tok-p">)</span>
                    <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-k">ignore</span> <span class="tok-nv">_</span><span class="tok-p">))</span>
                    <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nb">zerop</span> <span class="tok-p">(</span><span class="tok-nb">length</span> <span class="tok-nv">xs</span><span class="tok-p">))</span>
                        <span class="tok-p">(</span><span class="tok-nb">error</span> <span class="tok-s">&quot;~S is not a valid argument&quot;</span> <span class="tok-nv">opt</span><span class="tok-p">)</span>
                      <span class="tok-p">(</span><span class="tok-nb">intern</span> <span class="tok-p">(</span><span class="tok-nb">string-upcase</span> <span class="tok-p">(</span><span class="tok-nb">aref</span> <span class="tok-nv">xs</span> <span class="tok-mi">0</span><span class="tok-p">))</span> <span class="tok-ss">:keyword</span><span class="tok-p">)))))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-option-&gt;keyword</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-ss">:h</span>       <span class="tok-p">(</span><span class="tok-nv">option-&gt;keyword</span> <span class="tok-s">&quot;-h&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-ss">:help</span>    <span class="tok-p">(</span><span class="tok-nv">option-&gt;keyword</span> <span class="tok-s">&quot;--help&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-ss">:help</span>    <span class="tok-p">(</span><span class="tok-nv">option-&gt;keyword</span> <span class="tok-s">&quot;---help&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-ss">:help-me</span> <span class="tok-p">(</span><span class="tok-nv">option-&gt;keyword</span> <span class="tok-s">&quot;---help-me&quot;</span><span class="tok-p">)))</span>

<span class="tok-c1">;; (run-tests &#39;(test-option-&gt;keyword))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">try-convert-value</span> <span class="tok-p">(</span><span class="tok-nv">value</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Tries converting a string value as number, boolean, or returns itself.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-nv">value</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nb">cond</span> <span class="tok-p">((</span><span class="tok-nb">string-equal</span> <span class="tok-s">&quot;true&quot;</span> <span class="tok-nv">value</span><span class="tok-p">)</span> <span class="tok-no">t</span><span class="tok-p">)</span>
        <span class="tok-p">((</span><span class="tok-nb">string-equal</span> <span class="tok-s">&quot;false&quot;</span> <span class="tok-nv">value</span><span class="tok-p">)</span> <span class="tok-no">nil</span><span class="tok-p">)</span>
        <span class="tok-p">((</span><span class="tok-nb">string-equal</span> <span class="tok-s">&quot;t&quot;</span> <span class="tok-nv">value</span><span class="tok-p">)</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span>
        <span class="tok-p">((</span><span class="tok-nb">string-equal</span> <span class="tok-s">&quot;nil&quot;</span> <span class="tok-nv">value</span><span class="tok-p">)</span> <span class="tok-s">&quot;nil&quot;</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-no">t</span> <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">res</span> <span class="tok-p">(</span><span class="tok-nb">read-from-string</span> <span class="tok-nv">value</span><span class="tok-p">)))</span>
             <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nb">numberp</span> <span class="tok-nv">res</span><span class="tok-p">)</span>
                 <span class="tok-nv">res</span>
               <span class="tok-nv">value</span><span class="tok-p">)))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-try-convert-value</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-mi">1</span>    <span class="tok-p">(</span><span class="tok-nv">command-core::try-convert-value</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;a&quot;</span>  <span class="tok-p">(</span><span class="tok-nv">command-core::try-convert-value</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">t</span>    <span class="tok-p">(</span><span class="tok-nv">command-core::try-convert-value</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">t</span>    <span class="tok-p">(</span><span class="tok-nv">command-core::try-convert-value</span> <span class="tok-s">&quot;true&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-no">nil</span>  <span class="tok-p">(</span><span class="tok-nv">command-core::try-convert-value</span> <span class="tok-s">&quot;false&quot;</span><span class="tok-p">)))</span>

<span class="tok-c1">;; (run-tests &#39;(test-try-convert-value))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_calling_corresponding_command">5.2. Calling corresponding command</h3>
<div class="paragraph">
<p>When user invokes a command, the corresponding function gets called.  This is
the job of the <code>run-cmd</code> command function, which also serves as the main
helper for Ulquikit&#8217;s entrypoint later on when we build Ulquikit as a single
executable.</p>
</div>
<div class="paragraph">
<p>To make Ulquikit as user-friendly as possible, when a user executes as invalid
commands, s/he would be presented with an error message, a help message, and a
non-zero exit code.</p>
</div>
<div class="listingblock">
<div class="title">code::run-command</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">run-cmd</span> <span class="tok-p">(</span><span class="tok-nv">cmd</span> <span class="tok-nv">args</span> <span class="tok-k">&amp;key</span> <span class="tok-p">(</span><span class="tok-nc">package</span> <span class="tok-ss">:ulquikit-cmd</span><span class="tok-p">))</span>
  <span class="tok-s">&quot;Runs command with appropriate arguments by calling the corresponding</span>
<span class="tok-s">function (that shares the same name as the command) in `ulquikit-cmd&#39;</span>
<span class="tok-s">package.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nc">symbol</span> <span class="tok-nc">package</span><span class="tok-p">)</span> <span class="tok-nv">cmd</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-nb">list</span> <span class="tok-nv">args</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">func</span> <span class="tok-p">(</span><span class="tok-nv">get-function</span> <span class="tok-nv">cmd</span> <span class="tok-nc">package</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nb">handler-case</span> <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nv">func</span> <span class="tok-nv">args</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-kt">program-error</span> <span class="tok-p">(</span><span class="tok-kt">condition</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-kt">condition</span> <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">nil</span> <span class="tok-s">&quot;~A&quot;</span> <span class="tok-kt">condition</span><span class="tok-p">)))</span>
          <span class="tok-p">(</span><span class="tok-nb">when</span> <span class="tok-p">(</span><span class="tok-nb">search</span> <span class="tok-s">&quot;argument&quot;</span> <span class="tok-kt">condition</span><span class="tok-p">)</span>
            <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-vg">*error-output*</span> <span class="tok-s">&quot;~A~%~%&quot;</span> <span class="tok-kt">condition</span><span class="tok-p">)</span>
            <span class="tok-p">(</span><span class="tok-nv">run-help</span> <span class="tok-nv">cmd</span> <span class="tok-nc">package</span><span class="tok-p">)</span>
            <span class="tok-p">(</span><span class="tok-nv">uiop:quit</span> <span class="tok-mi">1</span><span class="tok-p">)))))))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="tok-c1">;; Helpers</span>
<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">get-function</span> <span class="tok-p">(</span><span class="tok-nv">func</span> <span class="tok-k">&amp;optional</span> <span class="tok-p">(</span><span class="tok-nc">package</span> <span class="tok-vg">*package*</span><span class="tok-p">))</span>
  <span class="tok-s">&quot;Retrieves a function from a package or throws error if not found.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nc">symbol</span> <span class="tok-k">function</span><span class="tok-p">)</span> <span class="tok-nv">func</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nc">symbol</span> <span class="tok-nc">package</span><span class="tok-p">)</span> <span class="tok-nc">package</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nc">package</span> <span class="tok-p">(</span><span class="tok-nb">find-package</span> <span class="tok-p">(</span><span class="tok-nb">typecase</span> <span class="tok-nc">package</span>
                                  <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-p">(</span><span class="tok-nb">string-upcase</span> <span class="tok-nc">package</span><span class="tok-p">))</span>
                                  <span class="tok-p">(</span><span class="tok-nv">otherwise</span> <span class="tok-nc">package</span><span class="tok-p">))))</span>
         <span class="tok-p">(</span><span class="tok-nv">func</span> <span class="tok-p">(</span><span class="tok-nb">typecase</span> <span class="tok-nv">func</span>
                 <span class="tok-p">(</span><span class="tok-nb">string</span>    <span class="tok-p">(</span><span class="tok-nb">fdefinition</span>
                             <span class="tok-p">(</span><span class="tok-nb">find-symbol</span> <span class="tok-p">(</span><span class="tok-nb">string-upcase</span> <span class="tok-nv">func</span><span class="tok-p">)</span>
                                          <span class="tok-nc">package</span><span class="tok-p">)))</span>
                 <span class="tok-p">(</span><span class="tok-nc">symbol</span>    <span class="tok-p">(</span><span class="tok-nb">fdefinition</span>
                             <span class="tok-p">(</span><span class="tok-nb">find-symbol</span> <span class="tok-p">(</span><span class="tok-nb">symbol-name</span> <span class="tok-nv">func</span><span class="tok-p">)</span>
                                          <span class="tok-nc">package</span><span class="tok-p">)))</span>
                 <span class="tok-p">(</span><span class="tok-nv">otherwise</span> <span class="tok-nv">func</span><span class="tok-p">))))</span>
    <span class="tok-nv">func</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-get-function</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">command-core:run-cmd</span> <span class="tok-p">(</span><span class="tok-nv">command-core::get-function</span> <span class="tok-s">&quot;RUN-CMD&quot;</span> <span class="tok-s">&quot;COMMAND-CORE&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">command-core:run-cmd</span> <span class="tok-p">(</span><span class="tok-nv">command-core::get-function</span> <span class="tok-ss">&#39;run-cmd</span> <span class="tok-s">&quot;COMMAND-CORE&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">command-core:run-cmd</span> <span class="tok-p">(</span><span class="tok-nv">command-core::get-function</span> <span class="tok-ss">:run-cmd</span> <span class="tok-ss">:command-core</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-error</span> <span class="tok-ss">&#39;undefined-function</span> <span class="tok-p">(</span><span class="tok-nv">command-core::get-function</span> <span class="tok-ss">:doesnt-exist</span> <span class="tok-ss">:command-core</span><span class="tok-p">)))</span>

<span class="tok-c1">;; (run-tests &#39;(test-get-function))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also have <code>run-help</code> to display help of a command.  <code>run-help</code> simply prints to
the screen the documentation of the function corresponding to that command.</p>
</div>
<div class="listingblock">
<div class="title">code::run-command-help</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">run-help</span> <span class="tok-p">(</span><span class="tok-nv">cmd</span> <span class="tok-k">&amp;optional</span> <span class="tok-p">(</span><span class="tok-nc">package</span> <span class="tok-vg">*package*</span><span class="tok-p">))</span>
  <span class="tok-s">&quot;Reads and returns the help of a command, which is the documentation string</span>
<span class="tok-s">of the corresponding function.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nc">symbol</span><span class="tok-p">)</span> <span class="tok-nv">cmd</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nc">symbol</span> <span class="tok-nc">package</span><span class="tok-p">)</span> <span class="tok-nc">package</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">cmd-package</span> <span class="tok-p">(</span><span class="tok-nb">find-package</span> <span class="tok-nc">package</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">run-func</span>    <span class="tok-p">(</span><span class="tok-nb">intern</span> <span class="tok-p">(</span><span class="tok-nb">string-upcase</span> <span class="tok-nv">cmd</span><span class="tok-p">)</span> <span class="tok-nv">cmd-package</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">help-text</span>   <span class="tok-p">(</span><span class="tok-nb">documentation</span> <span class="tok-nv">run-func</span> <span class="tok-ss">&#39;function</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nb">and</span> <span class="tok-nv">help-text</span> <span class="tok-p">(</span><span class="tok-nb">&gt;</span> <span class="tok-p">(</span><span class="tok-nb">length</span> <span class="tok-nv">help-text</span><span class="tok-p">)</span> <span class="tok-mi">0</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">t</span> <span class="tok-s">&quot;~A~%&quot;</span> <span class="tok-nv">help-text</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-k">progn</span>
        <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-vg">*error-output*</span>
                <span class="tok-s">&quot;No help available for ~A.  Are you sure it&#39;s the right command?~%&quot;</span>
                <span class="tok-nv">cmd</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">uiop:quit</span> <span class="tok-mi">2</span><span class="tok-p">)))))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, we need the <code>defcmd</code> macro.</p>
</div>
<div class="paragraph">
<p><a id="defcmd"></a></p>
</div>
<div class="listingblock">
<div class="title">code::defcmd</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defmacro</span> <span class="tok-nv">defcmd</span> <span class="tok-p">(</span><span class="tok-nv">name</span> <span class="tok-nv">list-args</span> <span class="tok-k">&amp;rest</span> <span class="tok-nv">body</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">command-core-path</span> <span class="tok-p">(</span><span class="tok-nb">or</span> <span class="tok-vg">*load-pathname*</span> <span class="tok-vg">*compile-file-pathname*</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">name-downcase</span> <span class="tok-p">(</span><span class="tok-nb">string-downcase</span> <span class="tok-nv">name</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">help-file</span> <span class="tok-p">(</span><span class="tok-nv">uiop:merge-pathnames*</span> <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">nil</span>
                                                   <span class="tok-s">&quot;~A.help.txt&quot;</span>
                                                   <span class="tok-nv">name-downcase</span><span class="tok-p">)</span>
                                           <span class="tok-nv">command-core-path</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">help-content</span> <span class="tok-p">(</span><span class="tok-nv">read-file</span> <span class="tok-nv">help-file</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">description</span> <span class="tok-p">(</span><span class="tok-nb">nth</span> <span class="tok-mi">2</span> <span class="tok-p">(</span><span class="tok-nv">split-sequence</span> <span class="tok-sc">#\Newline</span>
                                             <span class="tok-nv">help-content</span><span class="tok-p">)))</span>
         <span class="tok-p">(</span><span class="tok-nv">command-list-symb</span> <span class="tok-p">(</span><span class="tok-nb">intern</span> <span class="tok-s">&quot;*COMMAND-LIST*&quot;</span> <span class="tok-vg">*package*</span><span class="tok-p">)))</span>
    <span class="tok-o">`</span><span class="tok-p">(</span><span class="tok-k">progn</span> <span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-o">,</span><span class="tok-nv">name</span> <span class="tok-o">,</span><span class="tok-nv">list-args</span>
              <span class="tok-o">,</span><span class="tok-nv">help-content</span>
              <span class="tok-o">,@</span><span class="tok-nv">body</span><span class="tok-p">)</span>

            <span class="tok-c1">;; Add command to the command list of the current package</span>
            <span class="tok-p">(</span><span class="tok-nb">defvar</span> <span class="tok-o">,</span><span class="tok-nv">command-list-symb</span> <span class="tok-o">&#39;</span><span class="tok-p">())</span>
            <span class="tok-p">(</span><span class="tok-nb">setf</span> <span class="tok-o">,</span><span class="tok-nv">command-list-symb</span>
                  <span class="tok-p">(</span><span class="tok-nb">remove-if</span> <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">cmd&amp;desc</span><span class="tok-p">)</span>
                                 <span class="tok-p">(</span><span class="tok-nb">string=</span> <span class="tok-p">(</span><span class="tok-nv">alist-get</span> <span class="tok-nv">cmd&amp;desc</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
                                          <span class="tok-o">,</span><span class="tok-nv">name-downcase</span><span class="tok-p">))</span>
                             <span class="tok-o">,</span><span class="tok-nv">command-list-symb</span><span class="tok-p">))</span>
            <span class="tok-p">(</span><span class="tok-nb">push</span> <span class="tok-o">`</span><span class="tok-p">((</span><span class="tok-ss">:name</span>        <span class="tok-o">.</span> <span class="tok-o">,,</span><span class="tok-nv">name-downcase</span><span class="tok-p">)</span>
                    <span class="tok-p">(</span><span class="tok-ss">:description</span> <span class="tok-o">.</span> <span class="tok-o">,,</span><span class="tok-nv">description</span><span class="tok-p">))</span>
                  <span class="tok-o">,</span><span class="tok-nv">command-list-symb</span><span class="tok-p">))))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_putting_all_command_helpers_together">5.3. Putting all command helpers together</h3>
<div class="listingblock">
<div class="title">file::command-core.lisp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</div></td><td class="code"><span></span><span class="tok-c1">;; include::license-header</span>

<span class="tok-c1">;; include::define-command-core-package</span>

<span class="tok-c1">;; include::run-command</span>

<span class="tok-c1">;; include::run-command-help</span>

<span class="tok-c1">;; include::parse-command-line-arguments</span>

<span class="tok-c1">;; include::defcmd</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:command-core</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">display-cmd</span> <span class="tok-p">(</span><span class="tok-nv">msg</span> <span class="tok-k">&amp;optional</span> <span class="tok-p">(</span><span class="tok-nc">stream</span> <span class="tok-no">t</span><span class="tok-p">))</span>
  <span class="tok-s">&quot;Nicely formats and displays a command.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-nv">msg</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nc">stream</span> <span class="tok-kt">boolean</span><span class="tok-p">)</span> <span class="tok-nc">stream</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-nc">stream</span> <span class="tok-s">&quot;==== ~A ====~%&quot;</span> <span class="tok-nv">msg</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we are going to talk about the <code>generate-html</code> command, used to
generates HTML documents with some default options.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generating_html">6. Generating HTML</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When called with <code>--help</code> as a command line tool, <code>generate-html</code> provides the
following usage note:</p>
</div>
<div class="listingblock">
<div class="title">file::commands/generate-html.help.txt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="text">Usage: generate-html [--from from] [--to to] [--recursive recursive]

Generate HTML from literate documents.

  --from       either path to a directory where literate documents are stored, or list of paths to literate documents; default: &quot;src/&quot;
  --to         directory where HTMLs are generated; default: &quot;docs/&quot;
  --recursive  either the literate documents are searched recursively or non-recursively; default: &quot;true&quot;

Examples

Generate HTML from src/ to docs/ recursively
  ulqui generate-html

or explicitly
  ulqui generate-html --from src/ --to docs/ --recursive true

Generate HTML from literate-source/ to generated-documents/ non-recursively
  ulqui generate-html --from literate-source/ --to generated-documents/ --recursive false

Generate HTML code from Foo.adoc and quux/ to docs/ recursively
  ulqui generate-html --from Foo.adoc quux/ --to docs/</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="generate-html"></a></p>
</div>
<div class="sect2">
<h3 id="_the_main_function_code_generate_html_code">6.1. The main function: <code>generate-html</code></h3>
<div class="paragraph">
<p>Just like <a href="#generate-src"><code>generate-src</code></a>, <code>generate-html</code> takes 2 arguments:
. the source, via <code>:from</code> parameter, and
. the destination, via <code>:to</code> parameter</p>
</div>
<div class="paragraph">
<p><code>:from</code> could be either a literate source file or a directory, while <code>:to</code> is
a directory.  <code>:to</code> is created if not existed yet.  This function takes
AsciiDoc files recursively (using <a href="#func/list-asciidocs"><code>list-asciidocs</code></a>)
and generate their HTML outputs to destination.</p>
</div>
<div class="listingblock">
<div class="title">code::generate-html</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">generate-html</span> <span class="tok-p">(</span><span class="tok-k">&amp;key</span> <span class="tok-p">(</span><span class="tok-nv">from</span> <span class="tok-s">&quot;src&quot;</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">to</span> <span class="tok-s">&quot;docs&quot;</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nv">recursive</span> <span class="tok-no">t</span><span class="tok-p">))</span>
  <span class="tok-s">&quot;Generates HTML documentation from all literate source files in `from&#39; to</span>
<span class="tok-s">directory `to&#39;.  `from&#39; is either a directory or a single literate source</span>
<span class="tok-s">file.  The source file could be searched recursively or non-recursively,</span>
<span class="tok-s">depending on the value of `recursive&#39;.  By default, `recursive&#39; is `t&#39;.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span> <span class="tok-nb">list</span><span class="tok-p">)</span> <span class="tok-nv">from</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span> <span class="tok-nv">to</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-kt">boolean</span> <span class="tok-nv">recursive</span><span class="tok-p">))</span>

  <span class="tok-p">(</span><span class="tok-k">labels</span> <span class="tok-p">((</span><span class="tok-nv">make-generate-html-thread</span> <span class="tok-p">(</span><span class="tok-nv">doc</span> <span class="tok-nv">to</span><span class="tok-p">)</span>
             <span class="tok-s">&quot;Creates and return a thread that does the actual generation&quot;</span>
             <span class="tok-c1">;; uiop:merge-pathnames* replaces the extension</span>
             <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">output</span> <span class="tok-p">(</span><span class="tok-nv">uiop:merge-pathnames*</span> <span class="tok-p">(</span><span class="tok-nv">html-namepart</span> <span class="tok-nv">doc</span><span class="tok-p">)</span> <span class="tok-nv">to</span><span class="tok-p">)))</span>
               <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">t</span> <span class="tok-s">&quot;~A → ~A~%&quot;</span> <span class="tok-nv">doc</span> <span class="tok-nv">output</span><span class="tok-p">)</span>
               <span class="tok-p">(</span><span class="tok-nv">bordeaux-threads:make-thread</span>
                <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">()</span> <span class="tok-p">(</span><span class="tok-nv">render-asciidoc</span> <span class="tok-nv">doc</span> <span class="tok-nv">output</span><span class="tok-p">))))))</span>

    <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">to</span>   <span class="tok-p">(</span><span class="tok-nv">full-path</span> <span class="tok-p">(</span><span class="tok-nv">uiop:ensure-directory-pathname</span> <span class="tok-nv">to</span><span class="tok-p">)))</span>
          <span class="tok-p">(</span><span class="tok-nv">docs</span> <span class="tok-p">(</span><span class="tok-nb">typecase</span> <span class="tok-nv">from</span>

                  <span class="tok-c1">;; If `from` is a list of paths</span>
                  <span class="tok-p">(</span><span class="tok-nb">list</span>
                   <span class="tok-p">(</span><span class="tok-nb">reduce</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">append</span>
                           <span class="tok-p">(</span><span class="tok-nb">mapcar</span>
                            <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">path</span><span class="tok-p">)</span>
                                <span class="tok-p">(</span><span class="tok-nv">list-asciidocs</span> <span class="tok-p">(</span><span class="tok-nv">full-path</span> <span class="tok-nv">path</span><span class="tok-p">)</span>
                                                <span class="tok-ss">:recursive</span> <span class="tok-nv">recursive</span><span class="tok-p">))</span>
                            <span class="tok-nv">from</span><span class="tok-p">)))</span>

                  <span class="tok-c1">;; If `from` is one path</span>
                  <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span>
                   <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">from</span> <span class="tok-p">(</span><span class="tok-nv">full-path</span> <span class="tok-nv">from</span><span class="tok-p">)))</span>
                     <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nv">uiop:directory-exists-p</span> <span class="tok-nv">from</span><span class="tok-p">)</span>
                         <span class="tok-p">(</span><span class="tok-nv">list-asciidocs</span> <span class="tok-nv">from</span> <span class="tok-ss">:recursive</span> <span class="tok-nv">recursive</span><span class="tok-p">)</span>
                       <span class="tok-p">(</span><span class="tok-nb">list</span> <span class="tok-nv">from</span><span class="tok-p">)))))))</span>

      <span class="tok-c1">;; (format t &quot;List of AsciiDoc docs: ~A~%&quot; docs)</span>

      <span class="tok-p">(</span><span class="tok-nv">uiop:ensure-all-directories-exist</span> <span class="tok-p">(</span><span class="tok-nb">list</span> <span class="tok-nv">to</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-nb">mapcar</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">bordeaux-threads:join-thread</span>
              <span class="tok-p">(</span><span class="tok-nb">mapcar</span> <span class="tok-nf">#&#39;</span><span class="tok-p">(</span><span class="tok-k">lambda</span> <span class="tok-p">(</span><span class="tok-nv">doc</span><span class="tok-p">)</span>
                          <span class="tok-p">(</span><span class="tok-nv">make-generate-html-thread</span> <span class="tok-nv">doc</span> <span class="tok-nv">to</span><span class="tok-p">))</span>
                      <span class="tok-nv">docs</span><span class="tok-p">)))))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="tok-c1">;; Helpers</span>
<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">html-namepart</span> <span class="tok-p">(</span><span class="tok-nv">file</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Extracts only the name part of the file and replaces its extension with</span>
<span class="tok-s">HTML.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span> <span class="tok-nv">file</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">((</span><span class="tok-nv">filename-part</span> <span class="tok-p">(</span><span class="tok-nb">file-namestring</span> <span class="tok-nv">file</span><span class="tok-p">)))</span>
    <span class="tok-p">(</span><span class="tok-nb">multiple-value-bind</span> <span class="tok-p">(</span><span class="tok-nv">namepart</span> <span class="tok-nv">_</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">uiop:split-name-type</span> <span class="tok-nv">filename-part</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-k">ignore</span> <span class="tok-nv">_</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-nb">string</span> <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">nil</span> <span class="tok-s">&quot;~A.html&quot;</span> <span class="tok-nv">namepart</span><span class="tok-p">)))))</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-tests</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">define-test</span> <span class="tok-nv">test-html-namepart</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;hello.html&quot;</span> <span class="tok-p">(</span><span class="tok-nv">html-namepart</span> <span class="tok-s">&quot;/tmp/hello&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;hello.html&quot;</span> <span class="tok-p">(</span><span class="tok-nv">html-namepart</span> <span class="tok-s">&quot;/tmp/hello.adoc&quot;</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">assert-equal</span> <span class="tok-s">&quot;hello.html&quot;</span> <span class="tok-p">(</span><span class="tok-nv">html-namepart</span> <span class="tok-s">&quot;/tmp/hello.txt&quot;</span><span class="tok-p">)))</span>

<span class="tok-c1">;; (run-tests &#39;(test-html-namepart))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>For <code>generate-html</code> to work, we need 2 more utilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>render-asciidoc</code> to render AsciiDoc file into HTML using AsciiDoctor</p>
</li>
<li>
<p><code>list-asciidocs</code> to search for and return the list of all AsciiDoc files in
a directory; the search process might work in a recursive or
non-recursive way.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rendering_an_asciidoc_document_to_html">6.2. Rendering an ASCIIDoc document to HTML</h3>
<div class="listingblock">
<div class="title">code::render-asciidoc</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">render-asciidoc</span> <span class="tok-p">(</span><span class="tok-nv">input</span> <span class="tok-nv">output</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Renders an ASCIIDoc `input&#39; to `output&#39; as HTML.  TODO: make this</span>
<span class="tok-s">extensible.&quot;</span>
  <span class="tok-p">(</span><span class="tok-nv">!cmd</span> <span class="tok-p">(</span><span class="tok-nv">asciidoctor-command</span> <span class="tok-nv">input</span> <span class="tok-nv">output</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">asciidoctor-command</span> <span class="tok-p">(</span><span class="tok-nv">input</span> <span class="tok-nv">output</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Builds and returns command to render `input&#39; to `output&#39; with ASCIIDoctor.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span> <span class="tok-nv">input</span> <span class="tok-nv">output</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">the</span> <span class="tok-nb">string</span> <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">nil</span> <span class="tok-s">&quot;asciidoctor ~A -d book -o ~A&quot;</span> <span class="tok-nv">input</span> <span class="tok-nv">output</span><span class="tok-p">)))</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">!cmd</span> <span class="tok-p">(</span><span class="tok-nv">cmd</span> <span class="tok-k">&amp;key</span> <span class="tok-p">(</span><span class="tok-nv">output</span> <span class="tok-no">t</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nv">error-output</span> <span class="tok-no">t</span><span class="tok-p">)</span>
                 <span class="tok-p">(</span><span class="tok-nv">force-shell</span> <span class="tok-no">t</span><span class="tok-p">))</span>
  <span class="tok-s">&quot;Runs command by calling `uiou:run-program&#39;.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">(</span><span class="tok-nb">string</span> <span class="tok-nv">cmd</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-kt">boolean</span> <span class="tok-nv">force-shell</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-kt">boolean</span> <span class="tok-nc">stream</span><span class="tok-p">)</span> <span class="tok-nv">output</span> <span class="tok-nv">error-output</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">uiop:run-program</span> <span class="tok-nv">cmd</span> <span class="tok-ss">:output</span> <span class="tok-nv">output</span>
                    <span class="tok-ss">:error-output</span> <span class="tok-nv">error-output</span>
                    <span class="tok-ss">:force-shell</span> <span class="tok-nv">force-shell</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>To conclude this section, let&#8217;s fill in the the last missing piece&#8201;&#8212;&#8201;the
command counterpart of the <a href="#func/generate-html"><code>generate-html</code></a> function:</p>
</div>
<div class="listingblock">
<div class="title">file::commands/generate-html.lisp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</div></td><td class="code"><span></span><span class="tok-c1">;; include::license-header</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-cmd</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">defcmd</span> <span class="tok-nv">generate-html</span> <span class="tok-p">(</span><span class="tok-k">&amp;key</span> <span class="tok-p">(</span><span class="tok-nv">from</span> <span class="tok-s">&quot;src&quot;</span><span class="tok-p">)</span>
                            <span class="tok-p">(</span><span class="tok-nv">to</span> <span class="tok-s">&quot;docs&quot;</span><span class="tok-p">)</span>
                            <span class="tok-p">(</span><span class="tok-nv">recursive</span> <span class="tok-no">t</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">declare</span> <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span> <span class="tok-nb">list</span><span class="tok-p">)</span> <span class="tok-nv">from</span><span class="tok-p">)</span>
           <span class="tok-p">((</span><span class="tok-nb">or</span> <span class="tok-nb">string</span> <span class="tok-nb">pathname</span><span class="tok-p">)</span> <span class="tok-nv">to</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-nv">display-cmd</span> <span class="tok-s">&quot;Generating HTML&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">ulquikit:generate-html</span> <span class="tok-ss">:from</span> <span class="tok-nv">from</span> <span class="tok-ss">:to</span> <span class="tok-nv">to</span> <span class="tok-ss">:recursive</span> <span class="tok-nv">recursive</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_asdf_system_definition">7. The ASDF system definition</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">file::ulquikit.asd</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nv">defsystem</span> <span class="tok-nv">ulquikit</span>
  <span class="tok-ss">:name</span> <span class="tok-s">&quot;Ulquikit&quot;</span>
  <span class="tok-ss">:version</span> <span class="tok-s">&quot;2.0.0&quot;</span>
  <span class="tok-ss">:maintainer</span> <span class="tok-s">&quot;Ha-Duong Nguyen &lt;cmpitg@gmail.com&gt;&quot;</span>
  <span class="tok-ss">:license</span> <span class="tok-s">&quot;GNU General Public license v3&quot;</span>
  <span class="tok-ss">:description</span> <span class="tok-s">&quot;Ulquikit is a hackable tool to make literate programming fun and productive again.&quot;</span>
  <span class="tok-ss">:depends-on</span> <span class="tok-p">(</span><span class="tok-ss">#:alexandria</span>
               <span class="tok-ss">#:uiop</span>
               <span class="tok-ss">#:split-sequence</span>
               <span class="tok-ss">#:cl-ppcre</span>
               <span class="tok-ss">#:bordeaux-threads</span>
               <span class="tok-ss">#:trivial-utf-8</span>
               <span class="tok-ss">#:iterate</span>
               <span class="tok-ss">#:lisp-unit</span><span class="tok-p">)</span>
  <span class="tok-ss">:components</span> <span class="tok-p">((</span><span class="tok-ss">:file</span> <span class="tok-s">&quot;ulquikit&quot;</span> <span class="tok-ss">:depends-on</span> <span class="tok-p">(</span><span class="tok-s">&quot;utils&quot;</span><span class="tok-p">))</span>
               <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-s">&quot;ulquikit-cmd&quot;</span> <span class="tok-ss">:depends-on</span> <span class="tok-p">(</span><span class="tok-s">&quot;utils&quot;</span> <span class="tok-s">&quot;command-core&quot;</span> <span class="tok-s">&quot;ulquikit&quot;</span><span class="tok-p">))</span>
               <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-s">&quot;commands/generate-src&quot;</span> <span class="tok-ss">:depends-on</span> <span class="tok-p">(</span><span class="tok-s">&quot;utils&quot;</span> <span class="tok-s">&quot;command-core&quot;</span><span class="tok-p">))</span>
               <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-s">&quot;commands/generate-html&quot;</span> <span class="tok-ss">:depends-on</span> <span class="tok-p">(</span><span class="tok-s">&quot;utils&quot;</span> <span class="tok-s">&quot;command-core&quot;</span><span class="tok-p">))</span>
               <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-s">&quot;commands/version&quot;</span> <span class="tok-ss">:depends-on</span> <span class="tok-p">(</span><span class="tok-s">&quot;utils&quot;</span> <span class="tok-s">&quot;command-core&quot;</span><span class="tok-p">))</span>
               <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-s">&quot;commands/help&quot;</span> <span class="tok-ss">:depends-on</span> <span class="tok-p">(</span><span class="tok-s">&quot;utils&quot;</span> <span class="tok-s">&quot;command-core&quot;</span><span class="tok-p">))</span>
               <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-s">&quot;command-core&quot;</span> <span class="tok-ss">:depends-on</span> <span class="tok-p">(</span><span class="tok-s">&quot;utils&quot;</span><span class="tok-p">))</span>
               <span class="tok-p">(</span><span class="tok-ss">:file</span> <span class="tok-s">&quot;utils&quot;</span><span class="tok-p">)))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_code_ulqui_code_executable">8. The <code>ulqui</code> executable</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Up to this point, Ulquikit is perfectly usable as a library.  With
<a href="https://www.quicklisp.org/beta/">Quicklisp</a>, it could be loaded very
straightforwardly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><span class="tok-c1">;; Symlinking Ulquikit to Quicklisp local projects directory</span>
<span class="tok-c1">;; ln -s /path/to/ulquikit/asdf ~/quicklisp/local-projects/</span>

<span class="tok-c1">;; Loading</span>
<span class="tok-p">(</span><span class="tok-nv">ql:quickload</span> <span class="tok-s">&quot;ulquikit&quot;</span><span class="tok-p">)</span>

<span class="tok-c1">;; Using</span>
<span class="tok-p">(</span><span class="tok-nv">ulquikit:generate-src</span> <span class="tok-ss">:from</span> <span class="tok-s">&quot;/path/to/literate/source&quot;</span> <span class="tok-ss">:to</span> <span class="tok-s">&quot;/path/to/generated/source&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-nv">ulquikit:generate-html</span> <span class="tok-ss">:from</span> <span class="tok-s">&quot;/path/to/literate/source&quot;</span> <span class="tok-ss">:to</span> <span class="tok-s">&quot;/path/to/generated/html/doc&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to turn Ulquikit into a executable named <code>ulqui</code> so it could
be used as a standalone program.</p>
</div>
<div class="sect2">
<h3 id="_general_help">8.1. General help</h3>
<div class="paragraph">
<p>Invoking <code>ulqui</code>, <code>ulqui --help</code>, or <code>ulqui help</code> should bring up the general
usage of Ulquikit.  This behavior is defined with the <code>help</code> command.  This
command should detect all current Ulquikit commands (defined by the
<a href="#defcmd"><code>defcmd</code></a> macro) and output their short summary.</p>
</div>
<div class="listingblock">
<div class="title">file::commands/help.help.txt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="text">Usage: ulqui &lt;command&gt; [options] ...

Ulquikit is a literate programming tool, helping developers manage literate source code, including source code and documentation generation.

Supported markup language: AsciiDoc.
Supported output format for documentation: HTML.

Available commands:

{{ commands-docs }}

Use &#39;ulqui help&#39; or &#39;ulqui --help&#39; to bring up this help.
Use &#39;ulqui help &lt;command&gt;&#39; or &#39;ulqui &lt;command&gt; --help&#39; to get help for a command.
Use &#39;ulqui version&#39; or &#39;ulqui --version&#39; to display current version of Ulquikit.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>help</code> command could then be implemented as followed.  Note that it
replaces documentation of <code>help</code> function and shows the actual description of
<code>help</code> command itself, not Ulquikit.</p>
</div>
<div class="listingblock">
<div class="title">file::commands/help.lisp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</div></td><td class="code"><span></span><span class="tok-c1">;; include::license-header</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-cmd</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">defcmd</span> <span class="tok-nv">help</span> <span class="tok-p">(</span><span class="tok-k">&amp;optional</span> <span class="tok-nv">cmd</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-nv">cmd</span>
      <span class="tok-p">(</span><span class="tok-nv">run-help</span> <span class="tok-nv">cmd</span> <span class="tok-ss">:ulquikit-cmd</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nv">general-usage</span><span class="tok-p">)))</span>

<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="tok-c1">;;; Helper</span>
<span class="tok-c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-cmd</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">general-usage</span> <span class="tok-p">()</span>
  <span class="tok-s">&quot;Shows Ulquikit&#39;s general usage.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">labels</span> <span class="tok-p">((</span><span class="tok-nv">format-cmd</span> <span class="tok-p">(</span><span class="tok-nv">cmd&amp;desc</span><span class="tok-p">)</span>
             <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">nil</span>
                     <span class="tok-s">&quot;~15A :: ~A&quot;</span>
                     <span class="tok-p">(</span><span class="tok-nv">alist-get</span> <span class="tok-nv">cmd&amp;desc</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
                     <span class="tok-p">(</span><span class="tok-nv">string-butlast</span> <span class="tok-p">(</span><span class="tok-nv">alist-get</span> <span class="tok-nv">cmd&amp;desc</span> <span class="tok-ss">:description</span><span class="tok-p">))))</span>

           <span class="tok-p">(</span><span class="tok-nv">help-cmd?</span> <span class="tok-p">(</span><span class="tok-nv">cmd&amp;desc</span><span class="tok-p">)</span>
             <span class="tok-p">(</span><span class="tok-nb">string=</span> <span class="tok-p">(</span><span class="tok-nv">alist-get</span> <span class="tok-nv">cmd&amp;desc</span> <span class="tok-ss">:name</span><span class="tok-p">)</span>
                      <span class="tok-s">&quot;help&quot;</span><span class="tok-p">)))</span>

    <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">help-template</span> <span class="tok-p">(</span><span class="tok-nb">documentation</span> <span class="tok-ss">&#39;ulquikit-cmd::help</span> <span class="tok-ss">&#39;function</span><span class="tok-p">))</span>
           <span class="tok-p">(</span><span class="tok-nv">help-stripped</span> <span class="tok-p">(</span><span class="tok-nb">remove-if</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">help-cmd?</span>
                                     <span class="tok-nv">ulquikit-cmd::*command-list*</span><span class="tok-p">))</span>
           <span class="tok-p">(</span><span class="tok-nv">cmd-descriptions</span>
            <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">nil</span> <span class="tok-s">&quot;~{~A~^~%~}&quot;</span>
                    <span class="tok-p">(</span><span class="tok-nb">mapcar</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">format-cmd</span> <span class="tok-nv">help-stripped</span><span class="tok-p">)))</span>
           <span class="tok-p">(</span><span class="tok-nv">help-text</span> <span class="tok-p">(</span><span class="tok-nv">regex-replace</span> <span class="tok-s">&quot;{{ commands-docs }}&quot;</span>
                                     <span class="tok-nv">help-template</span>
                                     <span class="tok-nv">cmd-descriptions</span><span class="tok-p">)))</span>
      <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">t</span> <span class="tok-nv">help-text</span><span class="tok-p">))))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_code_main_code_function">8.2. The <code>main</code> function</h3>
<div class="paragraph">
<p>Putting all things together, we have the following entry point for using
Ulquikit as a standalone program: the <code>main</code> function.  By default, running
<code>ulqui</code> usually means users need some help.  Thus running <code>ulqui</code> is
equivalent to running <code>ulqui help</code>.</p>
</div>
<div class="listingblock">
<div class="title">code::ulquikit-cmd/main</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-cmd</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">main</span> <span class="tok-p">(</span><span class="tok-nv">argv</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nb">when</span> <span class="tok-p">(</span><span class="tok-nb">null</span> <span class="tok-nv">argv</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nv">general-usage</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nv">uiop:quit</span> <span class="tok-mi">0</span><span class="tok-p">))</span>

  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">arg&amp;opts</span> <span class="tok-p">(</span><span class="tok-nb">handler-case</span> <span class="tok-p">(</span><span class="tok-nv">parse-cmd-args</span> <span class="tok-p">(</span><span class="tok-nb">rest</span> <span class="tok-nv">argv</span><span class="tok-p">))</span>
                     <span class="tok-p">(</span><span class="tok-kt">simple-error</span> <span class="tok-p">(</span><span class="tok-nv">err</span><span class="tok-p">)</span>
                       <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-vg">*error-output*</span> <span class="tok-s">&quot;~A~%~%&quot;</span> <span class="tok-nv">err</span><span class="tok-p">)</span>
                       <span class="tok-p">(</span><span class="tok-nv">general-usage</span><span class="tok-p">)</span>
                       <span class="tok-p">(</span><span class="tok-nv">uiop:quit</span> <span class="tok-mi">1</span><span class="tok-p">))))</span>
         <span class="tok-p">(</span><span class="tok-nv">cmds</span> <span class="tok-p">(</span><span class="tok-nv">alist-get</span> <span class="tok-nv">arg&amp;opts</span> <span class="tok-ss">:arguments</span><span class="tok-p">))</span>
         <span class="tok-p">(</span><span class="tok-nv">opts</span> <span class="tok-p">(</span><span class="tok-nv">alexandria:alist-plist</span> <span class="tok-p">(</span><span class="tok-nv">alist-get</span> <span class="tok-nv">arg&amp;opts</span> <span class="tok-ss">:options</span><span class="tok-p">))))</span>
    <span class="tok-p">(</span><span class="tok-nb">or</span> <span class="tok-p">(</span><span class="tok-nv">maybe-usage-or-version</span> <span class="tok-nv">cmds</span> <span class="tok-nv">opts</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">maybe-help</span> <span class="tok-nv">cmds</span> <span class="tok-nv">opts</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nv">run-cmd</span> <span class="tok-p">(</span><span class="tok-nb">first</span> <span class="tok-nv">cmds</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nb">append</span> <span class="tok-p">(</span><span class="tok-nb">rest</span> <span class="tok-nv">cmds</span><span class="tok-p">)</span> <span class="tok-nv">opts</span><span class="tok-p">)))))</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">maybe-usage-or-version</span> <span class="tok-p">(</span><span class="tok-nv">cmds</span> <span class="tok-nv">opts</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Shows help or displays Ulquikit version.  This function returns `:end&#39; if</span>
<span class="tok-s">it&#39;s supposed to tell the caller to not further process `cmds&#39; and `opts&#39; and</span>
<span class="tok-s">returns `nil&#39; otherwise.&quot;</span>
  <span class="tok-p">(</span><span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-nb">null</span> <span class="tok-nv">cmds</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-nb">prog1</span>
          <span class="tok-ss">:end</span>
        <span class="tok-p">(</span><span class="tok-nb">cond</span>
         <span class="tok-c1">;; ulqui, or</span>
         <span class="tok-c1">;; ulqui --help ((or (null opts)</span>
         <span class="tok-p">((</span><span class="tok-nb">equal</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-ss">:help</span> <span class="tok-no">t</span><span class="tok-p">)</span> <span class="tok-nv">opts</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-nv">general-usage</span><span class="tok-p">))</span>

         <span class="tok-c1">;; ulqui --version</span>
         <span class="tok-p">((</span><span class="tok-nb">equal</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-ss">:version</span> <span class="tok-no">t</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-nb">member</span> <span class="tok-ss">:version</span> <span class="tok-nv">opts</span><span class="tok-p">))</span>
          <span class="tok-p">(</span><span class="tok-nv">run-cmd</span> <span class="tok-s">&quot;version&quot;</span> <span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-p">)))</span>

          <span class="tok-c1">;; ulqui --help &lt;command&gt;</span>
         <span class="tok-p">((</span><span class="tok-nb">=</span> <span class="tok-mi">2</span> <span class="tok-p">(</span><span class="tok-nb">length</span> <span class="tok-p">(</span><span class="tok-nb">member</span> <span class="tok-ss">:help</span> <span class="tok-nv">opts</span><span class="tok-p">)))</span>
          <span class="tok-p">(</span><span class="tok-nv">run-cmd</span> <span class="tok-s">&quot;help&quot;</span> <span class="tok-nv">opts</span><span class="tok-p">))</span>

         <span class="tok-p">(</span><span class="tok-no">t</span>
          <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-vg">*error-output*</span>
                  <span class="tok-s">&quot;Invalid options ~{~A~^ ~}~%~%&quot;</span>
                  <span class="tok-p">(</span><span class="tok-nb">append</span> <span class="tok-nv">cmds</span> <span class="tok-nv">opts</span><span class="tok-p">))</span>
          <span class="tok-p">(</span><span class="tok-nv">help</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-nv">uiop:quit</span> <span class="tok-mi">1</span><span class="tok-p">))))</span>
    <span class="tok-no">nil</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">maybe-help</span> <span class="tok-p">(</span><span class="tok-nv">cmds</span> <span class="tok-nv">opts</span><span class="tok-p">)</span>
  <span class="tok-s">&quot;Shows help for a command when options contains \&quot;--help\&quot; (or `opts&#39;</span>
<span class="tok-s">contains `:help&#39;).  The function returns `:end&#39; to tell its caller to stop</span>
<span class="tok-s">further processing and `nil&#39; otherwise.&quot;</span>
  <span class="tok-p">(</span><span class="tok-nb">when</span> <span class="tok-p">(</span><span class="tok-nb">equal</span> <span class="tok-o">&#39;</span><span class="tok-p">(</span><span class="tok-ss">:help</span> <span class="tok-no">t</span><span class="tok-p">)</span> <span class="tok-nv">opts</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nv">run-cmd</span> <span class="tok-s">&quot;help&quot;</span> <span class="tok-nv">cmds</span><span class="tok-p">)</span>
    <span class="tok-ss">:end</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_code_version_code_command">8.3. The <code>version</code> command</h3>
<div class="listingblock">
<div class="title">file::commands/version.help.txt</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="text">Usage: ulqui version

Display the current running version of Ulquikit.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">file::commands/version.lisp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6</div></td><td class="code"><span></span><span class="tok-c1">;; include::license-header</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:ulquikit-cmd</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nv">defcmd</span> <span class="tok-nv">version</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">t</span> <span class="tok-s">&quot;Ulquikit version ~A~%&quot;</span> <span class="tok-nv">ulquikit:*ulquikit-version*</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_managing_ulquikit_source_code">9. Managing Ulquikit source code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As Ulquikit grows, the need for a tool to manage its source code and release
arises.
<a href="http://en.wikipedia.org/wiki/List_of_Hollows_in_Bleach#Ulquiorra_Schiffer">Schiffer</a>
is born to fulfill the need.  Schiffer is written in
<a href="https://github.com/ruby/rake">Rake</a>.</p>
</div>
<div class="sect2">
<h3 id="_generating_source_code_and_html_documentation">9.1. Generating source code and HTML documentation</h3>
<div class="listingblock">
<div class="title">code::schiffer/generate</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="ruby"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112</div></td><td class="code"><span></span><span class="tok-p">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-p">(</span><span class="tok-k">in</span><span class="tok-o">-</span><span class="tok-n">package</span> <span class="tok-c1">#:schiffer)</span>

<span class="tok-p">(</span><span class="tok-n">defun</span> <span class="tok-n">gen</span><span class="tok-o">-</span><span class="tok-n">src</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">cmd</span> <span class="tok-s2">&quot;ulqui generate-src --from src/ --to generated-src/ --recursive false&quot;</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-n">defun</span> <span class="tok-n">gen</span><span class="tok-o">-</span><span class="tok-n">docs</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-o">!</span><span class="tok-n">cmd</span> <span class="tok-s2">&quot;ulqui generate-html --from src/ --to docs/ --recursive false&quot;</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-n">defun</span> <span class="tok-n">gen</span><span class="tok-o">-</span><span class="tok-n">all</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-n">gen</span><span class="tok-o">-</span><span class="tok-n">src</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-n">gen</span><span class="tok-o">-</span><span class="tok-n">docs</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-n">defun</span> <span class="tok-n">build</span><span class="tok-o">-</span><span class="tok-n">ulqui</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-n">displayln</span> <span class="tok-s2">&quot;⇨ Generating Quicklisp manifest&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-n">write</span><span class="tok-o">-</span><span class="tok-n">quicklisp</span><span class="tok-o">-</span><span class="tok-n">manifest</span><span class="tok-p">)</span>

  <span class="tok-p">(</span><span class="tok-n">displayln</span> <span class="tok-s2">&quot;⇨ Making sure build/ exists&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-n">uiop</span><span class="tok-o">/</span><span class="tok-n">common</span><span class="tok-o">-</span><span class="tok-ss">lisp</span><span class="tok-p">:</span><span class="tok-k">ensure</span><span class="tok-o">-</span><span class="tok-n">directories</span><span class="tok-o">-</span><span class="tok-n">exist</span> <span class="tok-p">(</span><span class="tok-n">ulqui</span><span class="tok-o">-</span><span class="tok-n">dir</span><span class="tok-o">-</span><span class="tok-n">to</span> <span class="tok-s2">&quot;build/&quot;</span><span class="tok-p">))</span>

  <span class="tok-p">(</span><span class="tok-n">displayln</span> <span class="tok-s2">&quot;⇨ Building Ulquikit to build/ulqui&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-n">buildapp</span> <span class="tok-ss">:manifest</span><span class="tok-o">-</span><span class="tok-n">file</span> <span class="tok-s2">&quot;quicklisp-manifest.txt&quot;</span>
            <span class="tok-ss">:systems</span> <span class="tok-s1">&#39;(&quot;ulquikit&quot;)</span>
<span class="tok-s1">            :entry &quot;ulquikit-cmd:main&quot;</span>
<span class="tok-s1">            :output (ulqui-dir-to &quot;build/ulqui&quot;)))</span>

<span class="tok-s1">(defun build-schiffer ()</span>
<span class="tok-s1">  (displayln &quot;⇨ Generating Quicklisp manifest&quot;)</span>
<span class="tok-s1">  (write-quicklisp-manifest)</span>

<span class="tok-s1">  (displayln &quot;⇨ Making sure build/ exists&quot;)</span>
<span class="tok-s1">  (uiop/common-lisp:ensure-directories-exist (ulqui-dir-to &quot;build/&quot;))</span>

<span class="tok-s1">  (displayln &quot;⇨ Building Schiffer to ./schiffer&quot;)</span>
<span class="tok-s1">  (asdf:load-system :alexandria)</span>
<span class="tok-s1">  (compile-file (ulqui-dir-to &quot;generated-src/schiffer.lisp&quot;)</span>
<span class="tok-s1">                :output-file (ulqui-dir-to &quot;build/schiffer.fasl&quot;))</span>
<span class="tok-s1">  (buildapp :manifest-file &quot;quicklisp-manifest.txt&quot;</span>
<span class="tok-s1">            :options &#39;</span><span class="tok-p">(</span><span class="tok-s2">&quot;--compress-core&quot;</span><span class="tok-p">)</span><span class="tok-s1">&#39;</span>
<span class="tok-s1">            :systems &#39;</span><span class="tok-p">(</span><span class="tok-s2">&quot;alexandria&quot;</span><span class="tok-p">)</span>
            <span class="tok-ss">:loads</span> <span class="tok-sb">`(,(ulqui-dir-to &quot;build/schiffer.fasl&quot;))</span>
<span class="tok-sb">            :entry &quot;schiffer:main&quot;</span>
<span class="tok-sb">            :output (ulqui-dir-to &quot;build/schiffer&quot;)))</span>

<span class="tok-sb">(defun gen-build-ulqui ()</span>
<span class="tok-sb">  (gen-src)</span>
<span class="tok-sb">  (build-ulqui))</span>

<span class="tok-sb">(defun gen-build-all ()</span>
<span class="tok-sb">  (gen-build-ulqui)</span>
<span class="tok-sb">  (build-schiffer))</span>

<span class="tok-sb">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="tok-sb">;; Helpers</span>
<span class="tok-sb">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>

<span class="tok-sb">(defun !cmd (cmd &amp;key (output t)</span>
<span class="tok-sb">                   (error-output t)</span>
<span class="tok-sb">                   (force-shell t))</span>
<span class="tok-sb">  (uiop:run-program cmd :output output</span>
<span class="tok-sb">                    :error-output error-output</span>
<span class="tok-sb">                    :force-shell force-shell))</span>

<span class="tok-sb">(defun buildapp (&amp;key manifest-file entry output systems loads options)</span>
<span class="tok-sb">  (!cmd (format-str</span>
<span class="tok-sb">         (str-space</span>
<span class="tok-sb">          &quot;buildapp --manifest-file ~A&quot;</span>
<span class="tok-sb">          &quot;--asdf-tree ~A&quot;</span>
<span class="tok-sb">          &quot;~:[~;~:*~{--load-system &#39;~A&#39; ~}~]&quot;</span>
<span class="tok-sb">          &quot;~:[~;~:*~{--load &#39;~A&#39; ~}~]&quot;</span>
<span class="tok-sb">          &quot;~:[~;~:*~{~A ~}~]&quot;</span>
<span class="tok-sb">          &quot;--entry ~A&quot;</span>
<span class="tok-sb">          &quot;--output &#39;~A&#39;&quot;)</span>
<span class="tok-sb">         manifest-file</span>
<span class="tok-sb">         (ulqui-dir-to &quot;generated-src/&quot;)</span>
<span class="tok-sb">         systems                  ; Only --load-system if `</span><span class="tok-n">systems</span><span class="tok-sb">` is not nil</span>
<span class="tok-sb">         loads                    ; Only --load if `</span><span class="tok-n">loads</span><span class="tok-sb">` is not nil</span>
<span class="tok-sb">         options                  ; Only if `</span><span class="tok-n">options</span><span class="tok-sb">` is not nil</span>
<span class="tok-sb">         entry</span>
<span class="tok-sb">         output)))</span>

<span class="tok-sb">(defun str-space (&amp;rest strs)</span>
<span class="tok-sb">  (format nil &quot;~{~A~^ ~}&quot; strs))</span>

<span class="tok-sb">(defun format-str (&amp;rest args)</span>
<span class="tok-sb">  (apply &#39;format nil args))</span>

<span class="tok-sb">(defun ulqui-dir-to (dir)</span>
<span class="tok-sb">  (uiop:merge-pathnames* dir (current-dir)))</span>

<span class="tok-sb">(defun current-dir ()</span>
<span class="tok-sb">  &quot;Retrieves the current project directory.&quot;</span>
<span class="tok-sb">  (uiop:merge-pathnames*</span>
<span class="tok-sb">   (uiop:pathname-parent-directory-pathname</span>
<span class="tok-sb">    (uiop:pathname-directory-pathname (or *compile-file-pathname*</span>
<span class="tok-sb">                                          *load-pathname*)))))</span>

<span class="tok-sb">(defun write-quicklisp-manifest ()</span>
<span class="tok-sb">  (!cmd (format-str</span>
<span class="tok-sb">         (str-space</span>
<span class="tok-sb">          &quot;sbcl --noinform --no-sysinit --non-interactive&quot;</span>
<span class="tok-sb">          &quot;--eval &#39;(pushnew </span><span class="tok-se">\&quot;</span><span class="tok-sb">~A</span><span class="tok-se">\&quot;</span><span class="tok-sb"> asdf:*central-registry*)&#39;&quot;</span>
<span class="tok-sb">          &quot;--eval &#39;(ql:quickload :ulquikit)&#39;&quot;</span>
<span class="tok-sb">          &quot;--eval &#39;(ql:write-asdf-manifest-file </span><span class="tok-se">\&quot;</span><span class="tok-sb">quicklisp-manifest.txt</span><span class="tok-se">\&quot;</span><span class="tok-sb">)&#39;&quot;</span>
<span class="tok-sb">          &quot;--eval &#39;(quit)&#39;&quot;)</span>
<span class="tok-sb">         (ulqui-dir-to &quot;generated-src/&quot;))))</span>

<span class="tok-sb">(defun displayln (str)</span>
<span class="tok-sb">  (format t &quot;~A~%&quot; str))</span>

<span class="tok-sb">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_update_self">9.2. Update self</h3>
<div class="paragraph">
<p>Each time Schiffer it built, its development version at
<code>&lt;project-root&gt;/build/schiffer</code> is created.  When the development version is
stable, it could replace the current version at <code>&lt;project-root&gt;/schiffer</code>.
For that, we have a command:</p>
</div>
<div class="listingblock">
<div class="title">code::schiffer/update-self</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:schiffer</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">update-self</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-nv">displayln</span> <span class="tok-s">&quot;⇨ Updating schiffer, replacing itself with the development version at build/schiffer&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">uiop:copy-file</span> <span class="tok-p">(</span><span class="tok-nv">ulqui-dir-to</span> <span class="tok-s">&quot;build/schiffer&quot;</span><span class="tok-p">)</span>
                  <span class="tok-p">(</span><span class="tok-nv">ulqui-dir-to</span> <span class="tok-s">&quot;schiffer&quot;</span><span class="tok-p">)))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mark_current_source_as_stable">9.3. Mark current source as stable</h3>
<div class="paragraph">
<p>Marking current generated source code as stable by replacing
release/ulquikit with generated-src.  Note that this function/command does
<strong>not</strong> re-generate source code.</p>
</div>
<div class="listingblock">
<div class="title">code::schiffer/mark-stable</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</div></td><td class="code"><span></span><span class="tok-c1">;; (defun mark-stable ()</span>
<span class="tok-c1">;;   (format t &quot;⇨ Removing current stable&quot;)</span>
<span class="tok-c1">;;   (uiop:delete-directory-tree (ulqui-dir-to &quot;release&quot;)</span>
<span class="tok-c1">;;                               :if-does-not-exist :ignore)</span>

<span class="tok-c1">;;   (format t &quot;⇨ Creating stable directory: release&quot;)</span>
<span class="tok-c1">;;   (uiop:ensure-all-directories-exist (list (ulqui-dir-to &quot;release&quot;)))</span>

<span class="tok-c1">;;   (format t &quot;⇨ Copying build to release&quot;)</span>
<span class="tok-c1">;;   (uiop:copy-file (ulqui-dir-to &quot;build/ulqui&quot;)</span>
<span class="tok-c1">;;                   (ulqui-dir-to &quot;release/ulqui&quot;))</span>

<span class="tok-c1">;;   (format t &quot;⇨ Copying docs&quot;)</span>
<span class="tok-c1">;;   (format t &quot;   generated-html -&gt; release/ulquikit/docs&quot;)</span>
<span class="tok-c1">;;   (copy-directory/files &quot;generated-html&quot; &quot;release/ulquikit/docs&quot;)</span>
<span class="tok-c1">;;   (newline))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_release">9.4. Release</h3>
<div class="listingblock">
<div class="title">code::schiffer/mark-release</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</div></td><td class="code"><span></span><span class="tok-c1">;; (define (mark-release)</span>
<span class="tok-c1">;;   (mark-stable)</span>
<span class="tok-c1">;;   (let* ([latest-tag       (~&gt; (process &quot;git tag&quot;)</span>
<span class="tok-c1">;;                              first</span>
<span class="tok-c1">;;                              port-&gt;string</span>
<span class="tok-c1">;;                              string-split</span>
<span class="tok-c1">;;                              last)]</span>
<span class="tok-c1">;;          [filename         (format &quot;ulquikit-~a.zip&quot; latest-tag)]</span>
<span class="tok-c1">;;          [zip-command      (format &quot;zip -r ~a ulquikit&quot; filename)]</span>
<span class="tok-c1">;;          [checksum-command (format &quot;md5sum ~a &gt; ~a.md5&quot;</span>
<span class="tok-c1">;;                                    filename</span>
<span class="tok-c1">;;                                    filename)])</span>
<span class="tok-c1">;;     (parameterize [(current-directory &quot;release&quot;)]</span>
<span class="tok-c1">;;       (displayln (str &quot;=&gt; Creating release/&quot; filename))</span>
<span class="tok-c1">;;       (system zip-command)</span>
<span class="tok-c1">;;       (newline)</span>

<span class="tok-c1">;;       (displayln (str &quot;=&gt; Creating checksum for release/&quot; filename))</span>
<span class="tok-c1">;;       (system checksum-command)</span>
<span class="tok-c1">;;       (displayln (str &quot;   release/&quot; filename &quot; =&gt; release/&quot; filename &quot;.md5&quot;))</span>
<span class="tok-c1">;;       (newline))))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_run_current_dev_version_of_ulquikit">9.5. Run current dev version of Ulquikit</h3>
<div class="paragraph">
<p>Running current Ulquikit dev version is done by calling
generated-src/bin/ulqui.</p>
</div>
<div class="listingblock">
<div class="title">code::schiffer/ulqui-dev</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5</div></td><td class="code"><span></span><span class="tok-c1">;; (define (ulqui-dev args)</span>
<span class="tok-c1">;;   (system (str &quot;generated-src/bin/ulqui &quot;</span>
<span class="tok-c1">;;                (~&gt; (map #λ(string-append &quot;&#39;&quot; % &quot;&#39;&quot;) args)</span>
<span class="tok-c1">;;                  (string-join &quot; &quot;))))</span>
<span class="tok-c1">;;   (newline))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_run_tests">9.6. Run tests</h3>
<div class="paragraph">
<p>By calling raco test generated-src/*.</p>
</div>
<div class="listingblock">
<div class="title">code::schiffer/run-tests</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3</div></td><td class="code"><span></span><span class="tok-c1">;; (define (run-tests)</span>
<span class="tok-c1">;;   (system &quot;raco test generated-src/*&quot;)</span>
<span class="tok-c1">;;   (newline))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clean_up">9.7. Clean up</h3>
<div class="listingblock">
<div class="title">code::schiffer/clean</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6
7
8</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:schiffer</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">clean</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-nv">displayln</span> <span class="tok-s">&quot;⇨ Removing docs/ generated-src/ build/&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nv">!cmd</span> <span class="tok-p">(</span><span class="tok-nv">format-str</span> <span class="tok-s">&quot;rm -rf &#39;~A&#39; &#39;~A&#39; &#39;~A&#39;&quot;</span>
                    <span class="tok-p">(</span><span class="tok-nv">ulqui-dir-to</span> <span class="tok-s">&quot;docs/&quot;</span><span class="tok-p">)</span>
                    <span class="tok-p">(</span><span class="tok-nv">ulqui-dir-to</span> <span class="tok-s">&quot;generated-src/&quot;</span><span class="tok-p">)</span>
                    <span class="tok-p">(</span><span class="tok-nv">ulqui-dir-to</span> <span class="tok-s">&quot;build/&quot;</span><span class="tok-p">))))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_help">9.8. Help</h3>
<div class="listingblock">
<div class="title">code::schiffer/help</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:schiffer</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">show-help</span> <span class="tok-p">()</span>
  <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-no">t</span> <span class="tok-s">&quot;Usage: schiffer &lt;command&gt; [options] ...</span>

<span class="tok-s">Schiffer is a build helper for Ulquikit.</span>

<span class="tok-s">Available commands:</span>

<span class="tok-s">  gen-src         :: Generate Ulquikit and Schiffer source code to &#39;generated-src/&#39;</span>
<span class="tok-s">  gen-docs        :: Generate Ulquikit HTML docs to &#39;docs/&#39;</span>
<span class="tok-s">  gen-all         :: Call &#39;gen-src&#39;, then &#39;gen-docs&#39;</span>
<span class="tok-s">  build-ulqui     :: Build Ulquikit from &#39;generated-src/&#39; to &#39;build/ulqui&#39;</span>
<span class="tok-s">  build-schiffer  :: Build Schiffer from &#39;generated-src/&#39; to &#39;build/schiffer&#39;</span>

<span class="tok-s">  gen-build-ulqui :: Call &#39;gen-src&#39;, &#39;build-ulqui&#39;</span>
<span class="tok-s">  gen-build-all   :: Call &#39;gen-src&#39;, &#39;build-ulqui&#39;, then &#39;build-schiffer&#39;</span>

<span class="tok-s">  run-tests       :: Run all Ulquikit tests in &#39;generated-src/&#39;</span>
<span class="tok-s">  ulqui-dev       :: Call the development version of Ulquikit: &#39;build/ulqui&#39;</span>
<span class="tok-s">  clean           :: Remove all generated source, docs, and build</span>

<span class="tok-s">  mark-stable     :: Mark current source code as stable by copying &#39;generated-src&#39; to &#39;release/ulquikit/src&#39; and copying &#39;build/ulqui&#39; to &#39;release/ulquikit/ulqui&#39;</span>
<span class="tok-s">  mark-release    :: Prepare for a release by generating MD5 and SHA1 checksums of &#39;release/ulquikit/ulqui&#39; to &#39;release/ulquikit/ulqui.md5sum&#39; and &#39;release/ulquikit/ulqui.sha1sum&#39;</span>

<span class="tok-s">  update-self     :: Update Schiffer by replacing &#39;schiffer&#39; with &#39;build/schiffer&#39;</span>
<span class="tok-s">  help            :: Print this help</span>

<span class="tok-s">Only command &#39;ulqui-dev&#39; takes extra arguments.</span>
<span class="tok-s">&quot;</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_combine_into_schiffer">9.9. Combine into schiffer</h3>
<div class="listingblock">
<div class="title">file::schiffer.lisp</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</div></td><td class="code"><span></span><span class="tok-c1">;; include::license-header</span>

<span class="tok-p">(</span><span class="tok-nb">defpackage</span> <span class="tok-ss">#:schiffer</span>
  <span class="tok-p">(</span><span class="tok-ss">:use</span> <span class="tok-ss">:cl</span><span class="tok-p">))</span>

<span class="tok-c1">;; include::schiffer/generate</span>

<span class="tok-c1">;; include::schiffer/help</span>

<span class="tok-c1">;; include::schiffer/update-self</span>

<span class="tok-c1">;; include::schiffer/clean</span>

<span class="tok-p">(</span><span class="tok-nb">in-package</span> <span class="tok-ss">#:schiffer</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-nb">defun</span> <span class="tok-nv">main</span> <span class="tok-p">(</span><span class="tok-nv">argv</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nb">when</span> <span class="tok-p">(</span><span class="tok-nb">=</span> <span class="tok-mi">1</span> <span class="tok-p">(</span><span class="tok-nb">length</span> <span class="tok-nv">argv</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-nv">show-help</span><span class="tok-p">)</span>
    <span class="tok-p">(</span><span class="tok-nv">uiop:quit</span> <span class="tok-mi">0</span><span class="tok-p">))</span>

  <span class="tok-p">(</span><span class="tok-k">let*</span> <span class="tok-p">((</span><span class="tok-nv">cmd</span> <span class="tok-p">(</span><span class="tok-nb">first</span> <span class="tok-p">(</span><span class="tok-nb">rest</span> <span class="tok-nv">argv</span><span class="tok-p">)))</span>
         <span class="tok-p">(</span><span class="tok-nv">args</span> <span class="tok-p">(</span><span class="tok-nb">rest</span> <span class="tok-p">(</span><span class="tok-nb">rest</span> <span class="tok-nv">argv</span><span class="tok-p">))))</span>
    <span class="tok-p">(</span><span class="tok-nv">alexandria:switch</span> <span class="tok-p">(</span><span class="tok-nv">cmd</span> <span class="tok-ss">:test</span> <span class="tok-nf">#&#39;</span><span class="tok-nb">string=</span><span class="tok-p">)</span>
      <span class="tok-p">(</span><span class="tok-s">&quot;&quot;</span>                <span class="tok-p">(</span><span class="tok-nb">when</span> <span class="tok-p">(</span><span class="tok-nb">string=</span> <span class="tok-s">&quot;--help&quot;</span> <span class="tok-p">(</span><span class="tok-nb">first</span> <span class="tok-nv">args</span><span class="tok-p">))</span> <span class="tok-p">(</span><span class="tok-nv">show-help</span><span class="tok-p">)))</span>
      <span class="tok-p">(</span><span class="tok-s">&quot;help&quot;</span>            <span class="tok-p">(</span><span class="tok-nv">show-help</span><span class="tok-p">))</span>

      <span class="tok-p">(</span><span class="tok-s">&quot;gen-src&quot;</span>         <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">gen-src</span> <span class="tok-nv">args</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-s">&quot;gen-docs&quot;</span>        <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">gen-docs</span> <span class="tok-nv">args</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-s">&quot;gen-all&quot;</span>         <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">gen-all</span> <span class="tok-nv">args</span><span class="tok-p">))</span>

      <span class="tok-p">(</span><span class="tok-s">&quot;build-ulqui&quot;</span>     <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">build-ulqui</span> <span class="tok-nv">args</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-s">&quot;build-schiffer&quot;</span>  <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">build-schiffer</span> <span class="tok-nv">args</span><span class="tok-p">))</span>

      <span class="tok-p">(</span><span class="tok-s">&quot;gen-build-ulqui&quot;</span> <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">gen-build-ulqui</span> <span class="tok-nv">args</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-s">&quot;gen-build-all&quot;</span>   <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">gen-build-all</span> <span class="tok-nv">args</span><span class="tok-p">))</span>

      <span class="tok-p">(</span><span class="tok-s">&quot;update-self&quot;</span>     <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">update-self</span> <span class="tok-nv">args</span><span class="tok-p">))</span>
      <span class="tok-p">(</span><span class="tok-s">&quot;clean&quot;</span>           <span class="tok-p">(</span><span class="tok-nb">apply</span> <span class="tok-nf">#&#39;</span><span class="tok-nv">clean</span> <span class="tok-nv">args</span><span class="tok-p">)))))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_updating_ulquikit">10. Updating Ulquikit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As more versions of Ulquikit are released, having a way to update Ulquikit
from the command line is very helpful.  One way to do this is by adding
update command, so that users could update Ulquikit to latest version just
by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">ulqui update</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_retrieve_latest_version">10.1. Retrieve latest version</h3>
<div class="paragraph">
<p>Ulquikit is officially released via
<a href="https://help.github.com/articles/about-releases">Github Releases</a>, which
provides this URL <a href="https://github.com/cmpitg/ulquikit/releases/latest" class="bare">https://github.com/cmpitg/ulquikit/releases/latest</a> pointing
to latest release.</p>
</div>
<div class="paragraph">
<p>First of all, let&#8217;s curl this URL to see how it&#8217;s redirected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6
7</div></td><td class="code"><span></span>curl --head https://github.com/cmpitg/ulquikit/releases/latest

<span class="tok-c1"># HTTP/1.1 302 Found</span>
<span class="tok-c1"># Server: GitHub.com</span>
<span class="tok-o">[</span>snip<span class="tok-o">]</span>
<span class="tok-c1"># Location: https://github.com/cmpitg/ulquikit/releases/tag/v0.2</span>
<span class="tok-o">[</span>snip<span class="tok-o">]</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>So that&#8217;s how it works, simple and straightforward.  The job now is to get the
"Location" attribute from HTTP header and grab the version.  With Racket&#8217;s
<a href="http://docs.racket-lang.org/net/url.html">net/url</a> library, it becomes trivial:</p>
</div>
<div class="listingblock">
<div class="title">code::ulqui/latest-version</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-k">define</span> <span class="tok-n">+latest-release-url+</span>
  <span class="tok-p">(</span><span class="tok-n">string-&gt;url</span> <span class="tok-s2">&quot;https://github.com/cmpitg/ulquikit/releases/latest&quot;</span><span class="tok-p">))</span>

<span class="tok-p">(</span><span class="tok-k">define</span> <span class="tok-p">(</span><span class="tok-n">get-latest-version</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-n">~&gt;</span> <span class="tok-p">(</span><span class="tok-n">call/input-url</span> <span class="tok-n">+latest-release-url+</span>
                      <span class="tok-n">head-impure-port</span>
                      <span class="tok-nb">port-&gt;string</span><span class="tok-p">)</span>
    <span class="tok-nb">string-split</span>
    <span class="tok-p">(</span><span class="tok-nb">dropf</span> <span class="tok-n">#λ</span><span class="tok-p">(</span><span class="tok-nb">not</span> <span class="tok-p">(</span><span class="tok-nb">string=?</span> <span class="tok-s2">&quot;Location:&quot;</span> <span class="tok-n">%</span><span class="tok-p">)))</span>
    <span class="tok-nb">second</span>
    <span class="tok-p">(</span><span class="tok-n">#λ</span><span class="tok-p">(</span><span class="tok-nb">regexp-match</span> <span class="tok-sr">#rx&quot;v(.*)&quot;</span> <span class="tok-n">%</span><span class="tok-p">))</span>
    <span class="tok-nb">second</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we use
<a href="http://docs.racket-lang.org/net/url.html#%28def" class="bare">http://docs.racket-lang.org/net/url.html#%28def</a>.<em>%28%28lib._net%2Furl..rkt%29._head-impure-port%29%29[head-impure-port]
instead of
<a href="http://docs.racket-lang.org/net/url.html#%28def" class="bare">http://docs.racket-lang.org/net/url.html#%28def</a>.</em>%28%28lib._net%2Furl..rkt%29._head-pure-port%29%29[head-pure-port]
as the response might content body.</p>
</div>
</div>
<div class="sect2">
<h3 id="_download_and_replace_ulquikit">10.2. Download and replace Ulquikit</h3>
<div class="sect3">
<h4 id="_construct_download_url">10.2.1. Construct download URL</h4>
<div class="paragraph">
<p>Let&#8217;s have a closer look: Version 2.0 has
<a href="https://github.com/cmpitg/ulquikit/releases/download/v0.2/ulquikit-v0.2.zip" class="bare">https://github.com/cmpitg/ulquikit/releases/download/v0.2/ulquikit-v0.2.zip</a> as
its download URL.  The filename ulquikit-v0.2.zip certainly depends on
naming convention, which <a href="#schiffer/mark-release">schiffer</a> has got us
covered.  So all download URLs follow the following format:
https://github.com/cmpitg/ulquikit/releases/download/v{latest-version}/ulquikit-v{latest-version}.zip.
Based on that, we have this function to construct download URL of the latest
version:</p>
</div>
<div class="listingblock">
<div class="title">code::ulqui/construct-download-url</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-k">define</span> <span class="tok-p">(</span><span class="tok-n">construct-download-url</span> <span class="tok-p">[</span><span class="tok-nb">version</span> <span class="tok-p">(</span><span class="tok-n">get-latest-version</span><span class="tok-p">)])</span>
  <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-s2">&quot;https://github.com/cmpitg/ulquikit/releases/download/v~a/ulquikit-v~a.zip&quot;</span>
          <span class="tok-nb">version</span>
          <span class="tok-nb">version</span><span class="tok-p">))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_download_and_unzip">10.2.2. Download and unzip</h4>
<div class="paragraph">
<p>There are a couple of ways to download and unzip the release file, among which
the following 2 are the most commonly used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using Racket&#8217;s own API - bad in performance and memory space.</p>
</li>
<li>
<p>Calling shell commands - platform-dependant but much better in performance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s make this work first then improve later.  I&#8217;m going to choose the 2<sup>nd</sup>
option for now.</p>
</div>
<div class="paragraph">
<p>Note that system is used to call external commands, which in turn produce
some data to standard output and standard error.  Thus we make standard output
and standard error unbeffered during to system call to achieve the best
result.</p>
</div>
<div class="listingblock">
<div class="title">code::ulqui/download-and-unzip</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</div></td><td class="code"><span></span><span class="tok-p">(</span><span class="tok-k">define</span> <span class="tok-p">(</span><span class="tok-n">download-and-unzip</span> <span class="tok-nb">version</span> <span class="tok-n">to-dir</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-k">parameterize</span> <span class="tok-p">([</span><span class="tok-nb">current-directory</span> <span class="tok-n">to-dir</span><span class="tok-p">])</span>
    <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">([</span><span class="tok-n">url</span>              <span class="tok-p">(</span><span class="tok-n">construct-download-url</span> <span class="tok-nb">version</span><span class="tok-p">)]</span>
          <span class="tok-p">[</span><span class="tok-n">filename</span>         <span class="tok-p">(</span><span class="tok-nb">format</span> <span class="tok-s2">&quot;ulquikit-v~a.zip&quot;</span> <span class="tok-nb">version</span><span class="tok-p">)]</span>
          <span class="tok-p">[</span><span class="tok-n">out-buffer-mode</span>  <span class="tok-p">(</span><span class="tok-nb">file-stream-buffer-mode</span> <span class="tok-p">(</span><span class="tok-nb">current-output-port</span><span class="tok-p">))]</span>
          <span class="tok-p">[</span><span class="tok-n">err-buffer-mode</span>  <span class="tok-p">(</span><span class="tok-nb">file-stream-buffer-mode</span> <span class="tok-p">(</span><span class="tok-nb">current-error-port</span><span class="tok-p">))])</span>

      <span class="tok-p">(</span><span class="tok-k">with-handlers</span> <span class="tok-p">([</span><span class="tok-nb">exn:fail?</span>
                       <span class="tok-p">(</span><span class="tok-k">λ</span> <span class="tok-p">(</span><span class="tok-k">_</span><span class="tok-p">)</span>
                         <span class="tok-p">(</span><span class="tok-nb">file-stream-buffer-mode</span> <span class="tok-p">(</span><span class="tok-nb">current-output-port</span><span class="tok-p">)</span>
                                                  <span class="tok-n">out-buffer-mode</span><span class="tok-p">)</span>
                         <span class="tok-p">(</span><span class="tok-nb">file-stream-buffer-mode</span> <span class="tok-p">(</span><span class="tok-nb">current-error-port</span><span class="tok-p">)</span>
                                                  <span class="tok-n">err-buffer-mode</span><span class="tok-p">))])</span>
        <span class="tok-p">(</span><span class="tok-nb">file-stream-buffer-mode</span> <span class="tok-p">(</span><span class="tok-nb">current-output-port</span><span class="tok-p">)</span> <span class="tok-o">&#39;</span><span class="tok-ss">none</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nb">file-stream-buffer-mode</span> <span class="tok-p">(</span><span class="tok-nb">current-error-port</span><span class="tok-p">)</span> <span class="tok-o">&#39;</span><span class="tok-ss">none</span><span class="tok-p">)</span>

        <span class="tok-p">(</span><span class="tok-nb">displayln</span> <span class="tok-p">(</span><span class="tok-n">str</span> <span class="tok-s2">&quot;-&gt; Downloading from &quot;</span> <span class="tok-n">url</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nb">system</span> <span class="tok-p">(</span><span class="tok-n">str</span> <span class="tok-s2">&quot;curl -O &quot;</span> <span class="tok-n">url</span><span class="tok-p">))</span>

        <span class="tok-p">(</span><span class="tok-nb">displayln</span> <span class="tok-p">(</span><span class="tok-n">str</span> <span class="tok-s2">&quot;-&gt; Unzipping &quot;</span> <span class="tok-n">filename</span> <span class="tok-s2">&quot;, replacing old version with new version&quot;</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nb">system</span> <span class="tok-p">(</span><span class="tok-n">str</span> <span class="tok-s2">&quot;unzip -o &quot;</span> <span class="tok-n">filename</span><span class="tok-p">))</span>

        <span class="tok-p">(</span><span class="tok-nb">displayln</span> <span class="tok-p">(</span><span class="tok-n">str</span> <span class="tok-s2">&quot;-&gt; Removing &quot;</span> <span class="tok-n">filename</span><span class="tok-p">))</span>
        <span class="tok-p">(</span><span class="tok-nb">delete-directory/files</span> <span class="tok-n">filename</span><span class="tok-p">)</span>

        <span class="tok-p">(</span><span class="tok-nb">file-stream-buffer-mode</span> <span class="tok-p">(</span><span class="tok-nb">current-output-port</span><span class="tok-p">)</span> <span class="tok-n">out-buffer-mode</span><span class="tok-p">)</span>
        <span class="tok-p">(</span><span class="tok-nb">file-stream-buffer-mode</span> <span class="tok-p">(</span><span class="tok-nb">current-error-port</span><span class="tok-p">)</span> <span class="tok-n">err-buffer-mode</span><span class="tok-p">)))))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_update_command">10.3. The update command</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="racket"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</div></td><td class="code"><span></span><span class="tok-c1">;; include::license-header</span>

<span class="tok-c1">;; include::use-rackjure</span>

<span class="tok-p">(</span><span class="tok-k">require</span> <span class="tok-n">net/url</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-k">require</span> <span class="tok-s2">&quot;../ulquikit.rkt&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-k">require</span> <span class="tok-s2">&quot;../command-core.rkt&quot;</span><span class="tok-p">)</span>
<span class="tok-p">(</span><span class="tok-k">require</span> <span class="tok-s2">&quot;../utils/path.rkt&quot;</span><span class="tok-p">)</span>

<span class="tok-p">(</span><span class="tok-k">provide</span> <span class="tok-n">run</span><span class="tok-p">)</span>

<span class="tok-c1">;; include::ulqui/latest-version</span>

<span class="tok-c1">;; include::ulqui/construct-download-url</span>

<span class="tok-c1">;; include::ulqui/download-and-unzip</span>

<span class="tok-p">(</span><span class="tok-k">define</span> <span class="tok-p">(</span><span class="tok-n">run</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-n">display-cmd</span> <span class="tok-s2">&quot;Updating Ulquikit&quot;</span><span class="tok-p">)</span>
  <span class="tok-p">(</span><span class="tok-nb">displayln</span> <span class="tok-p">(</span><span class="tok-n">str</span> <span class="tok-s2">&quot;-&gt; Current version: &quot;</span> <span class="tok-n">+ulquikit-version+</span><span class="tok-p">))</span>
  <span class="tok-p">(</span><span class="tok-k">let</span> <span class="tok-p">([</span><span class="tok-n">latest-version</span> <span class="tok-p">(</span><span class="tok-n">get-latest-version</span><span class="tok-p">)])</span>
    <span class="tok-p">(</span><span class="tok-nb">displayln</span> <span class="tok-p">(</span><span class="tok-n">str</span> <span class="tok-s2">&quot;   Latest version:  &quot;</span> <span class="tok-n">latest-version</span><span class="tok-p">))</span>
    <span class="tok-p">(</span><span class="tok-k">cond</span> <span class="tok-p">[(</span><span class="tok-nb">string=?</span> <span class="tok-n">latest-version</span> <span class="tok-n">+ulquikit-version+</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-nb">newline</span><span class="tok-p">)</span>
           <span class="tok-p">(</span><span class="tok-nb">displayln</span> <span class="tok-p">(</span><span class="tok-n">str</span> <span class="tok-s2">&quot;   Congratulations! You are running the latest version of Ulquikit!&quot;</span><span class="tok-p">))]</span>
          <span class="tok-p">[</span><span class="tok-k">else</span>
           <span class="tok-p">(</span><span class="tok-n">download-and-unzip</span> <span class="tok-n">latest-version</span> <span class="tok-n">+ulquikit-location+</span><span class="tok-p">)])))</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_quick_installation_script">10.4. Quick installation script</h3>
<div class="paragraph">
<p>This comes in handy at times.  The script assumes that <strong>users have already
installed Racket and Ruby</strong>.</p>
</div>
<div class="paragraph">
<p>The user-friendliness provided by the script is the most important, so let&#8217;s
decide upon how it looks like:</p>
</div>
<div class="listingblock">
<div class="title">file::bin/quick-install.sh</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</div></td><td class="code"><span></span><span class="tok-ch">#!/bin/sh</span>

<span class="tok-c1">## include::quick-install/racket</span>

<span class="tok-c1">## include::quick-install/ruby</span>

<span class="tok-c1">## include::quick-install/asciidoctor</span>

<span class="tok-c1">## include::quick-install/rackjure</span>

<span class="tok-c1">## include::quick-install/ulquikit</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Bourne shell is a horrible language, so even a simple check-and-make-decision
might end up look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3</div></td><td class="code"><span></span><span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-sb">`</span>which some-exec &gt;/dev/null <span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nb">echo</span> <span class="tok-nb">true</span> <span class="tok-o">||</span> <span class="tok-nb">echo</span> <span class="tok-nb">false</span><span class="tok-sb">`</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;true&quot;</span> <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
   <span class="tok-c1"># Do-something</span>
<span class="tok-k">fi</span>
</td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, each part of this quick-install.sh script requires that kind
of check.  Let&#8217;s walk through them one by one.</p>
</div>
<div class="sect3">
<h4 id="_make_sure_racket_is_installed">10.4.1. Make sure Racket is installed</h4>
<div class="paragraph">
<p>This task is simple done by checking whether racket executable is found.
Note that it doesn&#8217;t check Racket version.  The script fails if Racket is not
installed, thus the exit 1 command.</p>
</div>
<div class="listingblock">
<div class="title">code::quick-install/racket</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</div></td><td class="code"><span></span><span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-sb">`</span>which racket &gt;/dev/null <span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nb">echo</span> t <span class="tok-o">||</span> <span class="tok-nb">echo</span> f<span class="tok-sb">`</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;f&quot;</span> <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Racket not found, please install it first.&quot;</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;   You might refer to your OS&#39;s package manager to install Racket,&quot;</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;   or download it from: http://racket-lang.org/download/&quot;</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;   Please MAKE SURE you have Racket 6+.&quot;</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Installation aborted.&quot;</span>
    <span class="tok-nb">exit</span> <span class="tok-m">1</span>
<span class="tok-k">else</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Found Racket.  MAKE SURE you have Racket 6+.&quot;</span>
<span class="tok-k">fi</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_ruby_1_9_using_rvm_if_necessary">10.4.2. Install Ruby 1.9 (using RVM) if necessary</h4>
<div class="listingblock">
<div class="title">code::quick-install/ruby</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</div></td><td class="code"><span></span><span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-sb">`</span>which ruby &gt;/dev/null <span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nb">echo</span> t <span class="tok-o">||</span> <span class="tok-nb">echo</span> f<span class="tok-sb">`</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;f&quot;</span> <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Ruby not found.&quot;</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;   You might refer to your OS&#39;s package manager to install Ruby.&quot;</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;   However, this script could install Ruby for you using RVM stable.&quot;</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;   Please refer to http://rvm.io for further information.&quot;</span>

    <span class="tok-nb">echo</span> -n <span class="tok-s2">&quot;-&gt; Would you like to install RVM stable single-user mode? [Y/n] &quot;</span>
    <span class="tok-nb">read</span> DO_INSTALL_RVM

    <span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$DO_INSTALL_RVM</span><span class="tok-s2">&quot;</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;&quot;</span> <span class="tok-o">]</span> <span class="tok-se">\</span>
        <span class="tok-o">||</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$DO_INSTALL_RVM</span><span class="tok-s2">&quot;</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;y&quot;</span> <span class="tok-o">]</span> <span class="tok-se">\</span>
        <span class="tok-o">||</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$DO_INSTALL_RVM</span><span class="tok-s2">&quot;</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;Y&quot;</span> <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
        <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Installing Ruby 1.9 and RVM...&quot;</span>

        <span class="tok-se">\c</span>url -sSL https://get.rvm.io <span class="tok-p">|</span> bash -s stable
        <span class="tok-o">[[</span> -f ~/.bashrc <span class="tok-o">]]</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-o">(</span><span class="tok-nb">echo</span> <span class="tok-s1">&#39;source $HOME/.rvm/scripts/rvm&#39;</span> &gt;&gt; ~/.bashrc<span class="tok-o">)</span>
        <span class="tok-o">[[</span> -f ~/.zshrc  <span class="tok-o">]]</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-o">(</span><span class="tok-nb">echo</span> <span class="tok-s1">&#39;source $HOME/.rvm/scripts/rvm&#39;</span> &gt;&gt; ~/.zshrc<span class="tok-o">)</span>
        <span class="tok-nb">source</span> <span class="tok-nv">$HOME</span>/.rvm/scripts/rvm
        rvm install <span class="tok-m">1</span>.9
        rvm use <span class="tok-m">1</span>.9 --default
    <span class="tok-k">else</span>
        <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Installation aborted.&quot;</span>
        <span class="tok-nb">exit</span> <span class="tok-m">1</span>
    <span class="tok-k">fi</span>
<span class="tok-k">else</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Found Ruby.  MAKE SURE you have Ruby 1.9+.&quot;</span>
<span class="tok-k">fi</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_asciidoctor_if_necessary">10.4.3. Install AsciiDoctor if necessary</h4>
<div class="listingblock">
<div class="title">code::quick-install/asciidoctor</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6</div></td><td class="code"><span></span><span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-sb">`</span>which asciidoctor &gt;/dev/null <span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nb">echo</span> t <span class="tok-o">||</span> <span class="tok-nb">echo</span> f<span class="tok-sb">`</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;t&quot;</span> <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; AsciiDoctor found.&quot;</span>
<span class="tok-k">else</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Installing AsciiDoctor...&quot;</span>
    gem install -V asciidoctor
<span class="tok-k">fi</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_rackjure_if_necessary">10.4.4. Install Rackjure if necessary</h4>
<div class="listingblock">
<div class="title">code::quick-install/rackjure</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv">1
2
3
4
5
6</div></td><td class="code"><span></span><span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-sb">`</span><span class="tok-o">(</span>raco pkg show <span class="tok-p">|</span> grep rackjure<span class="tok-o">)</span> &gt;/dev/null <span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nb">echo</span> t <span class="tok-o">||</span> <span class="tok-nb">echo</span> f<span class="tok-sb">`</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;t&quot;</span> <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Rackjure found.&quot;</span>
<span class="tok-k">else</span>
    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Installing Rackjure...&quot;</span>
    raco pkg install rackjure
<span class="tok-k">fi</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_ulquikit">10.4.5. Install Ulquikit</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
DOWNLOAD_URL needs to change everytime there&#8217;s new release.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">code::quick-install/ulquikit</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><table class="pyhltable"><tr><td class="linenos"><div class="linenodiv"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</div></td><td class="code"><span></span><span class="tok-nv">DOWNLOAD_URL</span><span class="tok-o">=</span>https://github.com/cmpitg/ulquikit/releases/download/v0.2.1/ulquikit-v0.2.1.zip

<span class="tok-nb">echo</span> -n <span class="tok-s2">&quot;-&gt; Where would you like to install/update Ulquikit? (default: </span><span class="tok-nv">$HOME</span><span class="tok-s2">/) &quot;</span>
<span class="tok-nb">read</span> ULQUIKIT_DEST
<span class="tok-nb">eval</span> <span class="tok-nv">ULQUIKIT_DEST</span><span class="tok-o">=</span><span class="tok-nv">$ULQUIKIT_DEST</span>

<span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$ULQUIKIT_DEST</span><span class="tok-s2">&quot;</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;&quot;</span> <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
    <span class="tok-nv">ULQUIKIT_DEST</span><span class="tok-o">=</span><span class="tok-nv">$HOME</span>/
<span class="tok-k">fi</span>

<span class="tok-nb">cd</span> <span class="tok-nv">$ULQUIKIT_DEST</span>

<span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Downloading latest version...&quot;</span>
wget -q <span class="tok-s2">&quot;</span><span class="tok-nv">$DOWNLOAD_URL</span><span class="tok-s2">&quot;</span> -O ulquikit.zip

<span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Unpacking...&quot;</span>
unzip ulquikit.zip

<span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Removing zip file...&quot;</span>
rm -f ulquikit.zip

<span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-sb">`</span>which ulqui &gt;/dev/null <span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-nb">echo</span> t <span class="tok-o">||</span> <span class="tok-nb">echo</span> f<span class="tok-sb">`</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;f&quot;</span> <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
    <span class="tok-nb">echo</span> <span class="tok-s1">&#39;-&gt; Adding ulquikit/bin to your $PATH&#39;</span>
    <span class="tok-o">[[</span> -f ~/.bashrc <span class="tok-o">]]</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-o">(</span><span class="tok-nb">echo</span> <span class="tok-nb">export</span> <span class="tok-nv">PATH</span><span class="tok-o">=</span><span class="tok-nv">$ULQUI_DEST</span>/ulquikit/bin:<span class="tok-s1">&#39;$PATH&#39;</span> &gt;&gt; ~/.bashrc<span class="tok-o">)</span>
    <span class="tok-o">[[</span> -f ~/.zshrc <span class="tok-o">]]</span> <span class="tok-o">&amp;&amp;</span> <span class="tok-o">(</span><span class="tok-nb">echo</span> <span class="tok-nb">export</span> <span class="tok-nv">PATH</span><span class="tok-o">=</span><span class="tok-nv">$ULQUI_DEST</span>/ulquikit/bin:<span class="tok-s1">&#39;$PATH&#39;</span> &gt;&gt; ~/.zshrc<span class="tok-o">)</span>

    <span class="tok-nb">echo</span> <span class="tok-s2">&quot;-&gt; Done!  Enjoy your time with literate programming!&quot;</span>
<span class="tok-k">else</span>
    <span class="tok-nb">echo</span> <span class="tok-s1">&#39;-&gt; Found ulqui command in your $PATH.&#39;</span>
<span class="tok-k">fi</span>

<span class="tok-nb">export</span> <span class="tok-nv">PATH</span><span class="tok-o">=</span><span class="tok-nv">$ULQUI_DEST</span>/ulquikit/bin:<span class="tok-nv">$PATH</span>
</td></tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_license_header">11. License header</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since Ulquikit is distributed under the terms of GPLv3, the license header is
necessary.</p>
</div>
<div class="listingblock">
<div class="title">code::license-header</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lisp"><span class="tok-c1">;;</span>
<span class="tok-c1">;; This file is part of Ulquikit project.</span>
<span class="tok-c1">;;</span>
<span class="tok-c1">;; Copyright (C) 2014-2017 Ha-Duong Nguyen &lt;cmpitg AT gmailDOTcom&gt;</span>
<span class="tok-c1">;;</span>
<span class="tok-c1">;; Ulquikit is free software: you can redistribute it and/or modify it under</span>
<span class="tok-c1">;; the terms of the GNU General Public License as published by the Free</span>
<span class="tok-c1">;; Software Foundation, either version 3 of the License, or (at your option)</span>
<span class="tok-c1">;; any later version.</span>
<span class="tok-c1">;;</span>
<span class="tok-c1">;; Ulquikit is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="tok-c1">;; WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="tok-c1">;; FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more</span>
<span class="tok-c1">;; details.</span>
<span class="tok-c1">;;</span>
<span class="tok-c1">;; You should have received a copy of the GNU General Public License along</span>
<span class="tok-c1">;; with Ulquikit.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="tok-c1">;;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extras">12. Extras</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_command_list">12.1. Command list</h3>

</div>
<div class="sect2">
<h3 id="_story_how_the_racket_version_of_ulquikit_was_actually_developed">12.2. Story: How the Racket version of Ulquikit was actually developed</h3>

</div>
<div class="sect2">
<h3 id="_enhancing_narrow_region_functionality_in_emacs">12.3. Enhancing narrow-region functionality in Emacs</h3>

</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-01-16 17:51:37 EET
</div>
</div>
</body>
</html>